<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Powered GST Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai/dist/index.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: '#4F46E5', // Indigo 600
                hover: '#4338CA', // Indigo 700
                light: '#EEF2FF', // Indigo 50
                dark: '#312E81',  // Indigo 900
              },
              secondary: {
                DEFAULT: '#64748B', // Slate 500
                hover: '#475569', // Slate 600
              },
              success: '#10B981', // Emerald 500
              warning: '#F59E0B', // Amber 500
              danger: {
                DEFAULT: '#EF4444', // Red 500
                hover: '#DC2626', // Red 600
              }
            },
          },
        },
      }
    </script>
    <style>
      /* Global styles can go here. Print-specific styles are now handled by the controlledPrint function. */
    </style>
  </head>
  <body class="bg-indigo-50 antialiased">
    <div id="root"></div>
    <script type="module">
      const { useState, useEffect, useCallback, useMemo, useRef, StrictMode, Fragment } = React;
      const e = React.createElement;

      // --- From constants.ts ---
      const DB_NAME = "GSTDashboardDB_React";
      const STORE_TRANSACTIONS = "transactions";
      const STORE_ACTIONS = "actions";
      const STORE_ASSIGNMENTS = "assignments";
      const STORE_VALIDATION_BOOKS = "validation_books";
      const DB_VERSION = 2;
      const MAILING_LIST_CATEGORIES = [
        "Admin", "HR", "EA", "IT", "KS", "DC", "Investment", 
        "Manikant", "Neha", "Suresh", "Ashok"
      ];
      const MONTH_MAP = {
        Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
        Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12
      };
      const ACTION_OPTIONS = [
        'None', 'Accounted', 'Not Accounted', 'Invoice Not Received',
        'Follow up', 'Followed up', 'No Response', 'Invoice Received'
      ];

      // --- From utils/helpers.ts ---
      const formatCurrency = function(n, isShort = true) {
        if (typeof n !== 'number' || isNaN(n)) return isShort ? 'Rs. 0 K' : '0.00';
        if (!isShort) {
          return n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        if (Math.abs(n) >= 1e7) return `Rs. ${(n / 1e7).toFixed(2)} Cr`;
        if (Math.abs(n) >= 1e5) return `Rs. ${(n / 1e5).toFixed(2)} Lk`;
        if (Math.abs(n) >= 1e3) return `Rs. ${(n / 1e3).toFixed(2)} K`;
        return `Rs. ${n.toFixed(2)}`;
      };
      const formatPercent = function(n) {
        if (typeof n !== 'number' || isNaN(n)) return '0.0 %';
        return `${n.toFixed(1)} %`;
      };
      const parseDateString = function(ds) {
        if (!ds) return null;
        if (typeof ds === 'number') {
          const excelEpoch = new Date(Date.UTC(1899, 11, 30));
          const dateObj = new Date(excelEpoch.getTime() + ds * 86400000);
          return !isNaN(dateObj.getTime()) ? dateObj : null;
        }
        if (typeof ds !== 'string') return null;
        const parts = ds.match(/(\d{1,2})[/-](\d{1,2})[/-](\d{4})/);
        if (parts) {
          const day = parseInt(parts[1], 10);
          const month = parseInt(parts[2], 10) - 1;
          const year = parseInt(parts[3], 10);
          const date = new Date(year, month, day);
          if (!isNaN(date.getTime()) && date.getDate() === day) return date;
        }
        const nativeDate = new Date(ds);
        return !isNaN(nativeDate.getTime()) ? nativeDate : null;
      };
      const getFinancialYear = function(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        return month >= 3 ? `${year}-${String(year + 1).slice(-2)}` : `${year - 1}-${String(year).slice(-2)}`;
      };
      const getMonthNumber = function(monthName) {
          if (typeof monthName !== 'string') return 0;
          const namePart = monthName.substring(0, 3);
          return MONTH_MAP[namePart] || 0;
      };
      function exportToCsv(data, filename) {
          if (!data || data.length === 0) {
              alert("No data to export.");
              return;
          }
          const headers = Object.keys(data[0]);
          const csvRows = [headers.join(',')];
          for (const row of data) {
              const values = headers.map(function(header) {
                  const escaped = ('' + (row[header] === null || row[header] === undefined ? '' : row[header])).replace(/"/g, '""');
                  return `"${escaped}"`;
              });
              csvRows.push(values.join(','));
          }
          const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.setAttribute('hidden', '');
          a.setAttribute('href', url);
          a.setAttribute('download', `${filename}_${new Date().toISOString().slice(0,10)}.csv`);
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
      }
      function controlledPrint(elementId, title) {
          const printContent = document.getElementById(elementId)?.outerHTML;
          if (!printContent) {
              console.error(`Element with ID "${elementId}" not found for printing.`);
              alert("Could not find content to print.");
              return;
          }
          const today = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
          const printWindow = window.open('', '', 'height=600,width=800');
          
          printWindow.document.write('<html><head><title>' + title + '</title>');
          
          printWindow.document.write('<style>');
          printWindow.document.write(`
              body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; font-size: 9pt; color: #333; }
              .print-container { padding: 20px; }
              h3 { font-size: 16pt; margin-bottom: 5px; border-bottom: 2px solid #4F46E5; padding-bottom: 5px; color: #312E81; }
              p { font-size: 10pt; color: #666; margin-top: 0; }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; page-break-inside: auto; }
              thead { display: table-header-group; }
              tbody { display: table-row-group; }
              tr { page-break-inside: avoid; page-break-after: auto; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; }
              th { background-color: #EEF2FF !important; font-weight: 600; color: #312E81; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
              tbody tr:nth-child(even) { background-color: #f9fafb !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
              .text-right { text-align: right; }
              @page { size: A4 landscape; margin: 1cm; }
          `);
          printWindow.document.write('</style></head><body>');
          
          printWindow.document.write('<div class="print-container">');
          printWindow.document.write(`
              <div style="text-align: center; margin-bottom: 20px;">
                  <h3>${title}</h3>
                  <p>Generated on: ${today}</p>
              </div>
          `);
          
          printWindow.document.write(printContent);
          
          printWindow.document.write('</div></body></html>');
          printWindow.document.close();
          
          printWindow.onload = function() {
              printWindow.focus();
              printWindow.print();
          }
      }

      // --- From services/cryptoService.ts ---
      const cryptoService = (function() {
          let sessionKey = null;
          const KEY_STORAGE_ID = 'gstDashboardCryptoKey';

          const getKey = async function() {
              if (sessionKey) return sessionKey;

              const storedKey = sessionStorage.getItem(KEY_STORAGE_ID);
              if (storedKey) {
                  try {
                      const jwk = JSON.parse(storedKey);
                      sessionKey = await window.crypto.subtle.importKey(
                          "jwk",
                          jwk,
                          { name: "AES-GCM" },
                          true, // allow exporting
                          ["encrypt", "decrypt"]
                      );
                      return sessionKey;
                  } catch (e) {
                      console.error("Failed to import stored key, will generate a new one.", e);
                      sessionStorage.removeItem(KEY_STORAGE_ID);
                  }
              }

              const newKey = await window.crypto.subtle.generateKey(
                  { name: "AES-GCM", length: 256 },
                  true, // make it exportable
                  ["encrypt", "decrypt"]
              );

              const jwk = await window.crypto.subtle.exportKey("jwk", newKey);
              sessionStorage.setItem(KEY_STORAGE_ID, JSON.stringify(jwk));
              sessionKey = newKey;
              return newKey;
          };
          
          const arrayBufferToBase64 = function(buffer) {
              let binary = '';
              const bytes = new Uint8Array(buffer);
              const len = bytes.byteLength;
              for (let i = 0; i < len; i++) {
                  binary += String.fromCharCode(bytes[i]);
              }
              return window.btoa(binary);
          };

          const base64ToArrayBuffer = function(base64) {
              const binary_string = window.atob(base64);
              const len = binary_string.length;
              const bytes = new Uint8Array(len);
              for (let i = 0; i < len; i++) {
                  bytes[i] = binary_string.charCodeAt(i);
              }
              return bytes.buffer;
          };

          return {
              encrypt: async function(data) {
                  if (data === null || data === undefined) return null;
                  try {
                      const key = await getKey();
                      const iv = window.crypto.getRandomValues(new Uint8Array(12));
                      const jsonString = JSON.stringify(data);
                      const encodedData = new TextEncoder().encode(jsonString);

                      const encryptedContent = await window.crypto.subtle.encrypt(
                          { name: "AES-GCM", iv: iv },
                          key,
                          encodedData
                      );
                      
                      const combinedBuffer = new Uint8Array(iv.length + encryptedContent.byteLength);
                      combinedBuffer.set(iv, 0);
                      combinedBuffer.set(new Uint8Array(encryptedContent), iv.length);

                      return arrayBufferToBase64(combinedBuffer.buffer);
                  } catch (error) {
                      console.error("Encryption failed:", error);
                      throw new Error("Could not encrypt data.");
                  }
              },
              decrypt: async function(encryptedBase64) {
                  if (encryptedBase64 === null || encryptedBase64 === undefined) return null;
                  try {
                      const key = await getKey();
                      const combinedBuffer = base64ToArrayBuffer(encryptedBase64);
                      
                      const iv = combinedBuffer.slice(0, 12);
                      const encryptedContent = combinedBuffer.slice(12);
                      
                      const decryptedContent = await window.crypto.subtle.decrypt(
                          { name: "AES-GCM", iv: iv },
                          key,
                          encryptedContent
                      );

                      const decodedData = new TextDecoder().decode(decryptedContent);
                      return JSON.parse(decodedData);
                  } catch (error) {
                      console.error("Decryption failed:", error);
                      throw new Error("Could not decrypt data. Session key might be invalid or data is corrupt.");
                  }
              }
          };
      })();

      // --- From services/dbService.ts ---
      const dbService = (function() {
          let db;
          const openDB = function() {
            return new Promise(function(resolve, reject) {
              if (db) return resolve(db);
              const request = indexedDB.open(DB_NAME, DB_VERSION);
              request.onupgradeneeded = function(event) {
                const dbHandle = event.target.result;
                if (!dbHandle.objectStoreNames.contains(STORE_TRANSACTIONS)) {
                  dbHandle.createObjectStore(STORE_TRANSACTIONS, { keyPath: 'id' });
                }
                if (!dbHandle.objectStoreNames.contains(STORE_ACTIONS)) {
                  dbHandle.createObjectStore(STORE_ACTIONS, { keyPath: 'id' });
                }
                if (!dbHandle.objectStoreNames.contains(STORE_ASSIGNMENTS)) {
                  dbHandle.createObjectStore(STORE_ASSIGNMENTS, { keyPath: 'key' });
                }
                if (!dbHandle.objectStoreNames.contains(STORE_VALIDATION_BOOKS)) {
                  dbHandle.createObjectStore(STORE_VALIDATION_BOOKS, { keyPath: 'companyName' });
                }
              };
              request.onsuccess = function(event) {
                db = event.target.result;
                resolve(db);
              };
              request.onerror = function(event) {
                console.error("IndexedDB error:", event.target.error);
                reject(event.target.error);
              };
            });
          };
          const getStore = function(storeName, mode) {
            const transaction = db.transaction(storeName, mode);
            return transaction.objectStore(storeName);
          };
          return {
              saveData: async function(transactions, actions, assignments) {
                await openDB();
                const tx = db.transaction([STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS], 'readwrite');
                const txStore = tx.objectStore(STORE_TRANSACTIONS);
                const actStore = tx.objectStore(STORE_ACTIONS);
                const assStore = tx.objectStore(STORE_ASSIGNMENTS);

                const [encryptedTxs, encryptedActs, encryptedAss] = await Promise.all([
                    cryptoService.encrypt(transactions),
                    cryptoService.encrypt(actions),
                    cryptoService.encrypt(assignments)
                ]);

                txStore.clear();
                actStore.clear();
                assStore.clear();
                
                if (encryptedTxs) txStore.put({ id: 'encrypted_data', data: encryptedTxs });
                if (encryptedActs) actStore.put({ id: 'encrypted_actions', data: encryptedActs });
                if (encryptedAss) assStore.put({ key: 'encrypted_assignments', data: encryptedAss });

                return new Promise(function(resolve, reject) {
                  tx.oncomplete = function() { resolve() };
                  tx.onerror = function() { reject(tx.error) };
                });
              },
              loadData: async function() {
                await openDB();
                const tx = db.transaction([STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS], 'readonly');
                const txStore = tx.objectStore(STORE_TRANSACTIONS);
                const actStore = tx.objectStore(STORE_ACTIONS);
                const assStore = tx.objectStore(STORE_ASSIGNMENTS);

                const txRequest = txStore.get('encrypted_data');
                const actRequest = actStore.get('encrypted_actions');
                const assRequest = assStore.get('encrypted_assignments');

                return new Promise(function(resolve, reject) {
                  tx.oncomplete = async function() {
                      try {
                          const encryptedTxs = txRequest.result?.data;
                          const encryptedActs = actRequest.result?.data;
                          const encryptedAss = assRequest.result?.data;
                          
                          const [transactions, actions, assignments] = await Promise.all([
                              encryptedTxs ? cryptoService.decrypt(encryptedTxs) : Promise.resolve([]),
                              encryptedActs ? cryptoService.decrypt(encryptedActs) : Promise.resolve({}),
                              encryptedAss ? cryptoService.decrypt(encryptedAss) : Promise.resolve({})
                          ]);

                          resolve({ transactions, actions, assignments });
                      } catch(e) {
                          console.error("Failed to load and decrypt data. A new session may require a file upload.", e);
                          resolve({ transactions: [], actions: {}, assignments: {} });
                      }
                  };
                  tx.onerror = function() { reject(tx.error) };
                });
              },
              saveValidationBook: async function(book) {
                  await openDB();
                  const encryptedData = await cryptoService.encrypt(book.data);
                  getStore(STORE_VALIDATION_BOOKS, 'readwrite').put({ companyName: book.companyName, data: encryptedData });
              },
              loadAllValidationBooks: async function() {
                  await openDB();
                  const request = getStore(STORE_VALIDATION_BOOKS, 'readonly').getAll();
                  return new Promise(function(resolve, reject) {
                      request.onsuccess = async function() {
                          try {
                              const encryptedRecords = request.result;
                              if (!encryptedRecords || encryptedRecords.length === 0) {
                                  return resolve([]);
                              }
                              const decryptedBooks = await Promise.all(
                                  encryptedRecords.map(async function(record) {
                                      const decryptedData = await cryptoService.decrypt(record.data);
                                      return { companyName: record.companyName, data: decryptedData };
                                  })
                              );
                              resolve(decryptedBooks);
                          } catch (e) {
                              console.error("Failed to decrypt validation books", e);
                              resolve([]);
                          }
                      };
                      request.onerror = function() { reject(request.error) };
                  });
              },
              clearAllData: async function() {
                await openDB();
                const tx = db.transaction([STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS, STORE_VALIDATION_BOOKS], 'readwrite');
                tx.objectStore(STORE_TRANSACTIONS).clear();
                tx.objectStore(STORE_ACTIONS).clear();
                tx.objectStore(STORE_ASSIGNMENTS).clear();
                tx.objectStore(STORE_VALIDATION_BOOKS).clear();
              }
          };
      })();

      // --- From services/fileProcessor.ts ---
      const fileProcessor = (function() {
          const parseCurrency = function(v) {
            if (typeof v === 'number') return v;
            if (typeof v !== 'string') return 0;
            const c = v.replace(/[^0-9.-]+/g, "");
            const n = parseFloat(c);
            return isNaN(n) ? 0 : n;
          };
          return {
              processMainFile: function(file, onProgress) {
                return new Promise(function(resolve, reject) {
                  const reader = new FileReader();
                  reader.onload = async function(e) {
                    try {
                      if (!e.target?.result) return reject(new Error("File content is empty."));
                      
                      onProgress(0.1, 'Reading file contents...');
                      await new Promise(function(res) { return setTimeout(res, 0) });
                      const data = new Uint8Array(e.target.result);
                      
                      onProgress(0.2, 'Parsing Excel workbook...');
                      await new Promise(function(res) { return setTimeout(res, 0) });
                      const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                      
                      const sheetName = 'Transactions';
                      if (!workbook.SheetNames.includes(sheetName)) {
                        return reject(new Error(`Sheet "${sheetName}" not found in the Excel file.`));
                      }
                      const worksheet = workbook.Sheets[sheetName];
                      
                      onProgress(0.4, 'Converting sheet to JSON...');
                      await new Promise(function(res) { return setTimeout(res, 0) });
                      const rawData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
                      
                      if (!Array.isArray(rawData) || rawData.length === 0) {
                        return reject(new Error("No data found in the 'Transactions' sheet."));
                      }
                      
                      const processedData = [];
                      const totalRows = rawData.length;
                      const chunkSize = 200;

                      for (let i = 0; i < totalRows; i += chunkSize) {
                        const chunk = rawData.slice(i, i + chunkSize);
                        chunk.forEach(function(row, index) {
                            if (typeof row !== 'object' || row === null) return null;
                            const newRow = { id: `row_${i + index}` };
                            Object.keys(row).forEach(function(key) {
                                if (key && !key.startsWith('__EMPTY')) {
                                    newRow[key.trim()] = typeof row[key] === 'string' ? row[key].trim() : row[key];
                                }
                            });
                            newRow['Type'] = String(newRow['Type'] ?? newRow['Tag (Type)'] ?? "");
                            newRow['Sum of Taxable Value (2B)'] = parseCurrency(newRow['Sum of Taxable Value (2B)']);
                            newRow['Sum of IGST (2B)'] = parseCurrency(newRow['Sum of IGST (2B)']);
                            newRow['Sum of CGST (2B)'] = parseCurrency(newRow['Sum of CGST (2B)']);
                            newRow['Sum of SGST (2B)'] = parseCurrency(newRow['Sum of SGST (2B)']);
                            newRow['Total GST'] = (newRow['Sum of IGST (2B)'] ?? 0) + (newRow['Sum of CGST (2B)'] ?? 0) + (newRow['Sum of SGST (2B)'] ?? 0);
                            const docDateObj = parseDateString(newRow['Document Date (2B)']);
                            if (docDateObj) {
                                newRow['Document Date (2B)'] = docDateObj.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
                                newRow['Financial Year'] = getFinancialYear(docDateObj);
                            } else {
                                newRow['Document Date (2B)'] = '';
                                newRow['Financial Year'] = 'Unknown';
                            }
                            newRow['Remarks'] = String(newRow['Remarks'] ?? '');
                            newRow['Supplier Name'] = String(newRow['Supplier Name'] ?? 'Unknown');
                            newRow['Document Number (2B)'] = String(newRow['Document Number (2B)'] ?? '');
                            newRow['Company Name'] = String(newRow['Company Name'] ?? 'Unknown');
                            newRow['Month'] = String(newRow['Month'] ?? 'Unknown');
                            processedData.push(newRow);
                        });

                        const progress = (i + chunkSize) / totalRows;
                        onProgress(0.5 + progress * 0.5, `Processing rows... ${Math.min(i + chunkSize, totalRows)} / ${totalRows}`);
                        await new Promise(function(res) { return setTimeout(res, 0) });
                      }
                      
                      resolve(processedData.filter(function(r) { return r !== null }));
                    } catch (error) {
                      reject(error);
                    }
                  };
                  reader.onerror = function(error) { reject(error) };
                  reader.readAsArrayBuffer(file);
                });
              },
              processBooksFile: function(file) {
                  return new Promise(function(resolve, reject) {
                      const companyNameMatch = file.name.match(/Books_([^_]+)\.xlsx?/i);
                      if (!companyNameMatch || !companyNameMatch[1]) {
                          return reject(new Error("Books filename must be in the format 'Books_CompanyName.xlsx'"));
                      }
                      const companyName = companyNameMatch[1].replace(/_/g, ' ');
                      const reader = new FileReader();
                      reader.onload = function(e) {
                          try {
                              if (!e.target?.result) return reject(new Error("File content is empty."));
                              const data = new Uint8Array(e.target.result);
                              const workbook = XLSX.read(data, { type: 'array' });
                              const sheetName = workbook.SheetNames[0];
                              if (!sheetName) return reject(new Error("No sheets found in Books file."));
                              const worksheet = workbook.Sheets[sheetName];
                              const rawData = XLSX.utils.sheet_to_json(worksheet, {raw: false, defval: null});
                              if (!Array.isArray(rawData) || rawData.length === 0) {
                                  return reject(new Error(`No data found in '${sheetName}' sheet.`));
                              }
                              resolve({ companyName, data: rawData });
                          } catch (error) {
                              reject(error);
                          }
                      };
                      reader.onerror = function(error) { reject(error) };
                      reader.readAsArrayBuffer(file);
                  });
              }
          };
      })();

      // --- From services/geminiService.ts ---
      const geminiService = (function() {
          let ai;
          try {
              if (typeof process !== 'undefined' && process.env && process.env.API_KEY && window.genai) {
                  ai = new window.genai.GoogleGenAI({ apiKey: process.env.API_KEY });
              }
          } catch (e) {
              console.error("Gemini AI could not be initialized. API_KEY might be missing.", e);
          }

          const getFilterFromQueryOffline = async function(query, options) {
              const lowerQuery = query.toLowerCase();
              const response = { action: 'unknown' };
              response.action = 'filter';
              const foundFilters = [];
              if (options.companies) {
                  options.companies.forEach(function(c) {
                      if (lowerQuery.includes(c.toLowerCase())) {
                          response.company = [c];
                          foundFilters.push(c);
                      }
                  });
              }
              if (options.months) {
                  options.months.forEach(function(m) {
                      if (lowerQuery.includes(m.toLowerCase())) {
                          response.month = [m];
                          foundFilters.push(m);
                      }
                  });
              }
              if(options.tags) {
                options.tags.forEach(function(t) {
                    if (lowerQuery.includes(t.replace(/_/g, ' ').toLowerCase())) {
                        response.tag = [t];
                        foundFilters.push(t);
                    }
                });
              }
              if (foundFilters.length > 0) {
                  response.matchedText = foundFilters.join(', ');
              } else {
                  response.action = 'unknown';
                  response.matchedText = "Sorry, I couldn't find any matching filters for that.";
              }
              return response;
          };

          return {
              isAvailable: function() { return !!ai },
              getFilterFromQuery: async function(query, options) {
                  if (!this.isAvailable()) {
                      console.warn("Gemini not available, using offline filter logic.");
                      return getFilterFromQueryOffline(query, options);
                  }

                  const systemInstruction = `You are an intelligent assistant for a GST dashboard. Your task is to interpret the user's natural language query and translate it into a JSON object for filtering data. Respond ONLY with a valid JSON object and nothing else.
The JSON object should have an 'action' key, which can be 'filter' or 'details'.
If the action is 'filter', include one or more of the following keys: 'company', 'financialYear', 'month', 'tag'. The values for these keys must be an array of strings, and each string must be one of the provided options.
If the user asks for details about a specific supplier, set 'action' to 'details' and add a 'supplier' key with the supplier's name as a string.
If you cannot determine any filters or actions, return an empty JSON object {}.
If multiple values for a filter are mentioned (e.g. "show Stark and Oscorp"), include both in the array.`;
                  
                  const userPrompt = `User query: "${query}"\n\nAvailable filter options:\n- Companies: ${JSON.stringify(options.companies)}\n- Financial Years: ${JSON.stringify(options.financialYears)}\n- Months: ${JSON.stringify(options.months)}\n- Tags: ${JSON.stringify(options.tags)}`;

                  try {
                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash',
                        contents: userPrompt,
                        config: {
                          systemInstruction: systemInstruction,
                          responseMimeType: "application/json",
                        }
                    });
                    const parsedJson = JSON.parse(response.text);
                    if (parsedJson.action === 'filter') {
                        const matched = Object.values(parsedJson).flat().join(', ');
                        parsedJson.matchedText = matched || "filters cleared";
                    } else if (parsedJson.action === 'details') {
                        parsedJson.matchedText = `details for ${parsedJson.supplier}`;
                    }
                    return parsedJson;
                  } catch (error) {
                      console.error("Error calling Gemini API:", error);
                      return { action: 'unknown', matchedText: "Sorry, I had trouble understanding that." };
                  }
              },
              getAnalysis: async function(prompt, contextData) {
                  if (!this.isAvailable()) {
                      return "AI analysis is not available. Please ensure your API_KEY is configured.";
                  }

                  const fullPrompt = `Based on the following sample of GST transaction data, please provide a concise analysis answering the user's question. Format your response using markdown.\n\nData Sample (up to 25 rows):\n\`\`\`json\n${JSON.stringify(contextData.slice(0, 25), null, 2)}\n\`\`\`\n\nUser's Question: ${prompt}`;
                  
                  try {
                      const response = await ai.models.generateContent({
                          model: 'gemini-2.5-pro',
                          contents: fullPrompt,
                          config: {
                            thinkingConfig: { thinkingBudget: 32768 }
                          }
                      });
                      return response.text;
                  } catch (error) {
                      console.error("Error in AI analysis:", error);
                      return `An error occurred while generating the analysis: ${error.message}`;
                  }
              }
          };
      })();


      // --- React Components ---
      const SvgIcon = function({ d, className }) { return React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: 2 }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d })) };
      const SvgIconThick = function({ d, className }) { return React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: 3 }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d })) };
      const SvgIconUpDown = function({ d, className }) { return React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d })) };
      const SvgIconUpDownCompact = function({ d, className }) { return React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", strokeWidth: 2.5, stroke: "currentColor" }, React.createElement('path', { strokeLinecap: "round", strokeLinejoin: "round", d })) };

      const Icons = {
          BriefcaseIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M20.25 14.15v4.004a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75v-4.004M18 9.348a2.25 2.25 0 00-2.25-2.25h-1.25A2.25 2.25 0 0012 9.348V11.25h6V9.348zM12 9.348a2.25 2.25 0 01-2.25-2.25h-1.25A2.25 2.25 0 016 9.348V11.25h6V9.348z" }) },
          ShieldIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5L12 1z" }) },
          FileUploadIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" }) },
          DatabaseIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7a8 8 0 0116 0M12 11a8 8 0 00-8 4" }) },
          TrashIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" }) },
          ChatBubbleIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" }) },
          SparklesIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0m-8.486 2.828L3 21m18-18l-2.122 2.122" })},
          ArrowUpIcon: function({ className }) { return React.createElement(SvgIconThick, { className, d: "M5 15l7-7 7 7" }) },
          ArrowDownIcon: function({ className }) { return React.createElement(SvgIconThick, { className, d: "M19 9l-7 7-7-7" }) },
          ChevronUpDownIcon: function({ className }) { return React.createElement(SvgIconUpDown, { className, d: "M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" }) },
          DocumentMinusIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M15 12H9m12 4a9 9 0 11-18 0 9 9 0 0118 0z" }) },
          ReceiptIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" }) },
          CheckCircleIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" }) },
          CashIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" }) },
          TrendingUpIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" }) },
          PrinterIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm2-9V5a2 2 0 00-2-2H9a2 2 0 00-2 2v3m4-3h4" }) },
          ChevronUpDownIconCompact: function({ className }) { return React.createElement(SvgIconUpDownCompact, { className, d: "M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" }) },
          FunnelIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L14 12.414V17a1 1 0 01-.293.707l-4 4A1 1 0 018 21v-8.586L3.293 6.707A1 1 0 013 6V4z" }) },
          HomeIcon: function({ className }) { return React.createElement(SvgIcon, { className, d: "M2.25 12l8.954-8.955a.75.75 0 011.06 0l8.955 8.955a.75.75 0 01-1.06 1.06L12 4.061 3.31 13.06a.75.75 0 01-1.06-1.06zM12 21.75v-8.25" }) },
      };

      const Button = function({ variant = 'primary', children, icon, className, ...props }) {
        const baseClasses = 'inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
        const variantClasses = {
          primary: 'bg-primary text-white hover:bg-primary-hover focus:ring-primary',
          secondary: 'bg-slate-600 text-white hover:bg-slate-700 focus:ring-slate-500',
          danger: 'bg-danger text-white hover:bg-danger-hover focus:ring-danger',
          ghost: 'bg-transparent text-slate-700 hover:bg-slate-200 focus:ring-primary',
          'danger-ghost': 'bg-transparent text-danger hover:bg-danger/10 focus:ring-danger'
        };
        const finalClassName = `${baseClasses} ${variantClasses[variant]} ${className || ''}`;
        
        return React.createElement('button', { className: finalClassName, ...props },
          icon && React.createElement('span', { className: 'mr-2 -ml-1 h-5 w-5' }, icon),
          children
        );
      };

      const ProgressBar = function({ progress }) {
          return React.createElement('div', { className: 'w-full bg-slate-200 rounded-full h-2.5' },
              React.createElement('div', { 
                  className: 'bg-primary h-2.5 rounded-full transition-all duration-300 ease-in-out', 
                  style: { width: `${progress}%` } 
              })
          );
      };
      
      const ProductCard = function({ title, description, icon, onClick, earlyAccess = false }) {
        const WavyBg = () => e('svg', { 
            className: 'absolute top-0 left-0 w-full h-full text-indigo-50/80 opacity-40 group-hover:opacity-60 transition-opacity z-0',
            viewBox: "0 0 350 150",
            preserveAspectRatio: "none"
        }, e('path', { d: "M-1.33,49.99 C150.00,150.00 170.04,-49.98 350.00,49.99 L350.00,150.00 L0.00,150.00 Z", fill: "currentColor" }));

        return e('div', { 
            onClick,
            className: 'relative bg-white p-6 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:shadow-lg hover:border-primary/50 transition-all group overflow-hidden' 
        },
            e(WavyBg, null),
            e('div', { className: 'relative z-10 flex flex-col h-full' },
                earlyAccess && e('div', { className: 'absolute top-0 right-0 bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full -mr-2 -mt-2' }, 'Early access'),
                e('div', { className: 'mb-4' }, icon),
                e('div', { className: 'flex-grow' },
                    e('h3', { className: 'text-lg font-bold text-slate-800' }, title),
                    e('p', { className: 'mt-1 text-sm text-slate-600' }, description)
                )
            )
        );
      };

      const LoginPage = function({ onLoginSuccess }) {
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');

          const handleLogin = function(e) {
              e.preventDefault();
              if (username === 'xxx' && password === 'xxx') {
                  onLoginSuccess();
              } else {
                  setError('Invalid username or password.');
              }
          };

          return e('div', { className: 'flex items-center justify-center min-h-screen p-4' },
              e('div', { className: 'w-full max-w-sm' },
                  e('div', { className: 'mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-primary-light mb-5' },
                      e(Icons.BriefcaseIcon, { className: 'h-8 w-8 text-primary' })
                  ),
                  e('h1', { className: 'text-center text-3xl font-bold text-slate-800' }, 'Compliance Cloud'),
                  e('div', { className: 'mt-8 bg-white p-8 rounded-xl shadow-md border border-slate-200' },
                      e('form', { onSubmit: handleLogin, className: 'space-y-6' },
                          e('div', null,
                              e('label', { htmlFor: 'username', className: 'block text-sm font-medium text-slate-700' }, 'Username'),
                              e('div', { className: 'mt-1' },
                                  e(TextInput, { id: 'username', type: 'text', required: true, value: username, onChange: function(ev) { setUsername(ev.target.value) } })
                              )
                          ),
                          e('div', null,
                              e('label', { htmlFor: 'password', className: 'block text-sm font-medium text-slate-700' }, 'Password'),
                              e('div', { className: 'mt-1' },
                                  e(TextInput, { id: 'password', type: 'password', required: true, value: password, onChange: function(ev) { setPassword(ev.target.value) } })
                              )
                          ),
                          error && e('p', { className: 'text-sm text-red-600' }, error),
                          e('div', null,
                              e(Button, { type: 'submit', className: 'w-full justify-center text-base py-3' }, 'Sign In')
                          )
                      )
                  )
              )
          );
      };

      const MainLandingPage = function({ onNavigateToGst }) {
          const cards = [
              { 
                  title: 'GST', 
                  description: 'The ultimate app for all your Goods & Services Tax compliance needs.',
                  icon: e(Icons.BriefcaseIcon, { className: 'w-10 h-10 text-red-600' }),
                  onClick: onNavigateToGst
              },
              { 
                  title: 'TDS',
                  description: 'End-to-end TDS filing, challan payments, reports, certificate generation and more.',
                  icon: e(Icons.CashIcon, { className: 'w-10 h-10 text-orange-500' }),
                  onClick: () => alert('TDS module coming soon!')
              },
              { 
                  title: 'Notice Tracker',
                  description: 'Review and track all your notices from the government.',
                  icon: e(Icons.ShieldIcon, { className: 'w-10 h-10 text-teal-500' }),
                  onClick: () => alert('Notice Tracker coming soon!')
              }
          ];

          return e('div', { className: 'min-h-screen bg-gradient-to-br from-indigo-50 to-white p-6 sm:p-8' },
              e('div', { className: 'max-w-screen-xl mx-auto' },
                  e('h1', { className: 'text-3xl font-bold text-slate-800' }, 'Welcome, Harish'),
                  e('h2', { className: 'mt-2 text-xl text-slate-600' }, 'Clear Compliance Cloud'),
                  e('div', { className: 'mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                      cards.map(function(card) { return e(ProductCard, { key: card.title, ...card }) })
                  )
              )
          );
      };

      const StartupScreen = function({ onFileSelect, onLoadSaved, onClearSaved, onLoadMockData, statusMessage, isLoading, progress, onNavigateToHome }) {
        const fileInputRef = useRef(null);
        const handleFileChange = function(event) {
          const file = event.target.files?.[0];
          if (file) {
            onFileSelect(file);
          }
        };
        const handleUploadClick = function() {
          fileInputRef.current?.click();
        };

        return React.createElement('div', { className: 'flex items-center justify-center min-h-screen p-4 relative' },
          React.createElement('div', { className: 'absolute top-4 left-4' },
            React.createElement(Button, { onClick: onNavigateToHome, variant: 'secondary', icon: React.createElement(Icons.HomeIcon, { className: 'h-5 w-5' }) }, 'Home')
          ),
          React.createElement('div', { className: 'w-full max-w-md text-center' },
            React.createElement('div', { className: 'mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-primary-light mb-5' },
              React.createElement(Icons.ReceiptIcon, { className: 'h-8 w-8 text-primary' })
            ),
            React.createElement('h1', { className: 'text-3xl font-bold text-slate-800' }, 'GST Reconciliation Dashboard'),
            React.createElement('p', { className: 'mt-2 text-slate-600' }, 'Upload an Excel file or load previously saved data to begin.'),
            React.createElement('div', { className: 'mt-8 bg-white p-8 rounded-xl shadow-md border border-slate-200' },
              isLoading ? 
                React.createElement('div', { className: 'space-y-4 py-8' },
                  React.createElement('p', { className: 'text-center text-slate-600 font-medium' }, statusMessage),
                  React.createElement(ProgressBar, { progress: progress })
                ) :
                React.createElement(Fragment, null,
                  React.createElement('input', { type: 'file', ref: fileInputRef, className: 'hidden', accept: '.xlsx, .xls', onChange: handleFileChange }),
                  React.createElement('div', { className: 'space-y-4' },
                    React.createElement(Button, { onClick: handleUploadClick, icon: React.createElement(Icons.FileUploadIcon, { className: 'h-5 w-5' }), className: 'w-full justify-center text-base py-3' }, 'Upload New Excel File'),
                    React.createElement(Button, { onClick: onLoadSaved, variant: 'secondary', icon: React.createElement(Icons.DatabaseIcon, { className: 'h-5 w-5' }), className: 'w-full justify-center text-base py-3' }, 'Use Saved Data'),
                    React.createElement(Button, { onClick: onLoadMockData, variant: 'secondary', className: 'w-full justify-center text-base py-3' }, 'Load Mock Data')
                  ),
                  React.createElement('div', { className: 'mt-6 border-t pt-6' },
                    React.createElement(Button, { onClick: onClearSaved, variant: 'danger-ghost', icon: React.createElement(Icons.TrashIcon, { className: 'w-4 h-4' }) }, 'Clear All Saved Data')
                  )
                )
            ),
            !isLoading && statusMessage && React.createElement('p', { className: 'mt-6 text-sm text-center text-slate-600 h-5' }, statusMessage)
          )
        );
      };
      
      const TextInput = function(props) {
          return e('input', { ...props, className: `w-full rounded-md border-slate-300 shadow-sm text-sm text-slate-900 placeholder:text-slate-400 focus:border-primary focus:ring-1 focus:ring-primary ${props.className || ''}` });
      };
      
      const Checkbox = function({ id, checked, onChange, label }) {
          return e('div', { className: 'flex items-center' },
              e('input', { id, type: 'checkbox', checked, onChange, className: 'h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary' }),
              e('label', { htmlFor: id, className: 'ml-2 block text-sm text-slate-900' }, label)
          );
      };

      const Select = function({ label, value, options, onChange, className = '' }) {
        const [isOpen, setIsOpen] = useState(false);
        const wrapperRef = useRef(null);
        const selectedOption = value === 'All' ? 'All' : options.find(function(opt) { return opt === value }) || 'All';
        const handleSelect = function(option) {
          onChange({ target: { value: option } }); // Mimic event object
          setIsOpen(false);
        };
        useEffect(function() {
          const handleClickOutside = function(event) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
              setIsOpen(false);
            }
          };
          document.addEventListener('mousedown', handleClickOutside);
          return function() { document.removeEventListener('mousedown', handleClickOutside) };
        }, []);
        const renderOptions = ['All', ...options];
        
        return React.createElement('div', { className: `relative ${className}`, ref: wrapperRef },
          label && React.createElement('label', { className: 'block text-xs font-medium text-slate-500 mb-1' }, label),
          React.createElement('button', { type: 'button', onClick: function() { setIsOpen(!isOpen) }, className: 'relative w-full bg-white border border-slate-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm text-slate-900' },
            React.createElement('span', { className: 'block truncate' }, selectedOption),
            React.createElement('span', { className: 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none' }, React.createElement(Icons.ChevronUpDownIconCompact, { className: 'h-5 w-5 text-gray-400' }))
          ),
          isOpen && React.createElement('div', { className: 'absolute z-30 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm' },
            renderOptions.map(function(option) { return React.createElement('div', { key: option, onClick: function() { handleSelect(option) }, className: 'cursor-default select-none relative py-2 pl-3 pr-9 text-gray-900 hover:bg-primary-light hover:text-primary-dark' },
              React.createElement('span', { className: `font-normal block truncate ${value === option ? 'font-semibold' : ''}` }, option)
            )})
          )
        );
      };
      
      const MultiSelect = function({ label, values, options, onChange, className = '' }) {
        const [isOpen, setIsOpen] = useState(false);
        const [searchTerm, setSearchTerm] = useState('');
        const wrapperRef = useRef(null);

        useEffect(function() {
          const handleClickOutside = function(event) {
            if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
              setIsOpen(false);
            }
          };
          document.addEventListener('mousedown', handleClickOutside);
          return function() { document.removeEventListener('mousedown', handleClickOutside) };
        }, []);

        const handleToggleOption = function(option) {
          const newValues = values.includes(option) ? values.filter(function(v) { return v !== option }) : [...values, option];
          onChange(newValues);
        };
        
        const filteredOptions = useMemo(function() {
            if (!searchTerm) return options;
            return options.filter(function(opt) { return String(opt).toLowerCase().includes(searchTerm.toLowerCase()) });
        }, [options, searchTerm]);

        const displayValue = values.length === 0 ? 'All' :
                             values.length === options.length ? 'All' :
                             values.length === 1 ? values[0] :
                             `${values.length} selected`;

        return e('div', { className: `relative ${className}`, ref: wrapperRef },
          label && e('label', { className: 'block text-xs font-medium text-slate-500 mb-1' }, label),
          e('button', { type: 'button', onClick: function() { setIsOpen(!isOpen) }, className: 'relative w-full bg-white border border-slate-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm text-slate-900' },
            e('span', { className: 'block truncate' }, displayValue),
            e('span', { className: 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none' }, e(Icons.ChevronUpDownIconCompact, { className: 'h-5 w-5 text-gray-400' }))
          ),
          isOpen && e('div', { className: 'absolute z-30 mt-1 w-full bg-white shadow-lg max-h-80 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm flex flex-col' },
            e('div', { className: 'p-2 border-b' }, 
                e(TextInput, { placeholder: `Search...`, value: searchTerm, onChange: function(e) { setSearchTerm(e.target.value) }, className: 'w-full' })
            ),
            e('div', { className: 'flex-grow overflow-y-auto' },
                filteredOptions.map(function(option) { return e('div', { key: option, onClick: function() { handleToggleOption(option) }, className: 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 hover:bg-primary-light flex items-center' },
                    e('input', { type: 'checkbox', readOnly: true, checked: values.includes(option), className: 'h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary mr-3' }),
                    e('span', { className: 'font-normal block truncate' }, option)
                )})
            ),
            e('div', { className: 'flex justify-between p-2 border-t' },
                e('button', { onClick: function() { onChange(options) }, className: 'text-sm text-primary hover:underline' }, "Select All"),
                e('button', { onClick: function() { onChange([]) }, className: 'text-sm text-primary hover:underline' }, "Clear All"),
            )
          )
        );
      };

      const ActionSelect = function({ rowId, value, onChange }) {
          const handleChange = function(e) {
              onChange(rowId, e.target.value);
          };
          return React.createElement(Select, { value, options: ACTION_OPTIONS.filter(function(o) { return o !== 'None' }), onChange: handleChange, className: "w-40" });
      };
      
      const Chatbot = function({ slicerOptions, onFilterChange, setPrintModalData, allData }) {
          const [isOpen, setIsOpen] = useState(false);
          const [messages, setMessages] = useState([{ text: "Hi! I'm an AI assistant. How can I help you filter or analyze the GST data? (e.g., 'show Stark Industries in June', 'details for Wayne Enterprises')", sender: 'bot' }]);
          const [input, setInput] = useState('');
          const messagesEndRef = useRef(null);

          useEffect(function() {
              messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
          }, [messages]);

          const handleSend = async function() {
              if (!input.trim() || !geminiService.isAvailable()) {
                  if(!geminiService.isAvailable()) {
                      alert("AI Assistant is not available. Please configure your API_KEY.");
                  }
                  return;
              };
              const userMessage = { text: input, sender: 'user' };
              setMessages(function(prev) { return [...prev, userMessage, { text: 'Thinking...', sender: 'bot', isThinking: true }] });
              setInput('');

              const interpretation = await geminiService.getFilterFromQuery(userMessage.text, slicerOptions);

              setMessages(function(prev) { return prev.filter(function(m) { return !m.isThinking }) });

              if (interpretation.action === 'filter') {
                  const newFilters = {};
                  if (interpretation.company) newFilters.company = interpretation.company;
                  if (interpretation.financialYear) newFilters.financialYear = interpretation.financialYear;
                  if (interpretation.month) newFilters.month = interpretation.month;
                  if (interpretation.tag) newFilters.tag = interpretation.tag;
                  onFilterChange(newFilters);
                  setMessages(function(prev) { return [...prev, { text: `OK, I've applied the filters for: ${interpretation.matchedText}. Check the dashboard.`, sender: 'bot' }] });
              } else if (interpretation.action === 'details' && interpretation.supplier) {
                  const supplierData = allData.filter(function(row) { return row['Supplier Name'] === interpretation.supplier });
                   if (supplierData.length > 0) {
                      setPrintModalData({ isOpen: true, category: `Details for ${interpretation.supplier}`, data: supplierData });
                      setMessages(function(prev) { return [...prev, { text: `Showing details for ${interpretation.supplier}.`, sender: 'bot' }] });
                  } else {
                      setMessages(function(prev) { return [...prev, { text: `I couldn't find any data for a supplier named "${interpretation.supplier}".`, sender: 'bot' }] });
                  }
              } else {
                  setMessages(function(prev) { return [...prev, { text: interpretation.matchedText || "Sorry, I couldn't understand that. Please try again.", sender: 'bot' }] });
              }
          };
          
          if (!isOpen) {
              return React.createElement(Button, { onClick: function() { setIsOpen(true) }, className: 'fixed bottom-5 right-5 rounded-full p-4 shadow-lg z-30', icon: React.createElement(Icons.ChatBubbleIcon, { className: 'h-6 w-6' }) });
          }

          return React.createElement('div', { className: 'fixed bottom-5 right-5 w-[350px] h-[500px] bg-white rounded-lg shadow-2xl z-40 flex flex-col' },
              React.createElement('div', { className: 'p-4 border-b flex justify-between items-center' },
                  React.createElement('h3', { className: 'font-semibold text-lg' }, 'MGST AI Assistant'),
                  React.createElement('button', { onClick: function() { setIsOpen(false) }, className: 'text-2xl text-slate-500 hover:text-slate-800' }, '')
              ),
              React.createElement('div', { ref: messagesEndRef, className: 'flex-grow p-4 overflow-y-auto' },
                  messages.map(function(msg, i) { return React.createElement('div', { key: i, className: `mb-3 max-w-[85%] p-3 rounded-lg ${msg.sender === 'user' ? 'ml-auto bg-primary text-white' : 'mr-auto bg-slate-200'}` }, msg.text) })
              ),
              React.createElement('div', { className: 'p-4 border-t flex' },
                  React.createElement(TextInput, { value: input, onChange: function(e) { setInput(e.target.value) }, onKeyDown: function(e) { return e.key === 'Enter' && handleSend() }, placeholder: "Ask about the data..." }),
                  React.createElement(Button, { onClick: handleSend, className: 'ml-2' }, 'Send')
              )
          );
      };

      const ChartComponent = function({ chartConfig }) {
          const chartRef = useRef(null);
          const chartInstanceRef = useRef(null);
          useEffect(function() {
              if (chartRef.current) {
                  if (chartInstanceRef.current) {
                      chartInstanceRef.current.destroy();
                  }
                  const ctx = chartRef.current.getContext('2d');
                  chartInstanceRef.current = new Chart(ctx, chartConfig);
              }
              return function() {
                  if (chartInstanceRef.current) {
                      chartInstanceRef.current.destroy();
                  }
              };
          }, [chartConfig]);
          return React.createElement('canvas', { ref: chartRef });
      };

      const ColumnFilterPopover = function({ columnKey, data, currentFilters, onFilterChange, close }) {
          const [searchTerm, setSearchTerm] = useState('');
          const menuRef = useRef(null);

          const uniqueValues = useMemo(function() {
              return [...new Set(data.map(function(item) { return item[columnKey] }))].sort();
          }, [data, columnKey]);

          const filteredValues = useMemo(function() {
              if (!searchTerm) return uniqueValues;
              return uniqueValues.filter(function(v) { return String(v).toLowerCase().includes(searchTerm.toLowerCase()) });
          }, [uniqueValues, searchTerm]);

          const handleToggle = function(value) {
              const newFilters = currentFilters.includes(value) ? currentFilters.filter(function(f) { return f !== value }) : [...currentFilters, value];
              onFilterChange(newFilters);
          };

          const handleSelectAll = function() { onFilterChange(uniqueValues) };
          const handleClearAll = function() { onFilterChange([]) };

          return e('div', { ref: menuRef, className: 'absolute top-full mt-2 left-0 z-40 bg-white shadow-lg max-h-80 w-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm flex flex-col' },
            e('div', { className: 'p-2 border-b' },
                e(TextInput, { placeholder: `Search...`, value: searchTerm, onChange: function(e) { setSearchTerm(e.target.value) } })
            ),
            e('div', { className: 'flex-grow overflow-y-auto' },
                filteredValues.map(function(value) { return e('div', { key: value, onClick: function() { handleToggle(value) }, className: 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 hover:bg-primary-light flex items-center' },
                    e('input', { type: 'checkbox', readOnly: true, checked: currentFilters.includes(value), className: 'h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary mr-3' }),
                    e('span', { className: 'font-normal block truncate' }, value)
                )})
            ),
            e('div', { className: 'flex justify-between p-2 border-t' },
                e('button', { onClick: handleSelectAll, className: 'text-sm text-primary hover:underline' }, "Select All"),
                e('button', { onClick: handleClearAll, className: 'text-sm text-primary hover:underline' }, "Clear All"),
            )
          );
      };
      
      const DataTable = function({ columns, data, initialPageSize = 10, onActionChange, onAssignmentChange }) {
          const [sortConfig, setSortConfig] = useState({ key: columns[0]?.key || '', direction: 'ascending' });
          const [currentPage, setCurrentPage] = useState(1);
          const [rowsPerPage, setRowsPerPage] = useState(initialPageSize);
          const [globalFilter, setGlobalFilter] = useState('');
          const [editingCell, setEditingCell] = useState(null);
          const [remarkValue, setRemarkValue] = useState('');
          const [columnFilters, setColumnFilters] = useState({});
          const [openFilter, setOpenFilter] = useState(null); // Key of the column filter that is open
          const filterMenuRef = useRef(null);

          useEffect(function() {
              const handleClickOutside = function(event) {
                  if (openFilter && filterMenuRef.current && !filterMenuRef.current.contains(event.target)) {
                      setOpenFilter(null);
                  }
              };
              document.addEventListener('mousedown', handleClickOutside);
              return function() { document.removeEventListener('mousedown', handleClickOutside) };
          }, [openFilter]);

          const filteredAndSortedData = useMemo(function() {
              let filtered = data;
              if (globalFilter) {
                  filtered = filtered.filter(function(row) {
                      return columns.some(function(col) {
                          const val = row[col.key];
                          return String(val).toLowerCase().includes(globalFilter.toLowerCase());
                      });
                  });
              }
              
              const activeColumnFilters = Object.entries(columnFilters).filter(function([, values]) { return values.length > 0 });
              if (activeColumnFilters.length > 0) {
                  filtered = filtered.filter(function(row) {
                      return activeColumnFilters.every(function([key, values]) {
                          return values.includes(row[key]);
                      });
                  });
              }

              if (sortConfig.key) {
                  const sorted = [...filtered];
                  sorted.sort(function(a, b) {
                      let aValue = a[sortConfig.key];
                      let bValue = b[sortConfig.key];
                      if (typeof aValue === 'string' && !isNaN(parseDateString(aValue))) {
                          aValue = parseDateString(aValue);
                          bValue = parseDateString(bValue);
                      }
                      if (aValue < bValue) return sortConfig.direction === 'ascending' ? -1 : 1;
                      if (aValue > bValue) return sortConfig.direction === 'ascending' ? 1 : -1;
                      return 0;
                  });
                  return sorted;
              }
              return filtered;
          }, [data, sortConfig, globalFilter, columnFilters, columns]);

          const paginatedData = useMemo(function() {
              const start = (currentPage - 1) * rowsPerPage;
              return filteredAndSortedData.slice(start, start + rowsPerPage);
          }, [filteredAndSortedData, currentPage, rowsPerPage]);

          const totalPages = Math.ceil(filteredAndSortedData.length / rowsPerPage);

          useEffect(function() {
              setCurrentPage(1);
          }, [globalFilter, rowsPerPage, columnFilters]);

          const requestSort = function(key) {
              let direction = 'ascending';
              if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                  direction = 'descending';
              }
              setSortConfig({ key, direction });
              setCurrentPage(1);
          };
          
          const handleColumnFilterChange = function(columnKey, values) {
              setColumnFilters(function(prev) { return {...prev, [columnKey]: values}});
          };

          return e('div', { className: 'bg-white p-4 rounded-lg shadow-md border border-slate-200 min-h-[400px] flex flex-col' },
              e('div', { className: 'mb-4' }, 
                  e(TextInput, { 
                      placeholder: 'Search all columns...', 
                      value: globalFilter, 
                      onChange: function(e) { setGlobalFilter(e.target.value) } 
                  })
              ),
              e('div', { className: 'overflow-x-auto flex-grow' },
                  e('table', { className: 'w-full text-sm' },
                      e('thead', { className: 'text-xs text-slate-700 uppercase bg-slate-50' },
                          e('tr', null,
                              columns.map(function(col) { return e('th', { key: col.header, className: `px-4 py-3 text-black`, onClick: function() { col.sortable && requestSort(col.key) } }, 
                                  e('div', { className: 'flex items-center justify-between' },
                                      e('div', { className: `flex items-center ${col.sortable ? 'cursor-pointer' : ''}` }, 
                                          col.header,
                                          col.sortable && sortConfig.key === col.key && (sortConfig.direction === 'ascending' ? e(Icons.ArrowUpIcon, { className: 'w-3 h-3 ml-1' }) : e(Icons.ArrowDownIcon, { className: 'w-3 h-3 ml-1' }))
                                      ),
                                      col.filterable && e('div', { className: 'relative' },
                                          e('button', { onClick: function(e) { e.stopPropagation(); setOpenFilter(openFilter === col.key ? null : col.key) }, className: 'p-1 rounded hover:bg-slate-200' },
                                              e(Icons.FunnelIcon, { className: `w-4 h-4 ${columnFilters[col.key]?.length > 0 ? 'text-primary' : 'text-slate-400'}` })
                                          ),
                                          e('div', { ref: openFilter === col.key ? filterMenuRef : null },
                                              openFilter === col.key && e(ColumnFilterPopover, {
                                                  columnKey: col.key,
                                                  data: data,
                                                  currentFilters: columnFilters[col.key] || [],
                                                  onFilterChange: function(values) { handleColumnFilterChange(col.key, values) },
                                                  close: function() { setOpenFilter(null) }
                                              })
                                          )
                                      )
                                  )
                              )})
                          )
                      ),
                      e('tbody', null,
                          paginatedData.map(function(row, index) { return e('tr', { key: row.id || index, className: 'bg-white border-b border-slate-400 hover:bg-slate-50' },
                              columns.map(function(col) {
                                  const value = col.render ? col.render(row, onActionChange, onAssignmentChange) : row[col.key];
                                  return e('td', { key: col.key, className: 'px-4 py-2 text-black align-top' }, value);
                              })
                          )})
                      )
                  )
              ),
              e('div', { className: 'flex flex-col sm:flex-row justify-between items-center pt-4 text-sm text-slate-600' },
                  e('div', { className: 'flex items-center gap-2 mb-2 sm:mb-0' },
                      e('span', null, 'Rows per page:'),
                      e('select', { value: rowsPerPage, onChange: function(e) { setRowsPerPage(Number(e.target.value)); setCurrentPage(1); }, className: 'p-1 border-slate-300 rounded-md' },
                          [10, 25, 50, 100].map(function(size) { return e('option', { key: size, value: size }, size) })
                      )
                  ),
                  e('div', { className: 'flex items-center gap-4' },
                      e('span', null, `Page ${currentPage} of ${totalPages}`),
                      e('div', { className: 'flex gap-1' },
                          e(Button, { onClick: function() { setCurrentPage(function(p) { return Math.max(1, p-1) }) }, disabled: currentPage === 1, variant: 'ghost', className: 'px-2 py-1' }, 'Prev'),
                          e(Button, { onClick: function() { setCurrentPage(function(p) { return Math.min(totalPages, p+1) }) }, disabled: currentPage === totalPages, variant: 'ghost', className: 'px-2 py-1' }, 'Next')
                      )
                  )
              )
          );
      };

      const ValidationPage = function({ allData, validationBooks, onValidateWithBooks }) {
          const fileInputRef = React.useRef(null);
          
          const validationResults = React.useMemo(function() {
              const allBookRows = validationBooks.flatMap(function(book) {
                  return book.data.map(function(row) {
                      return {...row, 'Company Name': book.companyName}
                  });
              });
              
              const mainDataLookup = new Map();
              allData.forEach(function(row) {
                  if (row.Type.startsWith('Missing_in_PR')) {
                      const key = `${row['Company Name']}|${row['Document Number (2B)']}|${row['Supplier GSTIN (2B)'] || ''}`;
                      mainDataLookup.set(key, row);
                  }
              });

              const matched = [];
              const unmatched = [];
              
              const getCol = function(row, candidates) {
                  for(const c of candidates) {
                      const key = Object.keys(row).find(function(k) { return k.trim().toLowerCase() === c.toLowerCase() });
                      if(key) return row[key];
                  }
                  return null;
              }

              allBookRows.forEach(function(bookRow) {
                  const docNum = getCol(bookRow, ['Voucher Ref. No.', 'Document Number']);
                  const gstin = getCol(bookRow, ['GSTIN/UIN', 'GSTIN']);
                  const key = `${bookRow['Company Name']}|${docNum}|${gstin || ''}`;
                  
                  if (mainDataLookup.has(key)) {
                      matched.push(mainDataLookup.get(key));
                      mainDataLookup.delete(key);
                  } else {
                      unmatched.push({
                          ...bookRow,
                          id: `unmatched_${docNum}_${Math.random()}`,
                          'Supplier Name': getCol(bookRow, ['Party Name']),
                          'Document Number (2B)': docNum,
                          'Document Date (2B)': getCol(bookRow, ['Voucher Date']),
                          'Sum of Taxable Value (2B)': getCol(bookRow, ['Taxable Value']),
                          'Total GST': getCol(bookRow, ['Total Tax']),
                          Remarks: 'Unmatched'
                      });
                  }
              });
              return { matched, unmatched };
          }, [validationBooks, allData]);

          const columns = [
              { header: 'Company Name', key: 'Company Name', sortable: true, filterable: true },
              { header: 'Supplier Name', key: 'Supplier Name', sortable: true, filterable: true },
              { header: 'Doc Num', key: 'Document Number (2B)', sortable: true },
              { header: 'Doc Date', key: 'Document Date (2B)', sortable: true },
              { header: 'Taxable', key: 'Sum of Taxable Value (2B)', render: function(r) { return formatCurrency(r['Sum of Taxable Value (2B)'], false) } },
              { header: 'Total GST', key: 'Total GST', render: function(r) { return formatCurrency(r['Total GST'], false) } },
              { header: 'Remarks', key: 'Remarks' },
          ];
          
          return e('div', { className: 'space-y-6' },
              e('div', { className: 'bg-white p-4 rounded-lg shadow-md border' },
                  e('h2', { className: 'text-lg font-semibold' }, "Upload Books File"),
                  e('p', { className: 'text-sm text-slate-600 mt-1 mb-4' }, "Filename must be 'Books_CompanyName.xlsx'. This will find matches and auto-mark them as 'Accounted'."),
                  e('input', { type: 'file', ref: fileInputRef, className: 'hidden', onChange: function(e) { return e.target.files[0] && onValidateWithBooks(e.target.files[0]) } }),
                  e(Button, { onClick: function() { return fileInputRef.current.click() } }, "Upload 'Books' Excel File")
              ),
              e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
                  e('div', null, 
                      e('h2', { className: 'text-xl font-bold text-success mb-2' }, 'Matched Transactions'),
                      e(DataTable, { columns, data: validationResults.matched })
                  ),
                  e('div', null,
                      e('h2', { className: 'text-xl font-bold text-danger mb-2' }, 'Unmatched Transactions'),
                      e(DataTable, { columns, data: validationResults.unmatched })
                  )
              )
          );
      };

      const TransactionsPage = function({ data, actionState, updateAction }) {
          const [jtcFilter, setJtcFilter] = useState(false);
          const [editingCell, setEditingCell] = useState(null);
          const [remarkValue, setRemarkValue] = useState('');

          const tableData = useMemo(function() {
              if (!jtcFilter) return data;
              return data.filter(function(row) {
                  const action = actionState[row.id];
                  return (typeof action === 'string' && action === 'Accounted') || (action?.action === 'Accounted');
              });
          }, [data, jtcFilter, actionState]);

          const handleRemarkEdit = function(rowId, currentRemark) {
              setEditingCell(rowId);
              setRemarkValue(currentRemark);
          };
          const handleRemarkSave = function(rowId) {
              if (editingCell === rowId) {
                  const currentAction = actionState[rowId];
                  const newAction = typeof currentAction === 'object' ? { ...currentAction } : {};
                  newAction.remarks = remarkValue;
                  updateAction(rowId, newAction);
                  setEditingCell(null);
              }
          };
          const handleRemarkKeyDown = function(e, rowId) {
              if (e.key === 'Enter') handleRemarkSave(rowId);
              if (e.key === 'Escape') setEditingCell(null);
          };

          const columns = [
              { header: 'Company Name', key: 'Company Name', sortable: true, filterable: true },
              { header: 'Supplier Name', key: 'Supplier Name', sortable: true, filterable: true },
              { header: 'Doc Num', key: 'Document Number (2B)', sortable: true },
              { header: 'Doc Date', key: 'Document Date (2B)', sortable: true },
              { header: 'Tag', key: 'Type', sortable: true, filterable: true },
              { header: 'Taxable', key: 'Sum of Taxable Value (2B)', sortable: true, render: function(row) { return formatCurrency(row['Sum of Taxable Value (2B)'], false) } },
              { header: 'Total GST', key: 'Total GST', sortable: true, render: function(row) { return formatCurrency(row['Total GST'], false) } },
              { header: 'Remarks', key: 'Remarks', render: function(row) {
                  const currentAction = actionState[row.id];
                  const currentRemark = (typeof currentAction === 'object' ? currentAction?.remarks : '') || row.Remarks;
                  if (editingCell === row.id) {
                      return e(TextInput, { 
                          value: remarkValue, 
                          onChange: function(e) { setRemarkValue(e.target.value) },
                          onBlur: function() { handleRemarkSave(row.id) },
                          onKeyDown: function(e) { handleRemarkKeyDown(e, row.id) },
                          autoFocus: true 
                      });
                  }
                  return e('span', { onClick: function() { handleRemarkEdit(row.id, currentRemark) }, className: 'cursor-pointer hover:underline' }, currentRemark || '...');
              }},
              { header: 'Action', key: 'Action', render: function(row, onActionChange) {
                  const currentAction = actionState[row.id];
                  const value = typeof currentAction === 'string' ? currentAction : currentAction?.action;
                  const handleChange = function(id, val) {
                      const newAction = typeof currentAction === 'object' ? { ...currentAction } : {};
                      newAction.action = val;
                      onActionChange(id, newAction);
                  };
                  return e(ActionSelect, { rowId: row.id, value: value || 'None', onChange: handleChange });
              }}
          ];

          return e('div', null,
              e('div', { className: 'mb-4 flex flex-col sm:flex-row justify-between items-center gap-4' },
                  e(Checkbox, { id: 'jtcFilter', checked: jtcFilter, onChange: function(e) { setJtcFilter(e.target.checked) }, label: 'Show Accounted Only' }),
                  e(Button, { onClick: function() { exportToCsv(tableData, 'Transactions') }, variant: 'secondary' }, 'Export CSV')
              ),
              e(DataTable, { columns, data: tableData, onActionChange: updateAction })
          );
      };
      
      const AddToListSelect = function({ supplier, company, value, onChange }) {
          const key = `${company}|${supplier}`;
          const handleChange = function(e) {
              onChange(key, e.target.value);
          };
          return e(Select, { value, options: MAILING_LIST_CATEGORIES, onChange: handleChange, className: "w-40" });
      };

      const SuppliersPage = function({ data, assignmentState, updateAssignment }) {
        const supplierData = useMemo(function() {
          const suppliersInView = {};
          data.forEach(function(row) {
            const key = `${row['Company Name']}|${row['Supplier Name']}`;
            if (!suppliersInView[key]) {
              suppliersInView[key] = { id: key, company: row['Company Name'], name: row['Supplier Name'], totalGst: 0, transactionCount: 0 };
            }
            suppliersInView[key].totalGst += row['Total GST'];
            suppliersInView[key].transactionCount++;
          });
          
          Object.keys(assignmentState).forEach(function(key) {
              if (assignmentState[key] && assignmentState[key] !== 'None' && !suppliersInView[key]) {
                  const [company, name] = key.split('|');
                  suppliersInView[key] = { id: key, company: company, name: name, totalGst: 0, transactionCount: 0 };
              }
          });
          
          return Object.values(suppliersInView);
        }, [data, assignmentState]);

        const columns = [
            { header: 'Company Name', key: 'company', sortable: true, filterable: true },
            { header: 'Supplier Name', key: 'name', sortable: true, filterable: true },
            { header: 'Total GST', key: 'totalGst', sortable: true, render: function(row) { return formatCurrency(row.totalGst, false) } },
            { header: 'Transactions', key: 'transactionCount', sortable: true },
            { header: 'Add to List', key: 'list', render: function(row, _onAction, onAssignment) {
                return e(AddToListSelect, { 
                    supplier: row.name, 
                    company: row.company, 
                    value: assignmentState[row.id] || 'None', 
                    onChange: onAssignment 
                });
            }},
        ];

        return e('div', null,
          e('div', { className: 'mb-4 flex justify-end' },
            e(Button, { onClick: function() { exportToCsv(supplierData, "supplier_summary_export") }, variant: 'secondary' }, 'Export CSV')
          ),
          e(DataTable, { columns: columns, data: supplierData, onAssignmentChange: updateAssignment })
        );
      };

      const MailingListPage = function({ data, actionState, assignmentState, setPrintModalData }) {
          const handleShowPreview = function(category) {
              const assignedSuppliers = Object.entries(assignmentState)
                  .filter(function([key, cat]) { return cat === category })
                  .map(function([key]) { return key });
              
              const uniqueEntries = new Set();
              const mailingData = data.filter(function(row) {
                  const key = `${row['Company Name']}|${row['Supplier Name']}`;
                  const entryKey = `${key}|${row['Document Number (2B)']}`;

                  const action = actionState[row.id];
                  const isAccounted = typeof action === 'string' ? action === 'Accounted' : action?.action === 'Accounted';

                  if (assignedSuppliers.includes(key) && !isAccounted && !uniqueEntries.has(entryKey)) {
                      uniqueEntries.add(entryKey);
                      return true;
                  }
                  return false;
              });

              if (mailingData.length === 0) {
                  alert(`No pending transactions found for mailing list: ${category}`);
                  return;
              }
              setPrintModalData({ isOpen: true, category, data: mailingData });
          };

          return e('div', { className: 'bg-white p-6 rounded-lg shadow-md border' },
              e('h2', { className: 'text-lg font-semibold mb-4' }, 'Select a Category to View / Export:'),
              e('div', { className: 'flex flex-wrap gap-3' },
                  MAILING_LIST_CATEGORIES.map(function(cat) { return e(Button, { key: cat, onClick: function() { return handleShowPreview(cat) } }, cat)})
              )
          );
      };
      
      const PrintModal = function({ printModalData, setPrintModalData, actionState }) {
          if (!printModalData.isOpen) return null;
          
          const handlePrint = function() {
              const title = `Report: ${printModalData.category}`;
              controlledPrint('print-table', title);
          };
          const handleExport = function() {
              const exportData = printModalData.data.map(function(row) {
                const action = actionState[row.id];
                return {
                  'Company Name': row['Company Name'],
                  'Supplier Name': row['Supplier Name'],
                  'Doc Num': row['Document Number (2B)'],
                  'Doc Date': row['Document Date (2B)'],
                  'Tag': row.Type,
                  'Taxable': row['Sum of Taxable Value (2B)'],
                  'Total GST': row['Total GST'],
                  'Remarks': (typeof action === 'object' ? action?.remarks : '') || row.Remarks,
                  'Action': (typeof action === 'string' ? action : action?.action) || 'None'
              }});
              exportToCsv(exportData, `MailingList_${printModalData.category}`);
          };

          return e('div', { id: 'print-modal', className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
              e('div', { id: 'print-modal-content', className: 'bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col' },
                  e('div', { id: 'print-modal-header', className: 'p-4 border-b flex justify-between items-center' },
                      e('h2', { className: 'text-xl font-bold' }, `Preview: ${printModalData.category}`),
                      e('button', { onClick: function() { return setPrintModalData({isOpen: false, category: '', data: []}) }, className: 'text-2xl' }, '')
                  ),
                  e('div', { className: 'p-4 overflow-auto flex-grow' },
                      e('table', { id: 'print-table', className: 'w-full text-sm' },
                          e('thead', null, e('tr', null, ['Company', 'Supplier', 'Doc Num', 'Doc Date', 'Tag', 'Taxable', 'Total GST', 'Remarks', 'Action'].map(function(h) { return e('th', { key: h, className: 'p-2 border border-slate-500 text-black text-left bg-slate-100' }, h) }))),
                          e('tbody', null, printModalData.data.map(function(row) {
                            const action = actionState[row.id];
                            return e('tr', { key: row.id },
                              e('td', { className: 'p-2 border border-slate-500 text-black' }, row['Company Name']),
                              e('td', { className: 'p-2 border border-slate-500 text-black' }, row['Supplier Name']),
                              e('td', { className: 'p-2 border border-slate-500 text-black' }, row['Document Number (2B)']),
                              e('td', { className: 'p-2 border border-slate-500 text-black' }, row['Document Date (2B)']),
                              e('td', { className: 'p-2 border border-slate-500 text-black' }, row.Type),
                              e('td', { className: 'p-2 border border-slate-500 text-black text-right' }, formatCurrency(row['Sum of Taxable Value (2B)'], false)),
                              e('td', { className: 'p-2 border border-slate-500 text-black text-right' }, formatCurrency(row['Total GST'], false)),
                              e('td', { className: 'p-2 border border-slate-500 text-black' }, (typeof action === 'object' ? action?.remarks : '') || row.Remarks),
                              e('td', { className: 'p-2 border border-slate-500 text-black' }, (typeof action === 'string' ? action : action?.action) || 'None')
                          )}))
                      )
                  ),
                  e('div', { id: 'print-modal-footer', className: 'p-4 border-t flex justify-end gap-3' },
                      e(Button, { onClick: handleExport, variant: 'secondary' }, 'Export CSV'),
                      e(Button, { onClick: handlePrint, icon: e(Icons.PrinterIcon, null) }, 'Print'),
                      e(Button, { onClick: function() { return setPrintModalData({isOpen: false, category: '', data: []}) }, variant: 'danger-ghost' }, 'Close')
                  )
              )
          );
      };
      
      const ThinkingModeModal = function({ isOpen, onClose, contextData }) {
          const [prompt, setPrompt] = useState('');
          const [response, setResponse] = useState('');
          const [isLoading, setIsLoading] = useState(false);

          if (!isOpen) return null;

          const handleSubmit = async function() {
              if (!prompt.trim() || !geminiService.isAvailable()) {
                  if(!geminiService.isAvailable()) {
                      alert("AI analysis is not available. Please configure your API_KEY.");
                  }
                  return;
              };
              setIsLoading(true);
              setResponse('');
              const analysis = await geminiService.getAnalysis(prompt, contextData);
              setResponse(analysis);
              setIsLoading(false);
          };

          return e('div', { className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
              e('div', { className: 'bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col' },
                  e('div', { className: 'p-4 border-b flex justify-between items-center' },
                      e('h2', { className: 'text-xl font-bold' }, 'Analyze with AI (Thinking Mode)'),
                      e('button', { onClick: onClose, className: 'text-2xl' }, '')
                  ),
                  e('div', { className: 'p-4 flex-grow flex flex-col gap-4' },
                      e('div', null,
                          e('label', { htmlFor: 'ai-prompt', className: 'block text-sm font-medium text-slate-700 mb-1' }, 'Ask a complex question about the current data view:'),
                          e('textarea', { 
                              id: 'ai-prompt',
                              rows: 4, 
                              value: prompt,
                              onChange: function(e) { setPrompt(e.target.value) },
                              className: 'w-full rounded-md border-slate-300 shadow-sm text-sm focus:border-primary focus:ring-1 focus:ring-primary',
                              placeholder: 'e.g., "What are the common trends for suppliers with missing GST in the last quarter?" or "Summarize the top 3 suppliers by missing GST and suggest an action plan."'
                          })
                      ),
                      e('div', null,
                          e(Button, { onClick: handleSubmit, disabled: isLoading || !prompt.trim(), icon: e(Icons.SparklesIcon, { className: 'w-5 h-5'}) },
                              isLoading ? 'Analyzing...' : 'Submit to AI'
                          )
                      ),
                      (isLoading || response) && e('div', { className: 'border-t pt-4 flex-grow overflow-y-auto' },
                          isLoading ? e('div', { className: 'flex items-center gap-2 text-slate-600' }, 
                              e('div', { className: 'w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin' }),
                              e('span', null, 'The AI is thinking... this may take a moment.')
                          ) :
                          e('pre', { className: 'bg-slate-50 p-3 rounded-md text-sm text-slate-800 whitespace-pre-wrap font-sans' }, response)
                      )
                  ),
                  e('div', { className: 'p-4 border-t flex justify-end' },
                      e(Button, { onClick: onClose, variant: 'secondary' }, 'Close')
                  )
              )
          );
      };

      const Dashboard = function({
        allData, slicerOptions, filters, setFilters, actionState, updateAction,
        assignmentState, updateAssignment, clearAllData, onValidateWithBooks,
        validationBooks, activeTab, setActiveTab, onKpiClick, setPrintModalData,
        onNavigateToHome
      }) {
          const [isThinkingModalOpen, setIsThinkingModalOpen] = useState(false);
          
          const filteredData = useMemo(function() {
              const { company, financialYear, month, tag } = filters;
              if (!allData) return [];
              return allData.filter(function(r) {
                  return (company.length === 0 || company.includes(r['Company Name'])) &&
                  (financialYear.length === 0 || financialYear.includes(r['Financial Year'])) &&
                  (month.length === 0 || month.includes(r['Month'])) &&
                  (tag.length === 0 || tag.includes(r['Type']))
              });
          }, [allData, filters]);
          
          const handleSupplierChartClick = function(supplierName) {
            const supplierData = filteredData.filter(function(row) {
                const isMissing = (row.Type.includes('Missing_2B') || row.Type.includes('Missing_in_PR')) && !row.Type.includes('NowUploaded') && !row.Type.includes('NowClaimed');
                return row['Supplier Name'] === supplierName && isMissing;
            });
            if (supplierData.length > 0) {
                setPrintModalData({ isOpen: true, category: `Missing GST Details for ${supplierName}`, data: supplierData });
            } else {
                alert(`No missing GST transactions found for ${supplierName} within the current filter selection.`);
            }
          };

          const kpiData = useMemo(function() {
              const missing2bCum = filteredData.reduce(function(sum, r) {
                  return (r.Type === 'Missing_2B_Cumulative' || r.Type === 'Missing_2B_Current_Month') ? sum + r['Total GST'] : sum;
              }, 0);
              const missingPrCum = filteredData.reduce(function(sum, r) {
                  return r.Type.startsWith('Missing_in_PR_') && !r.Type.includes('NowClaimed') ? sum + r['Total GST'] : sum;
              }, 0);
              const missing2bClaimed = filteredData.reduce(function(sum, r) {
                  return r.Type === 'Missing_2B_NowUploaded' ? sum + r['Total GST'] : sum;
              }, 0);
              const missingPrClaimed = filteredData.reduce(function(sum, r) {
                  return r.Type.startsWith('Missing_in_PR_NowClaimed') || r.Type.startsWith('Missing_PR_NowClaimed') ? sum + r['Total GST'] : sum;
              }, 0);
              const totalRecovered = missing2bClaimed + missingPrClaimed;
              const totalMissing = missing2bCum + missingPrCum;
              const successRate = (totalMissing + totalRecovered) > 0 ? (totalRecovered / (totalMissing + totalRecovered)) * 100 : 0;
              return { missing2bCum, missingPrCum, missing2bClaimed, missingPrClaimed, totalRecovered, successRate };
          }, [filteredData]);

          const chartData = useMemo(function() {
              if (!filteredData || filteredData.length === 0) {
                  return { monthly: null, byCategory: null, topSuppliers: null };
              }

              const monthly = {};
              filteredData.forEach(function(r) {
                  const month = r.Month;
                  if (!monthly[month]) monthly[month] = { missing: 0, recovered: 0 };
                  if (r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) {
                      if (r.Type.includes('NowUploaded') || r.Type.includes('NowClaimed')) {
                          monthly[month].recovered += r['Total GST'];
                      } else {
                          monthly[month].missing += r['Total GST'];
                      }
                  }
              });

              const sortedMonths = Object.keys(monthly).sort(function(a, b) { return getMonthNumber(a) - getMonthNumber(b); });
              const monthlyChartConfig = {
                  type: 'bar',
                  data: {
                      labels: sortedMonths,
                      datasets: [
                          { label: 'Missing GST', data: sortedMonths.map(function(m) { return monthly[m].missing; }), backgroundColor: '#EF4444' },
                          { label: 'Recovered GST', data: sortedMonths.map(function(m) { return monthly[m].recovered; }), backgroundColor: '#10B981' }
                      ]
                  },
                  options: { responsive: true, plugins: { title: { display: true, text: 'Monthly Missing vs. Recovered GST' } }, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: function(value) { return formatCurrency(value, true); } } } } }
              };
              
              const byCategory = {};
              filteredData.forEach(function(r) {
                  if ((r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) && !r.Type.includes('NowUploaded') && !r.Type.includes('NowClaimed')) {
                      const category = r.Type;
                      if (!byCategory[category]) byCategory[category] = 0;
                      byCategory[category] += r['Total GST'];
                  }
              });
              const categoryChartConfig = {
                  type: 'doughnut',
                  data: {
                      labels: Object.keys(byCategory),
                      datasets: [{ data: Object.values(byCategory), backgroundColor: ['#EF4444', '#F59E0B', '#3B82F6', '#8B5CF6', '#EC4899'] }]
                  },
                  options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Missing GST by Category' } } }
              };

              const bySupplier = {};
               filteredData.forEach(function(r) {
                  if ((r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) && !r.Type.includes('NowUploaded') && !r.Type.includes('NowClaimed')) {
                      const supplier = r['Supplier Name'];
                      if (!bySupplier[supplier]) {
                          bySupplier[supplier] = { gst: 0, supplier: supplier };
                      }
                      bySupplier[supplier].gst += r['Total GST'];
                  }
              });
              const topSuppliers = Object.values(bySupplier).sort(function(a, b) { return b.gst - a.gst; }).slice(0, 10);
              const topSuppliersChartConfig = {
                  type: 'bar',
                  data: {
                      labels: topSuppliers.map(function(s) { return s.supplier; }),
                      datasets: [{ label: 'Missing GST', data: topSuppliers.map(function(s) { return s.gst; }), backgroundColor: '#4F46E5' }]
                  },
                  options: {
                      indexAxis: 'y',
                      responsive: true,
                      plugins: {
                          title: { display: true, text: 'Top 10 Suppliers by Missing GST' }
                      },
                      scales: {
                          x: { ticks: { callback: function(value) { return formatCurrency(value, true); } } }
                      },
                      onClick: function(evt, elements) {
                          if (!elements.length) return;
                          const index = elements[0].index;
                          const supplier = topSuppliers[index].supplier;
                          handleSupplierChartClick(supplier);
                      }
                  }
              };

              return { monthly: monthlyChartConfig, byCategory: categoryChartConfig, topSuppliers: topSuppliersChartConfig };
          }, [filteredData]);
          
          const Header = function() { return React.createElement('header', { className: 'bg-white shadow-sm w-full p-3' },
              React.createElement('div', { className: 'max-w-screen-2xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4' },
                  React.createElement('div', { className: 'flex items-center' },
                      React.createElement('h1', { className: 'text-xl font-bold text-primary-dark shrink-0' }, 'GST Reconciliation Dashboard'),
                      React.createElement(Button, { onClick: function() { onNavigateToHome() }, variant: 'ghost', className: 'ml-4', icon: React.createElement(Icons.HomeIcon, { className: 'h-5 w-5' }) }, 'Home')
                  ),
                  React.createElement('div', { className: 'flex flex-wrap justify-center md:justify-end gap-3 w-full items-center' },
                      React.createElement(MultiSelect, { label: 'Company', values: filters.company, options: slicerOptions.companies, onChange: function(v) { setFilters(function(f) { return {...f, company: v}}) }, className: 'w-40' }),
                      React.createElement(MultiSelect, { label: 'FY', values: filters.financialYear, options: slicerOptions.financialYears, onChange: function(v) { setFilters(function(f) { return {...f, financialYear: v}}) }, className: 'w-28' }),
                      React.createElement(MultiSelect, { label: 'Month', values: filters.month, options: slicerOptions.months, onChange: function(v) { setFilters(function(f) { return {...f, month: v}}) }, className: 'w-32' }),
                      React.createElement(MultiSelect, { label: 'Tag (Type)', values: filters.tag, options: slicerOptions.tags, onChange: function(v) { setFilters(function(f) { return {...f, tag: v}}) }, className: 'w-48' }),
                      React.createElement(Button, { onClick: function() { setIsThinkingModalOpen(true) }, variant: 'secondary', icon: e(Icons.SparklesIcon, { className: 'h-4 w-4' }) }, 'Analyze with AI'),
                      React.createElement(Button, { onClick: clearAllData, variant: 'danger-ghost', icon: React.createElement(Icons.TrashIcon, { className: 'w-4 h-4' }) }, 'Clear')
                  )
              )
          )};
          
          const tabs = ['KPIs', 'Transactions', 'Suppliers', 'Mailing List', 'Validate with Books'];
          const Navigation = function() { return React.createElement('nav', { className: 'bg-white w-full shadow-sm border-b' },
              React.createElement('div', { className: 'max-w-screen-2xl mx-auto flex justify-start px-2 text-sm' },
                  tabs.map(function(tab) { return React.createElement('button', {
                      key: tab,
                      onClick: function() { setActiveTab(tab) },
                      className: `py-3 px-4 font-medium border-b-2 transition-colors ${activeTab === tab ? 'border-primary text-primary' : 'border-transparent text-slate-600 hover:border-slate-300 hover:text-slate-800'}`
                  }, tab)})
              )
          )};
          
          const KpiCard = function({ title, value, subValue, icon, color, onClick }) {
              const colorClasses = {
                  red: 'text-red-600',
                  yellow: 'text-yellow-600',
                  blue: 'text-blue-600',
                  green: 'text-green-600',
              };
              return React.createElement('div', { onClick, className: `bg-white p-4 rounded-lg shadow-md border border-slate-200 flex items-start ${onClick ? 'cursor-pointer hover:shadow-lg hover:border-primary' : ''}` },
                  React.createElement('div', { className: 'p-3 rounded-full mr-4 bg-primary-light' }, icon),
                  React.createElement('div', null,
                      React.createElement('div', { className: 'text-sm font-medium text-slate-500' }, title),
                      React.createElement('div', { className: `text-2xl font-bold ${colorClasses[color]}` }, value),
                      subValue && React.createElement('div', { className: 'text-xs text-slate-400' }, subValue)
                  )
              );
          };
          
          const KpiPage = function() { return React.createElement('div', { className: 'space-y-6' },
            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6' },
              React.createElement(KpiCard, { title: "Missing 2B Cum", value: formatCurrency(kpiData.missing2bCum), icon: React.createElement(Icons.DocumentMinusIcon, { className: "h-6 w-6 text-primary" }), color: 'red', onClick: function() { onKpiClick('Missing_2B_Cumulative') } }),
              React.createElement(KpiCard, { title: "Missing PR Cum", value: formatCurrency(kpiData.missingPrCum), icon: React.createElement(Icons.DocumentMinusIcon, { className: "h-6 w-6 text-primary" }), color: 'yellow', onClick: function() { onKpiClick('Missing_in_PR_Cumulative') } }),
              React.createElement(KpiCard, { title: "Missing 2B Claimed", value: formatCurrency(kpiData.missing2bClaimed), icon: React.createElement(Icons.CheckCircleIcon, { className: "h-6 w-6 text-primary" }), color: 'blue', onClick: function() { onKpiClick('Missing_2B_NowUploaded') } }),
              React.createElement(KpiCard, { title: "Missing PR Claimed", value: formatCurrency(kpiData.missingPrClaimed), icon: React.createElement(Icons.CheckCircleIcon, { className: "h-6 w-6 text-primary" }), color: 'blue' }),
              React.createElement(KpiCard, { title: "Total Recovered", value: formatCurrency(kpiData.totalRecovered), icon: React.createElement(Icons.CashIcon, { className: "h-6 w-6 text-primary" }), color: 'green' }),
              React.createElement(KpiCard, { title: "Success Rate", value: formatPercent(kpiData.successRate), icon: React.createElement(Icons.TrendingUpIcon, { className: "h-6 w-6 text-primary" }), color: 'green' })
            ),
            React.createElement('div', { className: 'bg-white p-4 sm:p-6 rounded-lg shadow-md border border-slate-200' },
              (!chartData.monthly || Object.keys(chartData.monthly.data.labels).length === 0) && (!chartData.byCategory || Object.keys(chartData.byCategory.data.labels).length === 0) ?
              React.createElement('p', { className: 'text-center text-slate-500 py-16' }, 'No data available to display charts for the current selection.')
              :
              React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-8 items-center' },
                  (chartData.monthly && Object.keys(chartData.monthly.data.labels).length > 0) && React.createElement('div', { className: 'w-full' }, React.createElement(ChartComponent, { chartConfig: chartData.monthly })),
                  (chartData.byCategory && Object.keys(chartData.byCategory.data.labels).length > 0) && React.createElement('div', { className: 'w-full max-h-80 flex justify-center' }, React.createElement(ChartComponent, { chartConfig: chartData.byCategory })),
                  (chartData.topSuppliers && Object.keys(chartData.topSuppliers.data.labels).length > 0) && React.createElement('div', { className: 'w-full lg:col-span-2' }, React.createElement(ChartComponent, { chartConfig: chartData.topSuppliers }))
              )
            )
          )};
          
          return React.createElement('div', { className: 'min-h-screen flex flex-col' },
              React.createElement(ThinkingModeModal, { 
                  isOpen: isThinkingModalOpen, 
                  onClose: function() { setIsThinkingModalOpen(false) },
                  contextData: filteredData
              }),
              React.createElement('div', { className: 'sticky top-0 z-20' },
                  React.createElement(Header, null),
                  React.createElement(Navigation, null)
              ),
              React.createElement('main', { className: 'flex-grow w-full max-w-screen-2xl mx-auto p-4 md:p-6' },
                  activeTab === 'KPIs' && React.createElement(KpiPage, null),
                  activeTab === 'Transactions' && React.createElement(TransactionsPage, { data: filteredData, actionState: actionState, updateAction: updateAction }),
                  activeTab === 'Suppliers' && React.createElement(SuppliersPage, { data: filteredData, assignmentState: assignmentState, updateAssignment: updateAssignment }),
                  activeTab === 'Mailing List' && React.createElement(MailingListPage, { data: filteredData, actionState: actionState, assignmentState: assignmentState, setPrintModalData: setPrintModalData }),
                  activeTab === 'Validate with Books' && React.createElement(ValidationPage, { allData: allData, validationBooks: validationBooks, onValidateWithBooks: onValidateWithBooks })
              ),
              React.createElement(Chatbot, { 
                  slicerOptions,
                  allData,
                  onFilterChange: function(newFilters) { 
                      setFilters(function(f) { 
                          const updated = {...f};
                          Object.keys(newFilters).forEach(function(key) {
                              updated[key] = newFilters[key];
                          });
                          return updated;
                      });
                  },
                  setPrintModalData: setPrintModalData
              })
          );
      };
      
      const MOCK_DATA = [
          {id: 'row_0', 'Company Name': 'Stark Industries', 'Supplier Name': 'Wayne Enterprises', 'Document Number (2B)': 'INV001', 'Document Date (2B)': '15-04-2023', 'Total GST': 18000, 'Sum of Taxable Value (2B)': 100000, Type: 'Missing_2B_Cumulative', 'Financial Year': '2023-24', Month: 'Apr', Remarks: ''},
          {id: 'row_1', 'Company Name': 'Stark Industries', 'Supplier Name': 'Cyberdyne Systems', 'Document Number (2B)': 'INV002', 'Document Date (2B)': '20-04-2023', 'Total GST': 9000, 'Sum of Taxable Value (2B)': 50000, Type: 'Missing_in_PR_Cumulative', 'Financial Year': '2023-24', Month: 'Apr', Remarks: 'Follow up needed'},
          {id: 'row_2', 'Company Name': 'Stark Industries', 'Supplier Name': 'Wayne Enterprises', 'Document Number (2B)': 'INV003', 'Document Date (2B)': '10-05-2023', 'Total GST': 27000, 'Sum of Taxable Value (2B)': 150000, Type: 'Missing_2B_Cumulative', 'Financial Year': '2023-24', Month: 'May', Remarks: ''},
          {id: 'row_3', 'Company Name': 'Stark Industries', 'Supplier Name': 'Wayne Enterprises', 'Document Number (2B)': 'INV004', 'Document Date (2B)': '18-05-2023', 'Total GST': 5000, 'Sum of Taxable Value (2B)': 27777, Type: 'Missing_2B_NowUploaded', 'Financial Year': '2023-24', Month: 'May', Remarks: 'Recovered'},
          {id: 'row_4', 'Company Name': 'Oscorp', 'Supplier Name': 'Stark Industries', 'Document Number (2B)': 'INV005', 'Document Date (2B)': '25-05-2023', 'Total GST': 12000, 'Sum of Taxable Value (2B)': 66666, Type: 'Missing_2B_Cumulative', 'Financial Year': '2023-24', Month: 'May', Remarks: ''},
          {id: 'row_5', 'Company Name': 'Oscorp', 'Supplier Name': 'Cyberdyne Systems', 'Document Number (2B)': 'INV006', 'Document Date (2B)': '05-06-2023', 'Total GST': 36000, 'Sum of Taxable Value (2B)': 200000, Type: 'Missing_in_PR_NowClaimed_Current', 'Financial Year': '2023-24', Month: 'Jun', Remarks: 'Claimed this month'},
          {id: 'row_6', 'Company Name': 'Oscorp', 'Supplier Name': 'Wayne Enterprises', 'Document Number (2B)': 'INV007', 'Document Date (2B)': '12-06-2023', 'Total GST': 15000, 'Sum of Taxable Value (2B)': 83333, Type: 'Missing_in_PR_Cumulative', 'Financial Year': '2023-24', Month: 'Jun', Remarks: ''},
          {id: 'row_7', 'Company Name': 'Stark Industries', 'Supplier Name': 'Tyrell Corporation', 'Document Number (2B)': 'INV008', 'Document Date (2B)': '22-07-2023', 'Total GST': 8000, 'Sum of Taxable Value (2B)': 44444, Type: 'Missing_2B_Cumulative', 'Financial Year': '2023-24', Month: 'Jul', Remarks: 'Invoice not clear'},
          {id: 'row_8', 'Company Name': 'Oscorp', 'Supplier Name': 'Tyrell Corporation', 'Document Number (2B)': 'INV009', 'Document Date (2B)': '30-07-2023', 'Total GST': 19000, 'Sum of Taxable Value (2B)': 105555, Type: 'Missing_2B_Cumulative', 'Financial Year': '2023-24', Month: 'Jul', Remarks: ''},
          {id: 'row_9', 'Company Name': 'Stark Industries', 'Supplier Name': 'Cyberdyne Systems', 'Document Number (2B)': 'INV010', 'Document Date (2B)': '14-08-2023', 'Total GST': 22000, 'Sum of Taxable Value (2B)': 122222, Type: 'Missing_in_PR_Cumulative', 'Financial Year': '2023-24', Month: 'Aug', Remarks: ''},
          {id: 'row_10', 'Company Name': 'Stark Industries', 'Supplier Name': 'Wayne Enterprises', 'Document Number (2B)': 'INV001', 'Document Date (2B)': '15-04-2023', 'Total GST': 18000, 'Sum of Taxable Value (2B)': 100000, Type: 'Missing_2B_Cumulative', 'Financial Year': '2023-24', Month: 'Apr', Remarks: ''},
      ];

      const App = function() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [view, setView] = useState('main_landing');
          const [isLoading, setIsLoading] = useState(false);
          const [statusMessage, setStatusMessage] = useState('');
          const [progress, setProgress] = useState(0);
          const [allData, setAllData] = useState([]);
          const [actionState, setActionState] = useState({});
          const [assignmentState, setAssignmentState] = useState({});
          const [validationBooks, setValidationBooks] = useState([]);
          const [slicerOptions, setSlicerOptions] = useState({ companies: [], financialYears: [], months: [], tags: [] });
          const [filters, setFilters] = useState({ company: [], financialYear: [], month: [], tag: [] });
          const [activeTab, setActiveTab] = useState('KPIs');
          const [printModalData, setPrintModalData] = useState({ isOpen: false, category: '', data: [] });
          
          const initializeData = useCallback(function(data, actions, assignments, books) {
              setAllData(data);
              setActionState(actions);
              setAssignmentState(assignments);
              setValidationBooks(books);
              if (data.length > 0) {
                  const companies = [...new Set(data.map(function(r) { return r['Company Name'] }))].sort();
                  const financialYears = [...new Set(data.map(function(r) { return r['Financial Year'] }))].sort().reverse();
                  const months = [...new Set(data.map(function(r) { return r['Month'] }))].sort(function(a,b) { return getMonthNumber(a) - getMonthNumber(b) });
                  const tags = [...new Set(data.map(function(r) { return r['Type'] }))].sort();
                  setSlicerOptions({ companies, financialYears, months, tags });
                  setFilters({ company: [], financialYear: [], month: [], tag: [] });
                  setView('dashboard');
              } else {
                  // This case should ideally not be hit if initialize is only called with data,
                  // but as a fallback, go to startup.
                  setView('startup');
              }
              setIsLoading(false);
          }, []);

          const handleNavigateToGst = function() {
              if (allData.length > 0) {
                  setView('dashboard');
              } else {
                  setView('startup');
              }
          };

          const handleNavigateToHome = function() {
              setView('main_landing');
          };
          
          const handleFileSelect = async function(file) {
              setIsLoading(true);
              setProgress(10);
              setStatusMessage('Starting upload...');
              try {
                  await new Promise(function(res) { return setTimeout(res, 200) });
                  
                  const onProgress = function(p, msg) {
                      setProgress(10 + p * 70);
                      setStatusMessage(msg || `Processing data... ${Math.round(p * 100)}%`);
                  };

                  const data = await fileProcessor.processMainFile(file, onProgress);
                  
                  setStatusMessage('Encrypting and saving data...');
                  setProgress(90);
                  await dbService.clearAllData();
                  await dbService.saveData(data, {}, {});

                  setStatusMessage('Success! Finalizing...');
                  setProgress(100);
                  
                  setTimeout(function() {
                      initializeData(data, {}, {}, []);
                  }, 500);
              } catch (error) {
                  const message = error instanceof Error ? error.message : "An unknown error occurred.";
                  setStatusMessage(`Error: ${message}`);
                  setIsLoading(false);
                  setProgress(0);
                  setView('startup');
              }
          };
          
          const handleLoadSaved = useCallback(async function() {
              setIsLoading(true);
              setProgress(0);
              setStatusMessage('Loading and decrypting data...');
              try {
                  const { transactions, actions, assignments } = await dbService.loadData();
                  const books = await dbService.loadAllValidationBooks();
                  if (transactions.length > 0) {
                      initializeData(transactions, actions, assignments, books);
                      setStatusMessage('');
                  } else {
                      setIsLoading(false);
                      setStatusMessage('No saved data found or session is invalid. Please upload a file.');
                      // Do not change view, stay on startup screen
                  }
              } catch (error) {
                  const message = error instanceof Error ? error.message : "An unknown error occurred.";
                  setStatusMessage(`Error loading data: ${message}`);
                  setIsLoading(false);
                  // Do not change view, stay on startup screen
              }
          }, [initializeData]);

          const handleLoadMockData = function() {
              const mockAssignments = { "Stark Industries|Wayne Enterprises": "Admin", "Oscorp|Cyberdyne Systems": "HR" };
              const mockActions = { 'row_1': { action: 'Follow up', remarks: 'Follow up needed'} };
              initializeData(MOCK_DATA, mockActions, mockAssignments, []);
          };

          const handleClearSaved = async function() {
              if (window.confirm("Are you sure you want to clear all saved data, including validation books?")) {
                  setIsLoading(true);
                  setProgress(0);
                  setStatusMessage('Clearing all data...');
                  try {
                      await dbService.clearAllData();
                  } catch (error) {
                      console.error("Failed to clear DB:", error);
                  }
                  setAllData([]); setActionState({}); setAssignmentState({}); setValidationBooks([]);
                  setSlicerOptions({ companies: [], financialYears: [], months: [], tags: [] });
                  setFilters({ company: [], financialYear: [], month: [], tag: [] });
                  setStatusMessage('Saved data cleared. Please upload a new file.');
                  setView('startup');
                  setIsLoading(false);
                  setProgress(0);
              }
          };
          
          useEffect(function() {
            if (sessionStorage.getItem('gst_dashboard_auth') === 'true') {
                setIsAuthenticated(true);
            }
          }, []);

          const FullScreenLoader = function({ message }) { return React.createElement('div', { className: "fixed inset-0 bg-slate-900/40 z-50 flex flex-col items-center justify-center backdrop-blur-sm" },
              React.createElement('div', { className: 'w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin' }),
              message && React.createElement('p', { className: 'mt-4 text-white font-medium' }, message)
          )};

          const updateAction = async function(id, value) {
              const newActionState = {...actionState, [id]: value};
              setActionState(newActionState);
              await dbService.saveData(allData, newActionState, assignmentState);
          };
          
          const updateAssignment = async function(key, category) {
              const newAssignmentState = {...assignmentState};
              if(category === 'None' || !category) {
                delete newAssignmentState[key];
              } else {
                newAssignmentState[key] = category;
              }
              setAssignmentState(newAssignmentState);
              await dbService.saveData(allData, actionState, newAssignmentState);
          };

          const handleKpiClick = function(tag) {
              setFilters(function(prev) { return { ...prev, tag: [tag] } });
              setActiveTab('Transactions');
          };

          const handleValidateWithBooks = async function(file) {
              setIsLoading(true);
              setStatusMessage('Validating with books file...');
              try {
                  const { companyName, data: bookData } = await fileProcessor.processBooksFile(file);
                  const getCol = function(row, candidates) {
                      for(const c of candidates) {
                          const key = Object.keys(row).find(function(k) { return k.trim().toLowerCase() === c.toLowerCase() });
                          if(key) return row[key];
                      }
                      return null;
                  }
                  const bookLookup = new Map();
                  bookData.forEach(function(row, i) {
                      const docNum = getCol(row, ['Voucher Ref. No.', 'Document Number']);
                      const gstin = getCol(row, ['GSTIN/UIN', 'GSTIN']);
                      if(docNum) {
                          const key = `${String(docNum).trim()}|${String(gstin || '').trim()}`;
                          bookLookup.set(key, {...row, id: `book_${i}`});
                      }
                  });
                  let updatedCount = 0;
                  const newActionState = { ...actionState };
                  const companyMainData = allData.filter(function(r) { return r['Company Name'] === companyName });
                  companyMainData.forEach(function(row) {
                      if(row['Type'].startsWith('Missing_in_PR')) {
                          const key = `${row['Document Number (2B)']}|${row['Supplier GSTIN (2B)'] || ''}`;
                          if (bookLookup.has(key)) {
                              const currentAction = newActionState[row.id];
                              const isAlreadyAccounted = typeof currentAction === 'string' ? currentAction === 'Accounted' : currentAction?.action === 'Accounted';
                              if (!isAlreadyAccounted) {
                                  newActionState[row.id] = { ...(typeof currentAction === 'object' ? currentAction : {}), action: 'Accounted' };
                                  updatedCount++;
                              }
                              bookLookup.delete(key); 
                          }
                      }
                  });
                  if (updatedCount > 0) {
                    setActionState(newActionState);
                    await dbService.saveData(allData, newActionState, assignmentState);
                  }
                  const newBook = { companyName, data: bookData };
                  await dbService.saveValidationBook(newBook);
                  setValidationBooks(function(prev) {
                      const otherBooks = prev.filter(function(b) { return b.companyName !== companyName });
                      return [...otherBooks, newBook];
                  });
                  alert(`Validation complete for ${companyName}. ${updatedCount} transactions were updated to "Accounted".`);
              } catch(error) {
                  alert(`Validation Error: ${error.message}`);
              } finally {
                  setIsLoading(false);
                  setStatusMessage('');
              }
          };

          if (!isAuthenticated) {
              return e(LoginPage, { onLoginSuccess: function() {
                  sessionStorage.setItem('gst_dashboard_auth', 'true');
                  setIsAuthenticated(true);
              } });
          }

          return React.createElement(Fragment, null,
              (isLoading && view === 'dashboard') && React.createElement(FullScreenLoader, { message: statusMessage }),
              React.createElement(PrintModal, { printModalData, setPrintModalData, actionState }),
              React.createElement('div', { style: { display: (isLoading && view === 'dashboard') ? 'none' : 'block' } },
                  view === 'main_landing' && React.createElement(MainLandingPage, { 
                      onNavigateToGst: handleNavigateToGst 
                  }),
                  view === 'startup' && React.createElement(StartupScreen, { 
                      onFileSelect: handleFileSelect, 
                      onLoadSaved: handleLoadSaved, 
                      onClearSaved: handleClearSaved, 
                      onLoadMockData: handleLoadMockData,
                      statusMessage,
                      isLoading,
                      progress,
                      onNavigateToHome: handleNavigateToHome,
                  }),
                  view === 'dashboard' && allData.length > 0 && 
                      React.createElement(Dashboard, { 
                          allData, 
                          slicerOptions, 
                          filters, 
                          setFilters, 
                          actionState, 
                          updateAction,
                          assignmentState, 
                          updateAssignment, 
                          clearAllData: handleClearSaved, 
                          onValidateWithBooks: handleValidateWithBooks,
                          validationBooks, 
                          activeTab, 
                          setActiveTab, 
                          onKpiClick: handleKpiClick,
                          setPrintModalData,
                          onNavigateToHome: handleNavigateToHome,
                      })
              )
          );
      };

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(
          React.createElement(StrictMode, null, 
              React.createElement(App, null)
          )
      );
    </script>
  </body>
</html>
