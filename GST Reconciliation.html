<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GST Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@google/generative-ai/dist/index.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: '#4F46E5', // Indigo 600
                hover: '#4338CA', // Indigo 700
                light: '#EEF2FF', // Indigo 50
                dark: '#312E81',  // Indigo 900
              },
              secondary: {
                DEFAULT: '#64748B', // Slate 500
                hover: '#475569', // Slate 600
              },
              success: '#10B981', // Emerald 500
              warning: '#F59E0B', // Amber 500
              danger: {
                DEFAULT: '#EF4444', // Red 500
                hover: '#DC2626', // Red 600
              }
            },
          },
        },
      }
    </script>
    <style>
      /* Global styles can go here. Print-specific styles are now handled by the controlledPrint function. */
    </style>
  </head>
  <body class="bg-indigo-50 dark:bg-slate-900 antialiased">
    <div id="root"></div>
    <script type="module">
// @ts-nocheck
const { useState, useEffect, useCallback, useMemo, useRef, StrictMode, Fragment } = React;
const e = React.createElement;

// --- Global declarations ---
// These are declared in the HTML head via CDN scripts
// declare var ReactDOM: any;
// declare var pdfjsLib: any;
// declare var XLSX: any;
// declare var Chart: any;

// --- From constants.ts ---
const DB_NAME = "GSTDashboardDB_React";
const STORE_TRANSACTIONS = "transactions";
const STORE_ACTIONS = "actions";
const STORE_ASSIGNMENTS = "assignments";
const STORE_VALIDATION_BOOKS = "validation_books";
const STORE_REPORTS = "reports"; // New store for the Reports Page
const DB_VERSION = 4; // Incremented DB version
const MAILING_LIST_CATEGORIES = [
  "Admin", "HR", "EA", "IT", "KS", "DC", "Investment", 
  "Manikant", "Neha", "Suresh", "Ashok"
];
const MONTH_MAP = {
  Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
  Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12
};
const ACTION_OPTIONS = [
  'None', 'Accounted', 'Not Accounted', 'Invoice Not Received',
  'Follow up', 'Followed up', 'No Response', 'Invoice Received'
];
const COMPANY_NAMES = [
  'MANJUSHREE SPNTEK PVT LTD', 'MANJUSHREE TECHNOPACK LTD', 'MANJUSHREE CLEANTECH PVT LTD',
  'MANJUSHREE INC', 'MANJUSHREE UK LTD'
];
const GSTIN_TO_COMPANY_MAP = {
    '29AANCM6884A1Z1': 'MANJUSHREE SPNTEK PVT LTD'
};


// --- From utils/helpers.ts ---
const formatCurrency = function(n, isShort = true) {
  if (typeof n !== 'number' || isNaN(n)) return isShort ? 'Rs. 0 K' : '0.00';
  if (!isShort) {
    return n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  if (Math.abs(n) >= 1e7) return `Rs. ${(n / 1e7).toFixed(2)} Cr`;
  if (Math.abs(n) >= 1e5) return `Rs. ${(n / 1e5).toFixed(2)} Lk`;
  if (Math.abs(n) >= 1e3) return `Rs. ${(n / 1e3).toFixed(2)} K`;
  return `Rs. ${n.toFixed(2)}`;
};
const formatCurrencyCr = (n) => {
  if (typeof n !== 'number' || isNaN(n)) return '0.0000';
  return (n / 1e7).toFixed(4);
};
const formatPercent = function(n) {
  if (typeof n !== 'number' || isNaN(n)) return '0.0 %';
  return `${n.toFixed(1)} %`;
};
const parseDateString = function(ds) {
  if (!ds) return null;
  if (ds instanceof Date) return ds;
  if (typeof ds === 'number') {
    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
    const dateObj = new Date(excelEpoch.getTime() + ds * 86400000);
    return !isNaN(dateObj.getTime()) ? dateObj : null;
  }
  if (typeof ds !== 'string') return null;
  // Handles YYYY-MM-DD
  const isoParts = ds.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (isoParts) {
      const year = parseInt(isoParts[1], 10);
      const month = parseInt(isoParts[2], 10) - 1;
      const day = parseInt(isoParts[3], 10);
      const date = new Date(Date.UTC(year, month, day));
        if (!isNaN(date.getTime())) return date;
  }
  // Handles DD-MM-YYYY or DD/MM/YYYY
  const parts = ds.match(/(\d{1,2})[/-](\d{1,2})[/-](\d{4})/);
  if (parts) {
    const day = parseInt(parts[1], 10);
    const month = parseInt(parts[2], 10) - 1;
    const year = parseInt(parts[3], 10);
    const date = new Date(year, month, day);
    if (!isNaN(date.getTime()) && date.getDate() === day) return date;
  }
  const nativeDate = new Date(ds);
  return !isNaN(nativeDate.getTime()) ? nativeDate : null;
};
const getFinancialYear = function(date) {
  const year = date.getFullYear();
  const month = date.getMonth();
  return month >= 3 ? `${year}-${String(year + 1).slice(-2)}` : `${year - 1}-${String(year).slice(-2)}`;
};
const getMonthNumber = function(monthName) {
    if (typeof monthName !== 'string') return 0;
    const namePart = monthName.substring(0, 3);
    return MONTH_MAP[namePart] || 0;
};
const checkFilingDelay = (fileDateStr, monthStr, dueDay) => {
  const fileDate = parseDateString(fileDateStr);
  if (!fileDate || typeof monthStr !== 'string') return false;
  
  const [monthName, year] = monthStr.split("-");
  const monthIndex = Object.keys(MONTH_MAP).findIndex(m => m.toLowerCase() === monthName.toLowerCase());

  if (monthIndex === -1 || !year) return false;

  const reportDate = new Date(parseInt(year, 10), monthIndex, 1);
  reportDate.setMonth(reportDate.getMonth() + 1); // Move to subsequent month
  const dueDate = new Date(reportDate.getFullYear(), reportDate.getMonth(), dueDay);
  dueDate.setHours(23, 59, 59, 999); // Compare against end of day

  return fileDate > dueDate;
};
function exportToCsv(data, filename) {
    if (!data || data.length === 0) {
        alert("No data to export.");
        return;
    }
    const headers = Object.keys(data[0]);
    const csvRows = [headers.join(',')];
    for (const row of data) {
        const values = headers.map(function(header) {
            const escaped = ('' + (row[header] === null || row[header] === undefined ? '' : row[header])).replace(/"/g, '""');
            return `"${escaped}"`;
        });
        csvRows.push(values.join(','));
    }
    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `${filename}_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
function controlledPrint(elementId, title) {
    const printContent = document.getElementById(elementId)?.outerHTML;
    if (!printContent) {
        console.error(`Element with ID "${elementId}" not found for printing.`);
        alert("Could not find content to print.");
        return;
    }
    const today = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
    const printWindow = window.open('', '', 'height=600,width=800');
    
    printWindow.document.write('<html><head><title>' + title + '</title>');
    
    printWindow.document.write('<style>');
    printWindow.document.write(`
        @media print {
          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
        body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; font-size: 9pt; color: #333; }
        .print-container { padding: 20px; }
        h3 { font-size: 16pt; margin-bottom: 5px; border-bottom: 2px solid #4F46E5; padding-bottom: 5px; color: #312E81; }
        p { font-size: 10pt; color: #666; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; page-break-inside: auto; }
        thead { display: table-header-group; }
        tbody { display: table-row-group; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; }
        th { background-color: #EEF2FF !important; font-weight: 600; color: #312E81; }
        tbody tr:nth-child(even) { background-color: #f9fafb !important; }
        .text-right { text-align: right; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .small { font-size: 0.8rem; color: #555; }
        .reportHeader { margin-bottom: 20px; }
        .text-center { text-align: center; }
        @page { size: A4 landscape; margin: 1cm; }
    `);
    printWindow.document.write('</style></head><body>');
    
    printWindow.document.write('<div class="print-container">');
    printWindow.document.write(printContent);
    
    printWindow.document.write('</div></body></html>');
    printWindow.document.close();
    
    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();
    }
}

// --- From services/cryptoService.ts ---
const cryptoService = (function() {
    let sessionKey = null;
    const KEY_STORAGE_ID = 'gstDashboardCryptoKey';

    const getKey = async function() {
        if (sessionKey) return sessionKey;

        const storedKey = sessionStorage.getItem(KEY_STORAGE_ID);
        if (storedKey) {
            try {
                const jwk = JSON.parse(storedKey);
                sessionKey = await window.crypto.subtle.importKey(
                    "jwk",
                    jwk,
                    { name: "AES-GCM" },
                    true, // allow exporting
                    ["encrypt", "decrypt"]
                );
                return sessionKey;
            } catch (e) {
                console.error("Failed to import stored key, will generate a new one.", e);
                sessionStorage.removeItem(KEY_STORAGE_ID);
            }
        }

        const newKey = await window.crypto.subtle.generateKey(
            { name: "AES-GCM", length: 256 },
            true, // make it exportable
            ["encrypt", "decrypt"]
        );

        const jwk = await window.crypto.subtle.exportKey("jwk", newKey);
        sessionStorage.setItem(KEY_STORAGE_ID, JSON.stringify(jwk));
        sessionKey = newKey;
        return newKey;
    };
    
    const arrayBufferToBase64 = function(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    };

    const base64ToArrayBuffer = function(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    };

    return {
        encrypt: async function(data) {
            if (data === null || data === undefined) return null;
            try {
                const key = await getKey();
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const jsonString = JSON.stringify(data);
                const encodedData = new TextEncoder().encode(jsonString);

                const encryptedContent = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encodedData
                );
                
                const combinedBuffer = new Uint8Array(iv.length + encryptedContent.byteLength);
                combinedBuffer.set(iv, 0);
                combinedBuffer.set(new Uint8Array(encryptedContent), iv.length);

                return arrayBufferToBase64(combinedBuffer.buffer);
            } catch (error) {
                console.error("Encryption failed:", error);
                throw new Error("Could not encrypt data.");
            }
        },
        decrypt: async function(encryptedBase64) {
            if (encryptedBase64 === null || encryptedBase64 === undefined) return null;
            try {
                const key = await getKey();
                const combinedBuffer = base64ToArrayBuffer(encryptedBase64);
                
                const iv = combinedBuffer.slice(0, 12);
                const encryptedContent = combinedBuffer.slice(12);
                
                const decryptedContent = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encryptedContent
                );

                const decodedData = new TextDecoder().decode(decryptedContent);
                return JSON.parse(decodedData);
            } catch (error) {
                console.error("Decryption failed:", error);
                throw new Error("Could not decrypt data. Session key might be invalid or data is corrupt.");
            }
        }
    };
})();

// --- From services/dbService.ts ---
const dbService = (function() {
    let db;
    const openDB = function() {
      return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = function(event) {
          const dbHandle = event.target.result;
          if (!dbHandle.objectStoreNames.contains(STORE_TRANSACTIONS)) {
            dbHandle.createObjectStore(STORE_TRANSACTIONS, { keyPath: 'id' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_ACTIONS)) {
            dbHandle.createObjectStore(STORE_ACTIONS, { keyPath: 'id' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_ASSIGNMENTS)) {
            dbHandle.createObjectStore(STORE_ASSIGNMENTS, { keyPath: 'key' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_VALIDATION_BOOKS)) {
            dbHandle.createObjectStore(STORE_VALIDATION_BOOKS, { keyPath: 'companyName' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_REPORTS)) {
            dbHandle.createObjectStore(STORE_REPORTS, { keyPath: 'id' });
          }
        };
        request.onsuccess = function(event) {
          db = event.target.result;
          resolve(db);
        };
        request.onerror = function(event) {
          console.error("IndexedDB error:", event.target.error);
          reject(event.target.error);
        };
      });
    };
    const getStore = function(storeName, mode) {
      const transaction = db.transaction(storeName, mode);
      return transaction.objectStore(storeName);
    };
    return {
        saveData: async function(transactions, actions, assignments, reports) {
          await openDB();
          const tx = db.transaction([STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS, STORE_REPORTS], 'readwrite');
          const txStore = tx.objectStore(STORE_TRANSACTIONS);
          const actStore = tx.objectStore(STORE_ACTIONS);
          const assStore = tx.objectStore(STORE_ASSIGNMENTS);
          const reportsStore = tx.objectStore(STORE_REPORTS);

          const [encryptedTxs, encryptedActs, encryptedAss, encryptedReports] = await Promise.all([
              cryptoService.encrypt(transactions),
              cryptoService.encrypt(actions),
              cryptoService.encrypt(assignments),
              cryptoService.encrypt(reports)
          ]);

          txStore.clear();
          actStore.clear();
          assStore.clear();
          reportsStore.clear();
          
          if (encryptedTxs) txStore.put({ id: 'encrypted_data', data: encryptedTxs });
          if (encryptedActs) actStore.put({ id: 'encrypted_actions', data: encryptedActs });
          if (encryptedAss) assStore.put({ key: 'encrypted_assignments', data: encryptedAss });
          if (encryptedReports) reportsStore.put({ id: 'encrypted_reports', data: encryptedReports });

          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve() ;
            tx.onerror = () => reject(tx.error);
          });
        },
        loadData: async function() {
          await openDB();
          const tx = db.transaction([STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS, STORE_REPORTS], 'readonly');
          const txStore = tx.objectStore(STORE_TRANSACTIONS);
          const actStore = tx.objectStore(STORE_ACTIONS);
          const assStore = tx.objectStore(STORE_ASSIGNMENTS);
          const reportsStore = tx.objectStore(STORE_REPORTS);

          const txRequest = txStore.get('encrypted_data');
          const actRequest = actStore.get('encrypted_actions');
          const assRequest = assStore.get('encrypted_assignments');
          const reportsRequest = reportsStore.get('encrypted_reports');

          return new Promise((resolve, reject) => {
            tx.oncomplete = async function() {
                try {
                    const encryptedTxs = txRequest.result?.data;
                    const encryptedActs = actRequest.result?.data;
                    const encryptedAss = assRequest.result?.data;
                    const encryptedReports = reportsRequest.result?.data;
                    
                    const [transactions, actions, assignments, reports] = await Promise.all([
                        encryptedTxs ? cryptoService.decrypt(encryptedTxs) : Promise.resolve([]),
                        encryptedActs ? cryptoService.decrypt(encryptedActs) : Promise.resolve({}),
                        encryptedAss ? cryptoService.decrypt(encryptedAss) : Promise.resolve({}),
                        encryptedReports ? cryptoService.decrypt(encryptedReports) : Promise.resolve([])
                    ]);

                    resolve({ transactions, actions, assignments, reports });
                } catch(e) {
                    console.error("Failed to load and decrypt data. A new session may require a file upload.", e);
                    resolve({ transactions: [], actions: {}, assignments: {}, reports: [] });
                }
            };
            tx.onerror = () => reject(tx.error);
          });
        },
        saveValidationBook: async function(book) {
            await openDB();
            const encryptedData = await cryptoService.encrypt(book.data);
            getStore(STORE_VALIDATION_BOOKS, 'readwrite').put({ companyName: book.companyName, data: encryptedData });
        },
        loadAllValidationBooks: async function() {
            await openDB();
            const request = getStore(STORE_VALIDATION_BOOKS, 'readonly').getAll();
            return new Promise((resolve, reject) => {
                request.onsuccess = async function() {
                    try {
                        const encryptedRecords = request.result;
                        if (!encryptedRecords || encryptedRecords.length === 0) {
                            return resolve([]);
                        }
                        const decryptedBooks = await Promise.all(
                            encryptedRecords.map(async function(record) {
                                const decryptedData = await cryptoService.decrypt(record.data);
                                return { companyName: record.companyName, data: decryptedData };
                            })
                        );
                        resolve(decryptedBooks);
                    } catch (e) {
                        console.error("Failed to decrypt validation books", e);
                        resolve([]);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        },
        clearAllData: async function() {
          await openDB();
          const storesToClear = [STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS, STORE_VALIDATION_BOOKS, STORE_REPORTS];
          const tx = db.transaction(storesToClear, 'readwrite');
          storesToClear.forEach(store => tx.objectStore(store).clear());
        }
    };
})();

const fileProcessorWorkerScript = `
  importScripts("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js");
  
  // Helper functions required by the worker
  const MONTH_MAP = { Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6, Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12 };
  
  const parseCurrency = (v) => {
      if (typeof v === 'number') return v;
      if (typeof v !== 'string') return 0;
      const c = v.replace(/[^0-9.-]+/g, "");
      const n = parseFloat(c);
      return isNaN(n) ? 0 : n;
  };
  
  const parseDateString = (ds) => {
      if (!ds) return null;
      if (typeof ds === 'number') {
        const excelEpoch = new Date(Date.UTC(1899, 11, 30));
        const dateObj = new Date(excelEpoch.getTime() + ds * 86400000);
        return !isNaN(dateObj.getTime()) ? dateObj : null;
      }
      if (typeof ds !== 'string') return null;
      const parts = ds.match(/(\\d{1,2})[/-](\\d{1,2})[/-](\\d{4})/);
      if (parts) {
        const day = parseInt(parts[1], 10);
        const month = parseInt(parts[2], 10) - 1;
        const year = parseInt(parts[3], 10);
        const date = new Date(year, month, day);
        if (!isNaN(date.getTime()) && date.getDate() === day) return date;
      }
      const nativeDate = new Date(ds);
      return !isNaN(nativeDate.getTime()) ? nativeDate : null;
  };

  const getFinancialYear = (date) => {
      const year = date.getFullYear();
      const month = date.getMonth();
      return month >= 3 ? \\\`\${year}-\${String(year + 1).slice(-2)}\\\` : \\\`\${year - 1}-\${String(year).slice(-2)}\\\`;
  };
  
  self.onmessage = (event) => {
      const file = event.data;
      const reader = new FileReader();
      reader.onload = (e) => {
          try {
              if (!e.target?.result) throw new Error("File content is empty.");
              
              self.postMessage({ type: 'progress', payload: { progress: 0.1, message: 'Reading file contents...' } });
              
              const data = new Uint8Array(e.target.result);
              self.postMessage({ type: 'progress', payload: { progress: 0.2, message: 'Parsing Excel workbook...' } });
              const workbook = XLSX.read(data, { type: 'array', cellDates: true });
              
              const sheetName = 'Transactions';
              if (!workbook.SheetNames.includes(sheetName)) {
                throw new Error(\\\`Sheet "\${sheetName}" not found in the Excel file.\\\`);
              }
              const worksheet = workbook.Sheets[sheetName];
              
              self.postMessage({ type: 'progress', payload: { progress: 0.4, message: 'Converting sheet to JSON...' } });
              const rawData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
              
              if (!Array.isArray(rawData) || rawData.length === 0) {
                throw new Error("No data found in the 'Transactions' sheet.");
              }
              
              const processedData = [];
              const totalRows = rawData.length;

              for (let i = 0; i < totalRows; i++) {
                const row = rawData[i];
                if (typeof row !== 'object' || row === null) continue;
                const newRow = { id: \\\`row_\${i}\\\` };
                Object.keys(row).forEach((key) => {
                    if (key && !key.startsWith('__EMPTY')) {
                        newRow[key.trim()] = typeof row[key] === 'string' ? row[key].trim() : row[key];
                    }
                });
                newRow['Type'] = String(newRow['Type'] ?? newRow['Tag (Type)'] ?? "");
                newRow['Sum of Taxable Value (2B)'] = parseCurrency(newRow['Sum of Taxable Value (2B)']);
                newRow['Sum of IGST (2B)'] = parseCurrency(newRow['Sum of IGST (2B)']);
                newRow['Sum of CGST (2B)'] = parseCurrency(newRow['Sum of CGST (2B)']);
                newRow['Sum of SGST (2B)'] = parseCurrency(newRow['Sum of SGST (2B)']);
                newRow['Total GST'] = (newRow['Sum of IGST (2B)'] ?? 0) + (newRow['Sum of CGST (2B)'] ?? 0) + (newRow['Sum of SGST (2B)'] ?? 0);
                const docDateObj = parseDateString(newRow['Document Date (2B)']);
                if (docDateObj) {
                    newRow['Document Date (2B)'] = docDateObj.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\\//g, '-');
                    newRow['Financial Year'] = getFinancialYear(docDateObj);
                } else {
                    newRow['Document Date (2B)'] = '';
                    newRow['Financial Year'] = 'Unknown';
                }
                const remarksKey = Object.keys(newRow).find((k) => k.toLowerCase() === 'remarks' || k.toLowerCase() === 'remark');
                newRow['Remarks'] = String((remarksKey ? newRow[remarksKey] : '') ?? '');
                newRow['Supplier Name'] = String(newRow['Supplier Name'] ?? 'Unknown');
                newRow['Document Number (2B)'] = String(newRow['Document Number (2B)'] ?? '');
                newRow['Company Name'] = String(newRow['Company Name'] ?? 'Unknown');
                newRow['Month'] = String(newRow['Month'] ?? 'Unknown');
                processedData.push(newRow);

                if (i % 200 === 0) {
                    const progress = i / totalRows;
                    self.postMessage({ type: 'progress', payload: { progress: 0.5 + progress * 0.5, message: 'Processing rows... ' + i + ' / ' + totalRows } });
                }
              }
              
              self.postMessage({ type: 'result', payload: processedData });
          } catch (error) {
              self.postMessage({ type: 'error', payload: error.message });
          }
      };
      reader.readAsArrayBuffer(file);
  };
`;

// --- From services/fileProcessor.ts ---
const fileProcessor = (function() {
    const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    
    // Position-aware parsing engine
    const getTextWithPositions = async (page) => {
        const textContent = await page.getTextContent();
        return textContent.items.map(item => ({
            text: item.str.trim(),
            x: item.transform[4],
            y: item.transform[5],
            width: item.width,
            height: item.height,
        })).filter(item => item.text);
    };

    const groupItemsToLines = (items, yTolerance = 2) => {
        if (!items || items.length === 0) return [];
        const sortedItems = [...items].sort((a, b) => a.y - b.y || a.x - b.x);
        const lines = [];
        let currentLine = [sortedItems[0]];
        for (let i = 1; i < sortedItems.length; i++) {
            const currentItem = sortedItems[i];
            const prevItem = currentLine[currentLine.length - 1];
            if (Math.abs(currentItem.y - prevItem.y) < yTolerance) {
                currentLine.push(currentItem);
            } else {
                lines.push(currentLine.sort((a,b) => a.x - b.x));
                currentLine = [currentItem];
            }
        }
        lines.push(currentLine.sort((a,b) => a.x - b.x));
        return lines;
    };
    
    const findLineWithText = (lines, regex) => lines.find(line => line.some(item => regex.test(item.text)));
    const getLineText = (line) => line ? line.map(item => item.text).join(' ') : '';
    
    const parseNumber = (text) => {
        if (typeof text !== 'string' || text.toLowerCase() === 'nil' || text === '-') return 0;
        const cleaned = text.replace(/,/g, '');
        const num = parseFloat(cleaned);
        return isNaN(num) ? 0 : num;
    };
    
    const findValuesOnLine = (line, anchorX, count = 3) => {
        if (!line) return [];
        return line
            .filter(item => item.x > anchorX && !isNaN(parseNumber(item.text)))
            .slice(0, count)
            .map(item => parseNumber(item.text));
    };

    const extractGstin = (lines) => {
        for (const line of lines) {
            const lineText = getLineText(line);
            const match = lineText.match(/([0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1})/i);
            if (match && match[0]) {
                return match[0].toUpperCase();
            }
        }
        return null;
    };

    const extractPeriodAndYearFrom3B = (lines) => {
        const periodLine = findLineWithText(lines, /Period/i);
        const yearLine = findLineWithText(lines, /Year/i);
        if (!periodLine || !yearLine) return null;

        const monthText = periodLine[periodLine.length - 1]?.text;
        const yearText = yearLine[yearLine.length - 1]?.text;
        if (!monthText || !yearText) return null;

        const monthMatch = monthText.match(/(January|February|March|April|May|June|July|August|September|October|November|December)/i);
        if (!monthMatch) return null;
        
        const monthName = monthMatch[0].substring(0, 3);
        const monthNum = MONTH_MAP[monthName];
        
        const yearMatch = yearText.match(/(\d{4})-(\d{2,4})/);
        let year;
        if (yearMatch) {
            const startYear = parseInt(yearMatch[1], 10);
            year = monthNum >= 4 ? startYear : startYear + 1;
        } else if (yearText.match(/^\d{4}$/)) {
            year = parseInt(yearText, 10);
        } else {
            return null;
        }
        return `${monthName}-${year}`;
    };

    const extractPeriodAndYearFrom1 = (lines) => {
        const periodLine = findLineWithText(lines, /Tax period/i);
        const yearLine = findLineWithText(lines, /Financial year/i);
        if (!periodLine || !yearLine || periodLine.length < 2 || yearLine.length < 2) return null;

        const monthText = periodLine[periodLine.length - 1].text;
        const yearText = yearLine[yearLine.length - 1].text;

        const monthMatch = monthText.match(/(January|February|March|April|May|June|July|August|September|October|November|December)/i);
        const yearMatch = yearText.match(/(\d{4})-(\d{2,4})/);
        if(monthMatch && yearMatch) {
            const monthName = monthMatch[0].substring(0, 3);
            const monthNum = MONTH_MAP[monthName];
            const startYear = parseInt(yearMatch[1], 10);
            const year = monthNum >= 4 ? startYear : startYear + 1;
            return `${monthName}-${year}`;
        }
        return null;
    };

    const extractGstr3bData = (lines) => {
        let data = { type: 'GSTR3B', itcAvailed: 0, taxLiability: 0, companyName: '', month: '', gstr3bFiledOn: '' };
        
        const nameAnchor = findLineWithText(lines, /Legal name of the registered person/i);
        if (nameAnchor) data.companyName = getLineText(nameAnchor).replace(/Legal name of the registered person/i, '').trim();

        data.month = extractPeriodAndYearFrom3B(lines);
        
        const arnDateAnchor = findLineWithText(lines, /Date of ARN/i);
        if(arnDateAnchor && arnDateAnchor.length > 1) {
            const dateText = arnDateAnchor[arnDateAnchor.length-1].text;
             if (dateText && /\d{2}[/-]\d{2}[/-]\d{4}/.test(dateText)) {
                const parsedDate = parseDateString(dateText);
                if (parsedDate) data.gstr3bFiledOn = parsedDate.toISOString().split('T')[0];
            }
        }
        
        const liabilityAnchorLine = findLineWithText(lines, /\(a\) Outward taxable supplies/i);
        if (liabilityAnchorLine) {
            const anchor = liabilityAnchorLine.find(item => /\(a\) Outward taxable supplies/i.test(item.text));
            const taxValues = findValuesOnLine(liabilityAnchorLine, anchor.x, 3);
            if(taxValues.length === 3) {
                 data.taxLiability = -(taxValues[0] + taxValues[1] + taxValues[2]);
            }
        }
        
        const itcAnchorLine = findLineWithText(lines, /C\. Net ITC available \(A-B\)/i);
        if (itcAnchorLine) {
            const anchor = itcAnchorLine.find(item => /C\. Net ITC available \(A-B\)/i.test(item.text));
            const itcValues = findValuesOnLine(itcAnchorLine, anchor.x, 3);
            if(itcValues.length === 3) {
                 data.itcAvailed = itcValues[0] + itcValues[1] + itcValues[2];
            }
        }
        return data;
    };

    const extractGstr1Data = (lines) => {
        let data = { type: 'GSTR1', companyName: '', month: '', gstr1FiledOn: '' };
        
        const nameAnchor = findLineWithText(lines, /Legal name of the registered person/i);
        if (nameAnchor) data.companyName = getLineText(nameAnchor).replace(/Legal name of the registered person/i, '').trim();

        data.month = extractPeriodAndYearFrom1(lines);
        
        const arnDateAnchor = findLineWithText(lines, /ARN date/i);
        if(arnDateAnchor && arnDateAnchor.length > 1) {
            const dateText = arnDateAnchor[arnDateAnchor.length-1].text;
             if (dateText && /\d{2}[/-]\d{2}[/-]\d{4}/.test(dateText)) {
                const parsedDate = parseDateString(dateText);
                if (parsedDate) data.gstr1FiledOn = parsedDate.toISOString().split('T')[0];
            }
        }
        return data;
    };

    const processSinglePdf = async (file) => {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let allItemsWithPos = [];
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const pageItems = await getTextWithPositions(page);
            allItemsWithPos.push(...pageItems);
        }

        const lines = groupItemsToLines(allItemsWithPos);
        const gstin = extractGstin(lines);

        let extractedData = {};
        const fullText = allItemsWithPos.map(i => i.text).join(' ');

        if (fullText.includes('GSTR-3B')) {
            extractedData = extractGstr3bData(lines);
        } else if (fullText.includes('GSTR-1')) {
            extractedData = extractGstr1Data(lines);
        } else {
            throw new Error(`Could not determine if file is GSTR-1 or GSTR-3B: ${file.name}`);
        }

        // Fallback for month/year from filename
        if (!extractedData.month) {
            const match = file.name.match(/_(\d{2})(\d{4})\.pdf$/i);
            if (match && match[1] && match[2]) {
                const monthIndex = parseInt(match[1], 10) - 1;
                const year = parseInt(match[2], 10);
                if (monthIndex >= 0 && monthIndex < 12 && year > 1900 && year < 2100) {
                    extractedData.month = `${MONTH_NAMES[monthIndex]}-${year}`;
                }
            }
        }

        // Fallback for company name from GSTIN
        if (!extractedData.companyName && gstin && GSTIN_TO_COMPANY_MAP[gstin]) {
            extractedData.companyName = GSTIN_TO_COMPANY_MAP[gstin];
        }

        if (!extractedData.month) {
            throw new Error(`Could not extract month/year from PDF or filename: ${file.name}`);
        }
        if (!extractedData.companyName) {
            throw new Error(`Could not extract company name from PDF or filename: ${file.name}`);
        }

        return extractedData;
    };


    return {
        processMainFile: function(file, onProgress) {
          return new Promise((resolve, reject) => {
            const workerBlob = new Blob([fileProcessorWorkerScript], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);
            const worker = new Worker(workerUrl);
            
            worker.onmessage = function(e) {
                const { type, payload } = e.data;
                if (type === 'progress') {
                    onProgress(payload.progress, payload.message);
                } else if (type === 'result') {
                    resolve(payload);
                    worker.terminate();
                    URL.revokeObjectURL(workerUrl);
                } else if (type === 'error') {
                    reject(new Error(payload));
                    worker.terminate();
                    URL.revokeObjectURL(workerUrl);
                }
            };

            worker.onerror = function(e) {
                reject(new Error(`Worker error: ${e.message}`));
                worker.terminate();
                URL.revokeObjectURL(workerUrl);
            };

            worker.postMessage(file);
          });
        },
        processBooksFile: function(file) {
            return new Promise((resolve, reject) => {
                const companyNameMatch = file.name.match(/Books_([^_]+)\.xlsx?/i);
                if (!companyNameMatch || !companyNameMatch[1]) {
                    return reject(new Error("Books filename must be in the format 'Books_CompanyName.xlsx'"));
                }
                const companyName = companyNameMatch[1].replace(/_/g, ' ');
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (!e.target?.result || !(e.target.result instanceof ArrayBuffer)) return reject(new Error("File content is empty or not an ArrayBuffer."));
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        if (!sheetName) return reject(new Error("No sheets found in Books file."));
                        const worksheet = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {raw: false, defval: null});
                        if (!Array.isArray(rawData) || rawData.length === 0) {
                            return reject(new Error(`No data found in '${sheetName}' sheet.`));
                        }
                        resolve({ companyName, data: rawData });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        },
        processGstrPdfs: async function(files, onProgress) {
            let results = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                onProgress((i + 1) / files.length, `Processing file ${i + 1} of ${files.length}: ${file.name}`);
                try {
                    const data = await processSinglePdf(file);
                    results.push(data);
                } catch (e) {
                    console.error(`Skipping file ${file.name} due to error:`, e.message);
                    // Optionally, collect errors to show to the user
                }
            }
            return results;
        }
    };
})();

// --- From services/geminiService.ts ---
const geminiService = (function() {
    let ai;
    try {
        if (typeof process !== 'undefined' && process.env && process.env.API_KEY && window.genai) {
            ai = new window.genai.GoogleGenAI({ apiKey: process.env.API_KEY });
        }
    } catch (e) {
        console.error("Gemini AI could not be initialized. API_KEY might be missing.", e);
    }

    const getFilterFromQueryOffline = async function(query, options) {
        const lowerQuery = query.toLowerCase();
        const response = { action: 'unknown' };
        response.action = 'filter';
        const foundFilters = [];
        if (options.companies) {
            options.companies.forEach(function(c) {
                if (lowerQuery.includes(c.toLowerCase())) {
                    response.company = [c];
                    foundFilters.push(c);
                }
            });
        }
        if (options.months) {
            options.months.forEach(function(m) {
                if (lowerQuery.includes(m.toLowerCase())) {
                    response.month = [m];
                    foundFilters.push(m);
                }
            });
        }
        if(options.tags) {
          options.tags.forEach(function(t) {
              if (lowerQuery.includes(t.replace(/_/g, ' ').toLowerCase())) {
                  response.tag = [t];
                  foundFilters.push(t);
              }
          });
        }
        if (foundFilters.length > 0) {
            response.matchedText = foundFilters.join(', ');
        } else {
            response.action = 'unknown';
            response.matchedText = "Sorry, I couldn't find any matching filters for that.";
        }
        return response;
    };

    return {
        isAvailable: function() { return !!ai },
        getFilterFromQuery: async function(query, options) {
            if (!this.isAvailable()) {
                console.warn("Gemini not available, using offline filter logic.");
                return getFilterFromQueryOffline(query, options);
            }

            const systemInstruction = `You are an intelligent assistant for a GST dashboard. Your task is to interpret the user's natural language query and translate it into a JSON object for filtering data. Respond ONLY with a valid JSON object and nothing else.
The JSON object should have an 'action' key, which can be 'filter' or 'details'.
If the action is 'filter', include one or more of the following keys: 'company', 'financialYear', 'month', 'tag'. The values for these keys must be an array of strings, and each string must be one of the provided options.
If the user asks for details about a specific supplier, set 'action' to 'details' and add a 'supplier' key with the supplier's name as a string.
If you cannot determine any filters or actions, return an empty JSON object {}.
If multiple values for a filter are mentioned (e.g. "show Stark and Oscorp"), include both in the array.`;
            
            const userPrompt = `User query: "${query}"\n\nAvailable filter options:\n- Companies: ${JSON.stringify(options.companies)}\n- Financial Years: ${JSON.stringify(options.financialYears)}\n- Months: ${JSON.stringify(options.months)}\n- Tags: ${JSON.stringify(options.tags)}`;

            try {
              const response = await ai.models.generateContent({
                  model: 'gemini-2.5-flash',
                  contents: userPrompt,
                  config: {
                    systemInstruction: systemInstruction,
                    responseMimeType: "application/json",
                  }
              });
              const parsedJson = JSON.parse(response.text);
              if (parsedJson.action === 'filter') {
                  const matched = Object.values(parsedJson).flat().join(', ');
                  parsedJson.matchedText = matched || "filters cleared";
              } else if (parsedJson.action === 'details') {
                  parsedJson.matchedText = `details for ${parsedJson.supplier}`;
              }
              return parsedJson;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return { action: 'unknown', matchedText: "Sorry, I had trouble understanding that." };
            }
        },
        getAnalysis: async function(prompt, contextData) {
            if (!this.isAvailable()) {
                return "AI analysis is not available. Please ensure your API_KEY is configured.";
            }

            const fullPrompt = `Based on the following sample of GST transaction data, please provide a concise analysis answering the user's question. Format your response using markdown.\n\nData Sample (up to 25 rows):\n\`\`\`json\n${JSON.stringify(contextData.slice(0, 25), null, 2)}\n\`\`\`\n\nUser's Question: ${prompt}`;
            
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-pro',
                    contents: fullPrompt,
                    config: {
                      thinkingConfig: { thinkingBudget: 32768 }
                    }
                });
                return response.text;
            } catch (error) {
                console.error("Error in AI analysis:", error);
                return `An error occurred while generating the analysis: ${error.message}`;
            }
        }
    };
})();


// --- React Components ---
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
  componentDidCatch(error, errorInfo) {
    console.error("ErrorBoundary caught an error:", error, errorInfo);
  }
  render() {
    if (this.state.hasError) {
      return e('div', { className: 'bg-red-100 dark:bg-red-900/20 border border-red-400 dark:border-red-500/30 text-red-700 dark:text-red-300 px-4 py-3 rounded relative text-sm' },
        e('strong', { className: 'font-bold' }, 'Something went wrong. '),
        e('span', { className: 'block sm:inline' }, this.props.message || 'This component could not be loaded.')
      );
    }
    return this.props.children;
  }
}

const SvgIcon = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: 2 }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));
const SvgIconThick = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: 3 }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));
const SvgIconUpDown = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));
const SvgIconUpDownCompact = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", strokeWidth: 2.5, stroke: "currentColor" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));

const Icons = {
    BriefcaseIcon: ({ className }) => e(SvgIcon, { className, d: "M20.25 14.15v4.004a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75v-4.004M18 9.348a2.25 2.25 0 00-2.25-2.25h-1.25A2.25 2.25 0 0012 9.348V11.25h6V9.348zM12 9.348a2.25 2.25 0 01-2.25-2.25h-1.25A2.25 2.25 0 016 9.348V11.25h6V9.348z" }),
    ShieldIcon: ({ className }) => e(SvgIcon, { className, d: "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5L12 1z" }),
    FileUploadIcon: ({ className }) => e(SvgIcon, { className, d: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" }),
    DatabaseIcon: ({ className }) => e(SvgIcon, { className, d: "M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7a8 8 0 0116 0M12 11a8 8 0 00-8 4" }),
    TrashIcon: ({ className }) => e(SvgIcon, { className, d: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" }),
    ChatBubbleIcon: ({ className }) => e(SvgIcon, { className, d: "M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 8 8z" }),
    SparklesIcon: ({ className }) => e(SvgIcon, { className, d: "M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0m-8.486 2.828L3 21m18-18l-2.122 2.122" }),
    ArrowUpIcon: ({ className }) => e(SvgIconThick, { className, d: "M5 15l7-7 7 7" }),
    ArrowDownIcon: ({ className }) => e(SvgIconThick, { className, d: "M19 9l-7 7-7-7" }),
    ChevronUpDownIcon: ({ className }) => e(SvgIconUpDown, { className, d: "M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" }),
    DocumentMinusIcon: ({ className }) => e(SvgIcon, { className, d: "M15 12H9m12 4a9 9 0 11-18 0 9 9 0 0118 0z" }),
    ReceiptIcon: ({ className }) => e(SvgIcon, { className, d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" }),
    CheckCircleIcon: ({ className }) => e(SvgIcon, { className, d: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" }),
    CashIcon: ({ className }) => e(SvgIcon, { className, d: "M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" }),
    TrendingUpIcon: ({ className }) => e(SvgIcon, { className, d: "M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" }),
    PrinterIcon: ({ className }) => e(SvgIcon, { className, d: "M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm2-9V5a2 2 0 00-2-2H9a2 2 0 00-2 2v3m4-3h4" }),
    ChevronUpDownIconCompact: ({ className }) => e(SvgIconUpDownCompact, { className, d: "M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" }),
    FunnelIcon: ({ className }) => e(SvgIcon, { className, d: "M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L14 12.414V17a1 1 0 01-.293.707l-4 4A1 1 0 018 21v-8.586L3.293 6.707A1 1 0 013 6V4z" }),
    HomeIcon: ({ className }) => e(SvgIcon, { className, d: "M2.25 12l8.954-8.955a.75.75 0 011.06 0l8.955 8.955a.75.75 0 01-1.06 1.06L12 4.061 3.31 13.06a.75.75 0 01-1.06-1.06zM12 21.75v-8.25" }),
    SunIcon: ({ className }) => e(SvgIcon, { className, d: "M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" }),
    MoonIcon: ({ className }) => e(SvgIcon, { className, d: "M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" }),
    BookmarkIcon: ({ className }) => e(SvgIcon, { className, d: "M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" }),
    XMarkIcon: ({ className }) => e(SvgIcon, { className, d: "M6 18L18 6M6 6l12 12" }),
    ArrowLeftIcon: ({ className }) => e(SvgIcon, { className, d: "M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" }),
    DocumentPlusIcon: ({ className }) => e(SvgIcon, { className, d: "M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" }),
    PencilIcon: ({ className }) => e(SvgIcon, { className, d: "M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" }),
};

const Button = ({ variant = 'primary', children, icon, className, ...props }) => {
  const baseClasses = 'inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
  const variantClasses = {
    primary: 'bg-primary text-white hover:bg-primary-hover focus:ring-primary',
    secondary: 'bg-slate-600 text-white hover:bg-slate-700 focus:ring-slate-500',
    danger: 'bg-danger text-white hover:bg-danger-hover focus:ring-danger',
    ghost: 'bg-transparent text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 focus:ring-primary',
    'danger-ghost': 'bg-transparent text-danger hover:bg-danger/10 focus:ring-danger'
  };
  const finalClassName = `${baseClasses} ${variantClasses[variant]} ${className || ''}`;
  
  return e('button', { className: finalClassName, ...props },
    icon && e('span', { className: 'mr-2 -ml-1 h-5 w-5' }, icon),
    children
  );
};

const ProgressBar = ({ progress }) => {
    return e('div', { className: 'w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5' },
        e('div', { 
            className: 'bg-primary h-2.5 rounded-full transition-all duration-300 ease-in-out', 
            style: { width: `${progress}%` } 
        })
    );
};

const ProductCard = ({ title, description, icon, onClick, earlyAccess = false }) => {
  const WavyBg = () => e('svg', { 
      className: 'absolute top-0 left-0 w-full h-full text-indigo-50/80 dark:text-slate-800/50 opacity-40 group-hover:opacity-60 transition-opacity z-0',
      viewBox: "0 0 350 150",
      preserveAspectRatio: "none"
  }, e('path', { d: "M-1.33,49.99 C150.00,150.00 170.04,-49.98 350.00,49.99 L350.00,150.00 L0.00,150.00 Z", fill: "currentColor" }));

  return e('div', { 
      onClick,
      className: 'relative bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 cursor-pointer hover:shadow-lg hover:border-primary/50 dark:hover:border-primary transition-all group overflow-hidden' 
  },
      e(WavyBg, null),
      e('div', { className: 'relative z-10 flex flex-col h-full' },
          earlyAccess && e('div', { className: 'absolute top-0 right-0 bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full -mr-2 -mt-2' }, 'Early access'),
          e('div', { className: 'mb-4' }, icon),
          e('div', { className: 'flex-grow' },
              e('h3', { className: 'text-lg font-bold text-slate-800 dark:text-slate-100' }, title),
              e('p', { className: 'mt-1 text-sm text-slate-600 dark:text-slate-400' }, description)
          )
      )
  );
};

const KpiCard = ({ title, value, subValue, icon, color, onClick }) => {
  const colorClasses = {
      red: 'text-red-600 dark:text-red-400',
      yellow: 'text-yellow-600 dark:text-yellow-400',
      blue: 'text-blue-600 dark:text-blue-400',
      green: 'text-green-600 dark:text-green-400',
  };
  return e('div', { onClick, className: `bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 flex items-start ${onClick ? 'cursor-pointer hover:shadow-lg hover:border-primary dark:hover:border-primary' : ''}` },
      icon && e('div', { className: 'p-3 rounded-full mr-4 bg-primary-light dark:bg-primary/20' }, icon),
      e('div', null,
          e('div', { className: 'text-sm font-medium text-slate-500 dark:text-slate-400' }, title),
          e('div', { className: `text-2xl font-bold ${colorClasses[color]}` }, value),
          subValue && e('div', { className: 'text-xs text-slate-400 dark:text-slate-500' }, subValue)
      )
  );
};

const LoginPage = ({ onLoginSuccess }) => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = (e) => {
        e.preventDefault();
        if (username === 'xxx' && password === 'xxx') {
            onLoginSuccess();
        } else {
            setError('Invalid username or password.');
        }
    };

    return e('div', { className: 'flex items-center justify-center min-h-screen p-4' },
        e('div', { className: 'w-full max-w-sm' },
            e('div', { className: 'mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-primary-light dark:bg-primary/20 mb-5' },
                e(Icons.BriefcaseIcon, { className: 'h-8 w-8 text-primary' })
            ),
            e('h1', { className: 'text-center text-3xl font-bold text-slate-800 dark:text-slate-100' }, 'Compliance Cloud'),
            e('div', { className: 'mt-8 bg-white dark:bg-slate-800 p-8 rounded-xl shadow-md border border-slate-200 dark:border-slate-700' },
                e('form', { onSubmit: handleLogin, className: 'space-y-6' },
                    e('div', null,
                        e('label', { htmlFor: 'username', className: 'block text-sm font-medium text-slate-700 dark:text-slate-300' }, 'Username'),
                        e('div', { className: 'mt-1' },
                            e(TextInput, { id: 'username', type: 'text', required: true, value: username, onChange: (ev) => setUsername(ev.target.value) })
                        )
                    ),
                    e('div', null,
                        e('label', { htmlFor: 'password', className: 'block text-sm font-medium text-slate-700 dark:text-slate-300' }, 'Password'),
                        e('div', { className: 'mt-1' },
                            e(TextInput, { id: 'password', type: 'password', required: true, value: password, onChange: (ev) => setPassword(ev.target.value) })
                        )
                    ),
                    error && e('p', { className: 'text-sm text-red-600' }, error),
                    e('div', null,
                        e(Button, { type: 'submit', className: 'w-full justify-center text-base py-3' }, 'Sign In')
                    )
                )
            )
        )
    );
};

const MainLandingPage = ({ onNavigateToGst }) => {
    const cards = [
        { 
            title: 'GST', 
            description: 'The ultimate app for all your Goods & Services Tax compliance needs.',
            icon: e(Icons.BriefcaseIcon, { className: 'w-10 h-10 text-red-600' }),
            onClick: onNavigateToGst
        },
        { 
            title: 'TDS',
            description: 'End-to-end TDS filing, challan payments, reports, certificate generation and more.',
            icon: e(Icons.CashIcon, { className: 'w-10 h-10 text-orange-500' }),
            onClick: () => alert('TDS module coming soon!')
        },
        { 
            title: 'Notice Tracker',
            description: 'Review and track all your notices from the government.',
            icon: e(Icons.ShieldIcon, { className: 'w-10 h-10 text-teal-500' }),
            onClick: () => alert('Notice Tracker coming soon!')
        }
    ];

    return e('div', { className: 'min-h-screen bg-gradient-to-br from-indigo-50 to-white dark:from-slate-900 dark:to-slate-800 p-6 sm:p-8' },
        e('div', { className: 'max-w-screen-xl mx-auto' },
            e('h1', { className: 'text-3xl font-bold text-slate-800 dark:text-slate-100' }, 'Welcome, Harish'),
            e('h2', { className: 'mt-2 text-xl text-slate-600 dark:text-slate-400' }, 'Clear Compliance Cloud'),
            e('div', { className: 'mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
                cards.map(card => e(ProductCard, { key: card.title, ...card }))
            )
        )
    );
};

const StartupScreen = ({ onFileSelect, onLoadSaved, onClearSaved, onLoadMockData, statusMessage, isLoading, progress, onNavigateToHome }) => {
  const fileInputRef = useRef(null);
  const handleFileChange = (event) => {
    const file = event.target.files?.[0];
    if (file) {
      onFileSelect(file);
    }
  };
  const handleUploadClick = () => {
    fileInputRef.current?.click();
  };

  return e('div', { className: 'flex items-center justify-center min-h-screen p-4 relative' },
    e('div', { className: 'absolute top-4 left-4' },
      e(Button, { onClick: onNavigateToHome, variant: 'secondary', icon: e(Icons.HomeIcon, { className: 'h-5 w-5' }) }, 'Home')
    ),
    e('div', { className: 'w-full max-w-md text-center' },
      e('div', { className: 'mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-primary-light dark:bg-primary/20 mb-5' },
        e(Icons.ReceiptIcon, { className: 'h-8 w-8 text-primary' })
      ),
      e('h1', { className: 'text-3xl font-bold text-slate-800 dark:text-slate-100' }, 'GST Reconciliation Dashboard'),
      e('p', { className: 'mt-2 text-slate-600 dark:text-slate-400' }, 'Upload an Excel file or load previously saved data to begin.'),
      e('div', { className: 'mt-8 bg-white dark:bg-slate-800 p-8 rounded-xl shadow-md border border-slate-200 dark:border-slate-700' },
        isLoading ? 
          e('div', { className: 'space-y-4 py-8' },
            e('p', { className: 'text-center text-slate-600 dark:text-slate-300 font-medium' }, statusMessage),
            e(ProgressBar, { progress: progress })
          ) :
          e(Fragment, null,
            e('input', { type: 'file', ref: fileInputRef, className: 'hidden', accept: '.xlsx, .xls', onChange: handleFileChange }),
            e('div', { className: 'space-y-4' },
              e(Button, { onClick: handleUploadClick, icon: e(Icons.FileUploadIcon, { className: 'h-5 w-5' }), className: 'w-full justify-center text-base py-3' }, 'Upload New Excel File'),
              e(Button, { onClick: onLoadSaved, variant: 'secondary', icon: e(Icons.DatabaseIcon, { className: 'h-5 w-5' }), className: 'w-full justify-center text-base py-3' }, 'Use Saved Data'),
              e(Button, { onClick: onLoadMockData, variant: 'secondary', className: 'w-full justify-center text-base py-3' }, 'Load Mock Data')
            ),
            e('div', { className: 'mt-6 border-t dark:border-slate-600 pt-6' },
              e(Button, { onClick: onClearSaved, variant: 'danger-ghost', icon: e(Icons.TrashIcon, { className: 'w-4 h-4' }) }, 'Clear All Saved Data')
            )
          )
      ),
      !isLoading && statusMessage && e('p', { className: 'mt-6 text-sm text-center text-slate-600 dark:text-slate-400 h-5' }, statusMessage)
    )
  );
};

const TextInput = (props) => {
    return e('input', { ...props, className: `w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 shadow-sm text-sm text-slate-900 dark:text-slate-200 placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-primary focus:ring-1 focus:ring-primary ${props.className || ''}` });
};

const Checkbox = ({ id, checked, onChange, label, ...props }) => {
    return e('div', { className: 'flex items-center' },
        e('input', { id, type: 'checkbox', checked, onChange, className: 'h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary bg-transparent dark:bg-slate-700', ...props }),
        label && e('label', { htmlFor: id, className: 'ml-2 block text-sm text-slate-900 dark:text-slate-200' }, label)
    );
};

const Select = ({ label, value, options, onChange, className = '', ...props }) => {
  const [isOpen, setIsOpen] = useState(false);
  const wrapperRef = useRef(null);
  const selectedOption = value === 'All' ? 'All' : options.find(opt => { 
      if (typeof opt === 'object') return opt.value === value;
      return opt === value;
  }) || (options[0] || 'All');
  
  const handleSelect = (option) => {
    const selectedValue = typeof option === 'object' ? option.value : option;
    onChange({ target: { value: selectedValue, name: props.name } }); // Mimic event object
    setIsOpen(false);
  };

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);
  
  const renderOptions = Array.isArray(options) && options.every(o => typeof o !== 'object') ? ['All', ...options] : options;
  const getDisplay = (opt) => typeof opt === 'object' ? opt.label : opt;
  
  return e('div', { className: `relative ${className}`, ref: wrapperRef },
    label && e('label', { className: 'block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1' }, label),
    e('button', { type: 'button', onClick: () => setIsOpen(!isOpen), ...props, className: 'relative w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm text-slate-900 dark:text-slate-200' },
      e('span', { className: 'block truncate' }, getDisplay(selectedOption)),
      e('span', { className: 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none' }, e(Icons.ChevronUpDownIconCompact, { className: 'h-5 w-5 text-gray-400' }))
    ),
    isOpen && e('div', { className: 'absolute z-30 mt-1 w-full bg-white dark:bg-slate-800 shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm' },
      renderOptions.map((option, idx) => { 
          const optionValue = typeof option === 'object' ? option.value : option;
          return e('div', { key: optionValue+idx, onClick: () => handleSelect(option), className: 'cursor-default select-none relative py-2 pl-3 pr-9 text-gray-900 dark:text-gray-200 hover:bg-primary-light dark:hover:bg-slate-700 hover:text-primary-dark dark:hover:text-primary' },
        e('span', { className: `font-normal block truncate ${value === optionValue ? 'font-semibold' : ''}` }, getDisplay(option))
      )})
    )
  );
};

const MultiSelect = ({ label, values, options, onChange, className = '' }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const wrapperRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleToggleOption = (option) => {
    const newValues = values.includes(option) ? values.filter(v => v !== option) : [...values, option];
    onChange(newValues);
  };
  
  const filteredOptions = useMemo(() => {
      if (!searchTerm) return options;
      return options.filter(opt => String(opt).toLowerCase().includes(searchTerm.toLowerCase()));
  }, [options, searchTerm]);

  const displayValue = values.length === 0 ? 'All' :
                       values.length === options.length ? 'All' :
                       values.length === 1 ? values[0] :
                       `${values.length} selected`;

  return e('div', { className: `relative ${className}`, ref: wrapperRef },
    label && e('label', { className: 'block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1' }, label),
    e('button', { type: 'button', onClick: () => setIsOpen(!isOpen), className: 'relative w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm text-slate-900 dark:text-slate-200' },
      e('span', { className: 'block truncate' }, displayValue),
      e('span', { className: 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none' }, e(Icons.ChevronUpDownIconCompact, { className: 'h-5 w-5 text-gray-400' }))
    ),
    isOpen && e('div', { className: 'absolute z-30 mt-1 w-full bg-white dark:bg-slate-800 shadow-lg max-h-80 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm flex flex-col' },
      e('div', { className: 'p-2 border-b dark:border-slate-700' }, 
          e(TextInput, { placeholder: `Search...`, value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), className: 'w-full' })
      ),
      e('div', { className: 'flex-grow overflow-y-auto' },
          filteredOptions.map(option => e('div', { key: option, onClick: () => handleToggleOption(option), className: 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 dark:text-gray-200 hover:bg-primary-light dark:hover:bg-slate-700 flex items-center' },
              e('input', { type: 'checkbox', readOnly: true, checked: values.includes(option), className: 'h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary mr-3' }),
              e('span', { className: 'font-normal block truncate' }, option)
          ))
      ),
      e('div', { className: 'flex justify-between p-2 border-t dark:border-slate-700' },
          e('button', { onClick: () => onChange(options), className: 'text-sm text-primary hover:underline' }, "Select All"),
          e('button', { onClick: () => onChange([]), className: 'text-sm text-primary hover:underline' }, "Clear All"),
      )
    )
  );
};

const ActionSelect = ({ rowId, value, onChange }) => {
    const handleChange = (e) => {
        onChange(rowId, e.target.value);
    };
    return e(Select, { value, options: ACTION_OPTIONS.filter(o => o !== 'None'), onChange: handleChange, className: "w-40" });
};

const Chatbot = ({ slicerOptions, onFilterChange, setPrintModalData, allData }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [messages, setMessages] = useState([{ text: "Hi! I'm an AI assistant. How can I help you filter or analyze the GST data? (e.g., 'show Stark Industries in June', 'details for Wayne Enterprises')", sender: 'bot' }]);
    const [input, setInput] = useState('');
    const messagesEndRef = useRef(null);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    const handleSend = async () => {
        if (!input.trim() || !geminiService.isAvailable()) {
            if(!geminiService.isAvailable()) {
                alert("AI Assistant is not available. Please configure your API_KEY.");
            }
            return;
        };
        const userMessage = { text: input, sender: 'user' };
        setMessages(prev => [...prev, userMessage, { text: 'Thinking...', sender: 'bot', isThinking: true }]);
        setInput('');

        const interpretation = await geminiService.getFilterFromQuery(userMessage.text, slicerOptions);

        setMessages(prev => prev.filter(m => !m.isThinking));

        if (interpretation.action === 'filter') {
            const newFilters = {};
            if (interpretation.company) newFilters.company = interpretation.company;
            if (interpretation.financialYear) newFilters.financialYear = interpretation.financialYear;
            if (interpretation.month) newFilters.month = interpretation.month;
            if (interpretation.tag) newFilters.tag = interpretation.tag;
            onFilterChange(newFilters);
            setMessages(prev => [...prev, { text: `OK, I've applied the filters for: ${interpretation.matchedText}. Check the dashboard.`, sender: 'bot' }]);
        } else if (interpretation.action === 'details' && interpretation.supplier) {
            const supplierData = allData.filter(row => row['Supplier Name'] === interpretation.supplier);
              if (supplierData.length > 0) {
                setPrintModalData({ isOpen: true, category: `Details for ${interpretation.supplier}`, data: supplierData });
                setMessages(prev => [...prev, { text: `Showing details for ${interpretation.supplier}.`, sender: 'bot' }]);
            } else {
                setMessages(prev => [...prev, { text: `I couldn't find any data for a supplier named "${interpretation.supplier}".`, sender: 'bot' }]);
            }
        } else {
            setMessages(prev => [...prev, { text: interpretation.matchedText || "Sorry, I couldn't understand that. Please try again.", sender: 'bot' }]);
        }
    };
    
    if (!isOpen) {
        return e(Button, { onClick: () => setIsOpen(true), className: 'fixed bottom-5 right-5 rounded-full p-4 shadow-lg z-30', icon: e(Icons.ChatBubbleIcon, { className: 'h-6 w-6' }) });
    }

    return e('div', { className: 'fixed bottom-5 right-5 w-[350px] h-[500px] bg-white dark:bg-slate-800 rounded-lg shadow-2xl z-40 flex flex-col border border-slate-200 dark:border-slate-700' },
        e('div', { className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
            e('h3', { className: 'font-semibold text-lg dark:text-slate-100' }, 'MGST AI Assistant'),
            e('button', { onClick: () => setIsOpen(false), className: 'text-2xl text-slate-500 hover:text-slate-800 dark:hover:text-slate-200' }, '')
        ),
        e('div', { ref: messagesEndRef, className: 'flex-grow p-4 overflow-y-auto' },
            messages.map((msg, i) => e('div', { key: i, className: `mb-3 max-w-[85%] p-3 rounded-lg ${msg.sender === 'user' ? 'ml-auto bg-primary text-white' : 'mr-auto bg-slate-200 dark:bg-slate-700 dark:text-slate-200'}` }, msg.text))
        ),
        e('div', { className: 'p-4 border-t dark:border-slate-700 flex' },
            e(TextInput, { value: input, onChange: (e) => setInput(e.target.value), onKeyDown: (e) => e.key === 'Enter' && handleSend(), placeholder: "Ask about the data..." }),
            e(Button, { onClick: handleSend, className: 'ml-2' }, 'Send')
        )
    );
};

const ChartComponent = ({ chartConfig }) => {
    const chartRef = useRef(null);
    const chartInstanceRef = useRef(null);
    useEffect(() => {
        if (chartRef.current) {
            if (chartInstanceRef.current) {
                chartInstanceRef.current.destroy();
            }
            const ctx = chartRef.current.getContext('2d');
            chartInstanceRef.current = new Chart(ctx, chartConfig);
        }
        return () => {
            if (chartInstanceRef.current) {
                chartInstanceRef.current.destroy();
            }
        };
    }, [chartConfig]);
    return e('canvas', { ref: chartRef });
};

const ColumnFilterPopover = ({ columnKey, data, currentFilters, onFilterChange, close }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const menuRef = useRef(null);

    const uniqueValues = useMemo(() => {
        return [...new Set(data.map(item => item[columnKey]))].sort();
    }, [data, columnKey]);

    const filteredValues = useMemo(() => {
        if (!searchTerm) return uniqueValues;
        return uniqueValues.filter(v => String(v).toLowerCase().includes(searchTerm.toLowerCase()));
    }, [uniqueValues, searchTerm]);

    const handleToggle = (value) => {
        const newFilters = currentFilters.includes(value) ? currentFilters.filter(f => f !== value) : [...currentFilters, value];
        onFilterChange(newFilters);
    };

    const handleSelectAll = () => onFilterChange(uniqueValues);
    const handleClearAll = () => onFilterChange([]);

    return e('div', { ref: menuRef, className: 'absolute top-full mt-2 left-0 z-40 bg-white dark:bg-slate-800 shadow-lg max-h-80 w-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm flex flex-col' },
      e('div', { className: 'p-2 border-b dark:border-slate-700' },
          e(TextInput, { placeholder: `Search...`, value: searchTerm, onChange: (e) => setSearchTerm(e.target.value) })
      ),
      e('div', { className: 'flex-grow overflow-y-auto' },
          filteredValues.map(value => e('div', { key: String(value), onClick: () => handleToggle(value), className: 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 dark:text-gray-200 hover:bg-primary-light dark:hover:bg-slate-700 flex items-center' },
              e('input', { type: 'checkbox', readOnly: true, checked: currentFilters.includes(value), className: 'h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary mr-3' }),
              e('span', { className: 'font-normal block truncate' }, String(value))
          ))
      ),
      e('div', { className: 'flex justify-between p-2 border-t dark:border-slate-700' },
          e('button', { onClick: handleSelectAll, className: 'text-sm text-primary hover:underline' }, "Select All"),
          e('button', { onClick: handleClearAll, className: 'text-sm text-primary hover:underline' }, "Clear All"),
      )
    );
};

const DataTable = ({ columns, data, initialPageSize = 10, selectedRows, onSelectionChange }) => {
    const [sortConfig, setSortConfig] = useState({ key: columns.find(c => c.sortable)?.key || '', direction: 'ascending' });
    const [currentPage, setCurrentPage] = useState(1);
    const [rowsPerPage, setRowsPerPage] = useState(initialPageSize);
    const [globalFilter, setGlobalFilter] = useState('');
    const [columnFilters, setColumnFilters] = useState({});
    const [openFilter, setOpenFilter] = useState(null);
    const filterMenuRef = useRef(null);
    
    const finalSelectedRows = selectedRows || [];

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (openFilter && filterMenuRef.current && !filterMenuRef.current.contains(event.target)) {
                setOpenFilter(null);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [openFilter]);

    const filteredAndSortedData = useMemo(() => {
        let filtered = data;
        if (globalFilter) {
            filtered = filtered.filter(row => {
                return columns.some(col => {
                    const val = row[col.key];
                    return String(val).toLowerCase().includes(globalFilter.toLowerCase());
                });
            });
        }
        
        const activeColumnFilters = Object.entries(columnFilters).filter(([, values]) => values && values.length > 0);
        if (activeColumnFilters.length > 0) {
            filtered = filtered.filter(row => {
                return activeColumnFilters.every(([key, values]) => {
                    return values.includes(row[key]);
                });
            });
        }

        if (sortConfig.key) {
            const sorted = [...filtered];
            sorted.sort((a, b) => {
                let aValue = a[sortConfig.key];
                let bValue = b[sortConfig.key];
                const aDate = parseDateString(aValue);
                const bDate = parseDateString(bValue);
                if (aDate && bDate) {
                    aValue = aDate.getTime();
                    bValue = bDate.getTime();
                }
                if (aValue < bValue) return sortConfig.direction === 'ascending' ? -1 : 1;
                if (aValue > bValue) return sortConfig.direction === 'ascending' ? 1 : -1;
                return 0;
            });
            return sorted;
        }
        return filtered;
    }, [data, sortConfig, globalFilter, columnFilters, columns]);

    const paginatedData = useMemo(() => {
        const start = (currentPage - 1) * rowsPerPage;
        return filteredAndSortedData.slice(start, start + rowsPerPage);
    }, [filteredAndSortedData, currentPage, rowsPerPage]);
    
    const paginatedDataIds = useMemo(() => paginatedData.map(d => d.id), [paginatedData]);

    const totalPages = Math.ceil(filteredAndSortedData.length / rowsPerPage);

    useEffect(() => {
        setCurrentPage(1);
    }, [globalFilter, rowsPerPage, columnFilters]);

    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        }
        setSortConfig({ key, direction });
        setCurrentPage(1);
    };
    
    const handleColumnFilterChange = (columnKey, values) => {
        setColumnFilters(prev => ({...prev, [columnKey]: values}));
    };
    
    const handleSelectAllOnPage = (e) => {
        const isChecked = e.target.checked;
        const currentIds = new Set(finalSelectedRows);
        paginatedDataIds.forEach(id => {
            if (isChecked) {
                currentIds.add(id);
            } else {
                currentIds.delete(id);
            }
        });
        onSelectionChange(Array.from(currentIds));
    };
    
    const isAllOnPageSelected = onSelectionChange && paginatedData.length > 0 && paginatedDataIds.every(id => finalSelectedRows.includes(id));


    return e('div', { className: 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border border-slate-200 dark:border-slate-700 min-h-[400px] flex flex-col' },
        e('div', { className: 'mb-4' }, 
            e(TextInput, { 
                placeholder: 'Search all columns...', 
                value: globalFilter, 
                onChange: (e) => setGlobalFilter(e.target.value) 
            })
        ),
        e('div', { className: 'overflow-x-auto flex-grow' },
            e('table', { className: 'w-full text-sm' },
                e('thead', { className: 'text-xs text-slate-700 dark:text-slate-300 uppercase bg-slate-50 dark:bg-slate-700/50' },
                    e('tr', null,
                        onSelectionChange && e('th', { className: 'px-4 py-3' }, e(Checkbox, { id: 'select-all-on-page', checked: isAllOnPageSelected, onChange: handleSelectAllOnPage })),
                        columns.map(col => e('th', { key: col.header, className: `px-4 py-3 text-black dark:text-white`, onClick: () => col.sortable && requestSort(col.key) }, 
                            e('div', { className: 'flex items-center justify-between' },
                                e('div', { className: `flex items-center ${col.sortable ? 'cursor-pointer' : ''}` }, 
                                    col.header,
                                    col.sortable && sortConfig.key === col.key && (sortConfig.direction === 'ascending' ? e(Icons.ArrowUpIcon, { className: 'w-3 h-3 ml-1' }) : e(Icons.ArrowDownIcon, { className: 'w-3 h-3 ml-1' }))
                                ),
                                col.filterable && e('div', { className: 'relative' },
                                    e('button', { onClick: (e) => { e.stopPropagation(); setOpenFilter(openFilter === col.key ? null : col.key) }, className: 'p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600' },
                                        e(Icons.FunnelIcon, { className: `w-4 h-4 ${(columnFilters[col.key] || []).length > 0 ? 'text-primary' : 'text-slate-400'}` })
                                    ),
                                    e('div', { ref: openFilter === col.key ? filterMenuRef : null },
                                        openFilter === col.key && e(ColumnFilterPopover, {
                                            columnKey: col.key,
                                            data: data,
                                            currentFilters: columnFilters[col.key] || [],
                                            onFilterChange: (values) => handleColumnFilterChange(col.key, values),
                                            close: () => setOpenFilter(null)
                                        })
                                    )
                                )
                            )
                        ))
                    )
                ),
                e('tbody', null,
                    paginatedData.map((row, index) => e('tr', { key: row.id || index, className: 'bg-white dark:bg-slate-800 border-b border-slate-400 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50' },
                        onSelectionChange && e('td', { className: 'px-4 py-2' }, e(Checkbox, { id: `select-row-${row.id}`, checked: finalSelectedRows.includes(row.id), onChange: () => {
                            const newSelection = finalSelectedRows.includes(row.id) ? finalSelectedRows.filter(id => id !== row.id) : [...finalSelectedRows, row.id];
                            onSelectionChange(newSelection);
                        }})),
                        columns.map(col => {
                            const value = col.render ? col.render(row) : row[col.key];
                            return e('td', { key: col.key, className: 'px-4 py-2 text-black dark:text-slate-200 align-top' }, value);
                        })
                    ))
                )
            )
        ),
        e('div', { className: 'flex flex-col sm:flex-row justify-between items-center pt-4 text-sm text-slate-600 dark:text-slate-400' },
            e('div', { className: 'flex items-center gap-2 mb-2 sm:mb-0' },
                e('span', null, 'Rows per page:'),
                e('select', { value: rowsPerPage, onChange: (e) => { setRowsPerPage(Number(e.target.value)); setCurrentPage(1); }, className: 'p-1 border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800' },
                    [10, 25, 50, 100].map(size => e('option', { key: size, value: size }, size))
                )
            ),
            e('div', { className: 'flex items-center gap-4' },
                e('span', null, `Page ${currentPage} of ${totalPages}`),
                e('div', { className: 'flex gap-1' },
                    e(Button, { onClick: () => setCurrentPage(p => Math.max(1, p-1)), disabled: currentPage === 1, variant: 'ghost', className: 'px-2 py-1' }, 'Prev'),
                    e(Button, { onClick: () => setCurrentPage(p => Math.min(totalPages, p+1)), disabled: currentPage === totalPages, variant: 'ghost', className: 'px-2 py-1' }, 'Next')
                )
            )
        )
    );
};

const ValidationPage = ({ allData, validationBooks, onValidateWithBooks }) => {
    const fileInputRef = React.useRef(null);
    
    const validationResults = React.useMemo(() => {
        if (validationBooks.length === 0) return { matched: [], unmatched: [] };
        const allBookRows = validationBooks.flatMap(book => {
            return book.data.map(row => {
                return {...row, 'Company Name': book.companyName}
            });
        });
        
        const mainDataLookup = new Map();
        allData.forEach(row => {
            if (row && typeof row.Type === 'string' && row.Type.startsWith('Missing_in_PR')) {
                const key = `${row['Company Name']}|${row['Document Number (2B)']}|${row['Supplier GSTIN (2B)'] || ''}`;
                mainDataLookup.set(key, row);
            }
        });

        const matched = [];
        const unmatched = [];
        
        const getCol = (row, candidates) => {
            for(const c of candidates) {
                const key = Object.keys(row).find(k => k.trim().toLowerCase() === c.toLowerCase());
                if(key) return row[key];
            }
            return null;
        }

        allBookRows.forEach(bookRow => {
            const docNum = getCol(bookRow, ['Voucher Ref. No.', 'Document Number']);
            const gstin = getCol(bookRow, ['GSTIN/UIN', 'GSTIN']);
            const key = `${bookRow['Company Name']}|${docNum}|${gstin || ''}`;
            
            if (mainDataLookup.has(key)) {
                matched.push(mainDataLookup.get(key));
                mainDataLookup.delete(key);
            } else {
                unmatched.push({
                    ...bookRow,
                    id: `unmatched_${docNum}_${Math.random()}`,
                    'Supplier Name': getCol(bookRow, ['Party Name']),
                    'Document Number (2B)': docNum,
                    'Document Date (2B)': getCol(bookRow, ['Voucher Date']),
                    'Sum of Taxable Value (2B)': getCol(bookRow, ['Taxable Value']),
                    'Total GST': getCol(bookRow, ['Total Tax']),
                    Remarks: 'Unmatched'
                });
            }
        });
        return { matched, unmatched };
    }, [validationBooks, allData]);

    const columns = [
        { header: 'Company Name', key: 'Company Name', sortable: true, filterable: true },
        { header: 'Supplier Name', key: 'Supplier Name', sortable: true, filterable: true },
        { header: 'Doc Num', key: 'Document Number (2B)', sortable: true },
        { header: 'Doc Date', key: 'Document Date (2B)', sortable: true },
        { header: 'Taxable', key: 'Sum of Taxable Value (2B)', render: (r) => formatCurrency(r['Sum of Taxable Value (2B)'], false) },
        { header: 'Total GST', key: 'Total GST', render: (r) => formatCurrency(r['Total GST'], false) },
        { header: 'Remarks', key: 'Remarks' },
    ];
    
    return e('div', { className: 'space-y-6' },
        e('div', { className: 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700' },
            e('h2', { className: 'text-lg font-semibold dark:text-slate-100' }, "Upload Books File"),
            e('p', { className: 'text-sm text-slate-600 dark:text-slate-400 mt-1 mb-4' }, "Filename must be 'Books_CompanyName.xlsx'. This will find matches and auto-mark them as 'Accounted'."),
            e('input', { type: 'file', ref: fileInputRef, className: 'hidden', onChange: (e) => e.target.files[0] && onValidateWithBooks(e.target.files[0]) }),
            e(Button, { onClick: () => fileInputRef.current.click() }, "Upload 'Books' Excel File")
        ),
        e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
            e('div', null, 
                e('h2', { className: 'text-xl font-bold text-success mb-2' }, 'Matched Transactions'),
                e(DataTable, { columns, data: validationResults.matched, selectedRows: [], onSelectionChange: () => {} })
            ),
            e('div', null,
                e('h2', { className: 'text-xl font-bold text-danger mb-2' }, 'Unmatched Transactions'),
                e(DataTable, { columns, data: validationResults.unmatched, selectedRows: [], onSelectionChange: () => {} })
            )
        )
    );
};

const TransactionsPage = ({ data, actionState, updateAction, updateMultipleActions }) => {
    const [jtcFilter, setJtcFilter] = useState(false);
    const [editingCell, setEditingCell] = useState(null);
    const [remarkValue, setRemarkValue] = useState('');
    const [selectedRows, setSelectedRows] = useState([]);
    const [bulkAction, setBulkAction] = useState('None');

    const tableData = useMemo(() => {
        if (!jtcFilter) return data;
        return data.filter(row => {
            const action = actionState[row.id];
            return (typeof action === 'string' && action === 'Accounted') || (action?.action === 'Accounted');
        });
    }, [data, jtcFilter, actionState]);
    
    useEffect(() => {
        setSelectedRows([]);
    }, [data]);

    const handleRemarkEdit = (rowId, currentRemark) => {
        setEditingCell(rowId);
        setRemarkValue(currentRemark);
    };
    const handleRemarkSave = (rowId) => {
        if (editingCell === rowId) {
            const currentAction = actionState[rowId];
            const newAction = typeof currentAction === 'object' ? { ...currentAction } : {};
            newAction.remarks = remarkValue;
            updateAction(rowId, newAction);
            setEditingCell(null);
        }
    };
    const handleRemarkKeyDown = (e, rowId) => {
        if (e.key === 'Enter') handleRemarkSave(rowId);
        if (e.key === 'Escape') setEditingCell(null);
    };

    const handleApplyBulkAction = () => {
        if (bulkAction === 'None' || selectedRows.length === 0) return;
        updateMultipleActions(selectedRows, bulkAction);
        setSelectedRows([]);
    };

    const columns = [
        { header: 'Company Name', key: 'Company Name', sortable: true, filterable: true },
        { header: 'Supplier Name', key: 'Supplier Name', sortable: true, filterable: true },
        { header: 'Doc Num', key: 'Document Number (2B)', sortable: true },
        { header: 'Doc Date', key: 'Document Date (2B)', sortable: true },
        { header: 'Tag', key: 'Type', sortable: true, filterable: true },
        { header: 'Taxable', key: 'Sum of Taxable Value (2B)', sortable: true, render: (row) => formatCurrency(row['Sum of Taxable Value (2B)'], false) },
        { header: 'Total GST', key: 'Total GST', sortable: true, render: (row) => formatCurrency(row['Total GST'], false) },
        { header: 'Remarks', key: 'Remarks', render: (row) => {
            const currentAction = actionState[row.id];
            const currentRemark = (typeof currentAction === 'object' ? currentAction?.remarks : '') || row.Remarks;
            if (editingCell === row.id) {
                return e(TextInput, { 
                    value: remarkValue, 
                    onChange: (e) => setRemarkValue(e.target.value),
                    onBlur: () => handleRemarkSave(row.id),
                    onKeyDown: (e) => handleRemarkKeyDown(e, row.id),
                    autoFocus: true 
                });
            }
            return e('span', { onClick: () => handleRemarkEdit(row.id, currentRemark), className: 'cursor-pointer hover:underline' }, currentRemark || '...');
        }},
        { header: 'Action', key: 'Action', render: (row) => {
            const currentAction = actionState[row.id];
            const value = typeof currentAction === 'string' ? currentAction : currentAction?.action;
            const handleChange = (id, val) => {
                const newAction = typeof currentAction === 'object' ? { ...currentAction } : {};
                newAction.action = val;
                updateAction(id, newAction);
            };
            return e(ActionSelect, { rowId: row.id, value: value || 'None', onChange: handleChange });
        }}
    ];
    
    const BulkActionBar = () => {
        if (selectedRows.length === 0) return null;
        return e('div', { className: 'bg-primary-light dark:bg-slate-700 p-2 rounded-md mb-4 flex items-center gap-4' },
            e('span', { className: 'text-sm font-medium dark:text-slate-200' }, `${selectedRows.length} rows selected`),
            e(Select, { value: bulkAction, options: ACTION_OPTIONS, onChange: (e) => setBulkAction(e.target.value), className: 'w-48' }),
            e(Button, { onClick: handleApplyBulkAction, disabled: bulkAction === 'None' }, 'Apply'),
            e('button', { onClick: () => setSelectedRows([]), className: 'text-sm text-slate-500 dark:text-slate-400 hover:underline ml-auto' }, 'Clear Selection')
        );
    };

    return e('div', null,
        e('div', { className: 'mb-4 flex flex-col sm:flex-row justify-between items-center gap-4' },
            e(Checkbox, { id: 'jtcFilter', checked: jtcFilter, onChange: (e) => setJtcFilter(e.target.checked), label: 'Show Accounted Only' }),
            e(Button, { onClick: () => exportToCsv(tableData, 'Transactions'), variant: 'secondary' }, 'Export CSV')
        ),
        e(BulkActionBar, null),
        e(DataTable, { columns, data: tableData, onSelectionChange: setSelectedRows, selectedRows })
    );
};

const AddToListSelect = ({ supplier, company, value, onChange }) => {
    const key = `${company}|${supplier}`;
    const handleChange = (e) => {
        onChange(key, e.target.value);
    };
    return e(Select, { value, options: MAILING_LIST_CATEGORIES, onChange: handleChange, className: "w-40" });
};

const SuppliersPage = ({ data, assignmentState, updateAssignment }) => {
  const supplierData = useMemo(() => {
    const suppliersInView = {};
    
    const cleanData = data.filter(row => row && typeof row === 'object' && typeof row['Company Name'] === 'string' && typeof row['Supplier Name'] === 'string');

    cleanData.forEach(row => {
        const key = `${row['Company Name']}|${row['Supplier Name']}`;
        if (!suppliersInView[key]) {
          suppliersInView[key] = { id: key, company: row['Company Name'], name: row['Supplier Name'], totalGst: 0, transactionCount: 0 };
        }
        suppliersInView[key].totalGst += (row['Total GST'] || 0);
        suppliersInView[key].transactionCount++;
    });
    
    Object.keys(assignmentState).forEach(key => {
        if (assignmentState[key] && assignmentState[key] !== 'None' && !suppliersInView[key]) {
            const [company, name] = key.split('|');
            suppliersInView[key] = { id: key, company: company, name: name, totalGst: 0, transactionCount: 0 };
        }
    });
    
    return Object.values(suppliersInView);
  }, [data, assignmentState]);

  const columns = [
      { header: 'Company Name', key: 'company', sortable: true, filterable: true },
      { header: 'Supplier Name', key: 'name', sortable: true, filterable: true },
      { header: 'Total GST', key: 'totalGst', sortable: true, render: (row) => formatCurrency(row.totalGst, false) },
      { header: 'Transactions', key: 'transactionCount', sortable: true },
      { header: 'Add to List', key: 'list', render: (row) => {
          return e(AddToListSelect, { 
              supplier: row.name, 
              company: row.company, 
              value: assignmentState[row.id] || 'None', 
              onChange: updateAssignment 
          });
      }},
  ];

  return e('div', null,
    e('div', { className: 'mb-4 flex justify-end' },
      e(Button, { onClick: () => exportToCsv(supplierData, "supplier_summary_export"), variant: 'secondary' }, 'Export CSV')
    ),
    e(DataTable, { columns: columns, data: supplierData })
  );
};

const MailingListPage = ({ data, actionState, assignmentState, setPrintModalData }) => {
    const handleShowPreview = (category) => {
        const assignedSuppliers = Object.entries(assignmentState)
            .filter(([key, cat]) => cat === category)
            .map(([key]) => key);
        
        const uniqueEntries = new Set();
        const mailingData = data.filter(row => {
            const key = `${row['Company Name']}|${row['Supplier Name']}`;
            const entryKey = `${key}|${row['Document Number (2B)']}`;

            const action = actionState[row.id];
            const isAccounted = typeof action === 'string' ? action === 'Accounted' : action?.action === 'Accounted';

            if (assignedSuppliers.includes(key) && !isAccounted && !uniqueEntries.has(entryKey)) {
                uniqueEntries.add(entryKey);
                return true;
            }
            return false;
        });

        if (mailingData.length === 0) {
            alert(`No pending transactions found for mailing list: ${category}`);
            return;
        }
        setPrintModalData({ isOpen: true, category, data: mailingData });
    };

    return e('div', { className: 'bg-white dark:bg-slate-800 p-6 rounded-lg shadow-md border dark:border-slate-700' },
        e('h2', { className: 'text-lg font-semibold mb-4 dark:text-slate-100' }, 'Select a Category to View / Export:'),
        e('div', { className: 'flex flex-wrap gap-3' },
            MAILING_LIST_CATEGORIES.map(cat => e(Button, { key: cat, onClick: () => handleShowPreview(cat) }, cat))
        )
    );
};

const PrintModal = ({ printModalData, setPrintModalData, actionState }) => {
    if (!printModalData.isOpen) return null;
    
    const handlePrint = () => {
        const title = `Report: ${printModalData.category}`;
        controlledPrint('print-table', title);
    };
    const handleExport = () => {
        const exportData = printModalData.data.map(row => {
          const action = actionState[row.id];
          return {
            'Company Name': row['Company Name'],
            'Supplier Name': row['Supplier Name'],
            'Doc Num': row['Document Number (2B)'],
            'Doc Date': row['Document Date (2B)'],
            'Tag': row.Type,
            'Taxable': row['Sum of Taxable Value (2B)'],
            'Total GST': row['Total GST'],
            'Remarks': (typeof action === 'object' ? action?.remarks : '') || row.Remarks,
            'Action': (typeof action === 'string' ? action : action?.action) || 'None'
        }});
        exportToCsv(exportData, `MailingList_${printModalData.category}`);
    };

    return e('div', { id: 'print-modal', className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
        e('div', { id: 'print-modal-content', className: 'bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col' },
            e('div', { id: 'print-modal-header', className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
                e('h2', { className: 'text-xl font-bold dark:text-slate-100' }, `Preview: ${printModalData.category}`),
                e('button', { onClick: () => setPrintModalData({isOpen: false, category: '', data: []}) }, className: 'text-2xl dark:text-slate-300' }, '')
            ),
            e('div', { className: 'p-4 overflow-auto flex-grow' },
                e('table', { id: 'print-table', className: 'w-full text-sm' },
                    e('thead', null, e('tr', null, ['Company', 'Supplier', 'Doc Num', 'Doc Date', 'Tag', 'Taxable', 'Total GST', 'Remarks', 'Action'].map(h => e('th', { key: h, className: 'p-2 border border-slate-500 text-black dark:text-slate-200 text-left bg-slate-100 dark:bg-slate-700' }, h)))),
                    e('tbody', null, printModalData.data.map(row => {
                      const action = actionState[row.id];
                      return e('tr', { key: row.id },
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Company Name']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Supplier Name']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Document Number (2B)']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Document Date (2B)']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row.Type),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300 text-right' }, formatCurrency(row['Sum of Taxable Value (2B)'], false)),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300 text-right' }, formatCurrency(row['Total GST'], false)),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, (typeof action === 'object' ? action?.remarks : '') || row.Remarks),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, (typeof action === 'string' ? action : action?.action) || 'None')
                    )}))
                )
            ),
            e('div', { id: 'print-modal-footer', className: 'p-4 border-t dark:border-slate-700 flex justify-end gap-3' },
                e(Button, { onClick: handleExport, variant: 'secondary' }, 'Export CSV'),
                e(Button, { onClick: handlePrint, icon: e(Icons.PrinterIcon, null) }, 'Print'),
                e(Button, { onClick: () => setPrintModalData({isOpen: false, category: '', data: []}), variant: 'danger-ghost' }, 'Close')
            )
        )
    );
};

const ThinkingModeModal = ({ isOpen, onClose, contextData }) => {
    const [prompt, setPrompt] = useState('');
    const [response, setResponse] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    if (!isOpen) return null;

    const handleSubmit = async () => {
        if (!prompt.trim() || !geminiService.isAvailable()) {
            if(!geminiService.isAvailable()) {
                alert("AI analysis is not available. Please configure your API_KEY.");
            }
            return;
        };
        setIsLoading(true);
        setResponse('');
        const analysis = await geminiService.getAnalysis(prompt, contextData);
        setResponse(analysis);
        setIsLoading(false);
    };

    return e('div', { className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
        e('div', { className: 'bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col' },
            e('div', { className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
                e('h2', { className: 'text-xl font-bold dark:text-slate-100' }, 'Analyze with AI (Thinking Mode)'),
                e('button', { onClick: onClose, className: 'text-2xl dark:text-slate-300' }, '')
            ),
            e('div', { className: 'p-4 flex-grow flex flex-col gap-4' },
                e('div', null,
                    e('label', { htmlFor: 'ai-prompt', className: 'block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1' }, 'Ask a complex question about the current data view:'),
                    e('textarea', { 
                        id: 'ai-prompt',
                        rows: 4, 
                        value: prompt,
                        onChange: (e) => setPrompt(e.target.value),
                        className: 'w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 shadow-sm text-sm text-slate-900 dark:text-slate-200 placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-primary focus:ring-1 focus:ring-primary',
                        placeholder: 'e.g., "What are the common trends for suppliers with missing GST in the last quarter?" or "Summarize the top 3 suppliers by missing GST and suggest an action plan."'
                    })
                ),
                e('div', null,
                    e(Button, { onClick: handleSubmit, disabled: isLoading || !prompt.trim(), icon: e(Icons.SparklesIcon, { className: 'w-5 h-5'}) },
                        isLoading ? 'Analyzing...' : 'Submit to AI'
                    )
                ),
                (isLoading || response) && e('div', { className: 'border-t dark:border-slate-700 pt-4 flex-grow overflow-y-auto' },
                    isLoading ? e('div', { className: 'flex items-center gap-2 text-slate-600 dark:text-slate-300' }, 
                        e('div', { className: 'w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin' }),
                        e('span', null, 'The AI is thinking... this may take a moment.')
                    ) :
                    e('pre', { className: 'bg-slate-50 dark:bg-slate-900/50 p-3 rounded-md text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap font-sans' }, response)
                )
            ),
            e('div', { className: 'p-4 border-t dark:border-slate-700 flex justify-end' },
                e(Button, { onClick: onClose, variant: 'secondary' }, 'Close')
            )
        )
    );
};

// --- New Self-Contained Reports Page Component ---
const ReportsPage = ({ reportsData, updateReportsData }) => {
  const [activeCompany, setActiveCompany] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isUploadModalOpen, setUploadModalOpen] = useState(false);
  const [editingReport, setEditingReport] = useState(null);
  
  const getSortableDate = (monthStr) => {
      if (!monthStr || typeof monthStr !== 'string') return new Date(0);
      const [monthName, year] = monthStr.split('-');
      if (!monthName || !year) return new Date(0);
      const monthIndex = Object.keys(MONTH_MAP).findIndex(m => m.toLowerCase() === monthName.toLowerCase());
      if (monthIndex === -1) return new Date(0);
      return new Date(parseInt(year, 10), monthIndex);
  };

  const processedData = useMemo(() => {
      if (!reportsData) return [];
      
      const dataWithCalculations = [...reportsData]
          .sort((a,b) => getSortableDate(a.month).getTime() - getSortableDate(b.month).getTime())
          .map(r => {
              const closingBalance = (r.openingBalance || 0) + (r.itcAvailed || 0) + (r.taxLiability || 0); // Note: Liability is often negative
              const isGSTR1Late = checkFilingDelay(r.gstr1FiledOn, r.month, 11);
              const isGSTR3BLate = checkFilingDelay(r.gstr3bFiledOn, r.month, 20);
              return { ...r, closingBalance, isGSTR1Late, isGSTR3BLate, isLate: isGSTR1Late || isGSTR3BLate };
          });

      const companyGroups = dataWithCalculations.reduce((acc, r) => {
          if(r.companyName) {
              acc[r.companyName] = acc[r.companyName] || [];
              acc[r.companyName].push(r);
          }
          return acc;
      }, {});

      Object.values(companyGroups).forEach(companyReports => {
          for (let i = 0; i < companyReports.length; i++) {
              const current = companyReports[i];
              const previous = companyReports[i - 1];
              if (previous && previous.closingBalance && Math.abs(previous.closingBalance) > 0.0001) {
                  const change = ((current.closingBalance - previous.closingBalance) / Math.abs(previous.closingBalance)) * 100;
                  current.change = isFinite(change) ? change : 0;
              } else if (current.closingBalance > 0) {
                  current.change = 100; // Indicate increase if previous was zero/null
              } else {
                  current.change = 0;
              }
          }
      });

      return dataWithCalculations;
  }, [reportsData]);
  
  const summaryData = useMemo(() => {
      const latestReports = {};
      processedData.forEach(r => {
          if (!r.companyName || !r.month) return;
            const currentReportDate = getSortableDate(r.month);
            const existingReport = latestReports[r.companyName];
            
            if (!existingReport || currentReportDate > getSortableDate(existingReport.month)) {
              latestReports[r.companyName] = r;
            }
      });
      const latestData = Object.values(latestReports);
      return {
          outwardTaxable: latestData.reduce((sum, r) => sum + (r.taxLiability || 0), 0),
          taxPaid: latestData.reduce((sum, r) => sum + (r.taxLiability || 0), 0),
          itcAvailed: latestData.reduce((sum, r) => sum + (r.itcAvailed || 0), 0),
          lateFilings: latestData.filter(r => r.isLate).length
      }
  }, [processedData]);
  
  const companyITCData = useMemo(() => {
      const latestReports = {};
      processedData.forEach(r => {
          if (!r.companyName || !r.month) return;
          const currentReportDate = getSortableDate(r.month);
          const existingReport = latestReports[r.companyName];

          if (!existingReport || currentReportDate > getSortableDate(existingReport.month)) {
              latestReports[r.companyName] = r;
          }
      });
      return Object.values(latestReports);
  }, [processedData]);
  
  const activeCompanyDetails = useMemo(() => {
      if (!activeCompany) return null;
      return processedData
          .filter(r => r.companyName === activeCompany)
          .sort((a,b) => getSortableDate(a.month).getTime() - getSortableDate(b.month).getTime());
  }, [activeCompany, processedData]);

  const handleSaveReport = (reportData) => {
      const existingIndex = reportsData.findIndex(r => r.id === reportData.id);
      let newReports;
      if (existingIndex > -1) {
          newReports = [...reportsData];
          newReports[existingIndex] = reportData;
      } else {
          newReports = [...reportsData, reportData];
      }
      updateReportsData(newReports);
  };
  
  const handleEditReport = (report) => {
      setEditingReport(report);
      setIsModalOpen(true);
  };
  
  const handleDeleteReport = (reportId) => {
      if (confirm('Are you sure you want to delete this report entry?')) {
          const newReports = reportsData.filter(r => r.id !== reportId);
          updateReportsData(newReports);
      }
  };

  const handlePdfUploadResults = (results) => {
      const mergedData = results.reduce((acc, current) => {
          if (!current.companyName || !current.month) return acc;
          const key = `${current.companyName}|${current.month}`;
          if (!acc[key]) {
              acc[key] = { companyName: current.companyName, month: current.month };
          }
          Object.assign(acc[key], current);
          return acc;
      }, {});

      const newReportsFromPdfs = Object.values(mergedData);
      const reportsMap = new Map(reportsData.map(r => [`${r.companyName}|${r.month}`, r]));

      newReportsFromPdfs.forEach((newReportData) => {
          const key = `${newReportData.companyName}|${newReportData.month}`;
          const existingReport = reportsMap.get(key);
          if (existingReport) {
              const updatedReport = { ...existingReport, ...newReportData };
              reportsMap.set(key, updatedReport);
          } else {
              const companyReports = Array.from(reportsMap.values())
                  .filter(r => r.companyName === newReportData.companyName)
                  .sort((a,b) => getSortableDate(a.month).getTime() - getSortableDate(b.month).getTime());
              
              const latestReport = companyReports[companyReports.length - 1];
              let openingBalance = 0;
              if(latestReport) {
                  openingBalance = (latestReport.openingBalance || 0) + (latestReport.itcAvailed || 0) + (latestReport.taxLiability || 0);
              }
              
              const newEntry = {
                  id: `report_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                  openingBalance,
                  ...newReportData
              };
              reportsMap.set(key, newEntry);
          }
      });
      updateReportsData(Array.from(reportsMap.values()));
  };


  const HeaderBar = () => e('div', { className: 'flex justify-between items-center border-b dark:border-slate-700 pb-2 mb-4' },
      e('div', null,
          e('h1', { className: 'text-xl font-semibold text-slate-800 dark:text-slate-100' }, 'Manjushree Ventures Group'),
          e('p', { className: 'text-sm text-slate-500 dark:text-slate-400' }, 'GST Management & ITC Summary')
      ),
      e('div', { className: 'text-right text-xs text-slate-600 dark:text-slate-300' },
          e('p', null, `Date: ${new Date().toLocaleDateString()}`),
          e('p', null, 'From: Harish Vijendran (Accounts)')
      )
  );
  
  const GroupSummarySection = ({ data }) => e('div', { className: 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700 mb-6' },
      e('h2', { className: 'text-lg font-semibold mb-2 text-slate-800 dark:text-slate-200' }, 'Group Summary'),
      e('table', { className: 'w-full text-sm' },
          e('thead', { className: 'text-left bg-slate-50 dark:bg-slate-700/50' }, e('tr', null, ['Metric', 'Current Month', 'YTD', 'YoY', 'Comments'].map(h => e('th', { key: h, className: 'p-2 font-medium' }, h)))),
          e('tbody', null,
              e('tr', { className: 'border-b dark:border-slate-700' }, e('td', { className: 'p-2' }, 'Total Outward Taxable Value'), e('td', { className: 'p-2' }, formatCurrency(data.outwardTaxable, false)), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, '')),
              e('tr', { className: 'border-b dark:border-slate-700' }, e('td', { className: 'p-2' }, 'Total Tax Paid (3B)'), e('td', { className: 'p-2' }, formatCurrency(data.taxPaid, false)), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, '')),
              e('tr', { className: 'border-b dark:border-slate-700' }, e('td', { className: 'p-2' }, 'Total ITC Availed'), e('td', { className: 'p-2' }, formatCurrency(data.itcAvailed, false)), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, '')),
              e('tr', null, e('td', { className: 'p-2' }, 'Late Filings'), e('td', { className: `p-2 font-bold ${data.lateFilings > 0 ? 'text-danger' : 'text-success'}` }, data.lateFilings), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, '...'), e('td', { className: 'p-2' }, ''))
          )
      )
  );
  
  const CollapsibleITCTable = ({ data }) => e('details', { className: 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700 mb-6', open: true },
      e('summary', { className: 'cursor-pointer text-primary font-semibold' }, 'Company-Wise ITC Reconciliation Summary'),
      e('div', { className: 'overflow-x-auto mt-4' },
          e('table', { className: 'mt-2 w-full text-sm border dark:border-slate-600' },
              e('thead', { className: 'bg-slate-50 dark:bg-slate-700/50' }, e('tr', null, ['Company', 'Month', 'Opening', 'Availed', 'Liability', 'Closing', 'Actions'].map(h => e('th', { key: h, className: 'p-2 font-medium text-left' }, h)))),
              e('tbody', null, data.map(c => e('tr', { key: c.id, className: 'border-b dark:border-slate-700' },
                  e('td', { className: 'p-2' }, c.companyName),
                  e('td', { className: 'p-2' }, c.month),
                  e('td', { className: 'p-2 text-right' }, formatCurrency(c.openingBalance, false)),
                  e('td', { className: 'p-2 text-right' }, formatCurrency(c.itcAvailed, false)),
                  e('td', { className: 'p-2 text-right' }, formatCurrency(c.taxLiability, false)),
                  e('td', { className: 'p-2 text-right font-bold' }, formatCurrency(c.closingBalance, false)),
                  e('td', { className: 'p-2' }, 
                      e('div', { className: 'flex gap-2' },
                          e('button', { onClick: () => handleEditReport(c), className: 'text-blue-500 hover:text-blue-700' }, e(Icons.PencilIcon, { className: 'w-4 h-4' })),
                          e('button', { onClick: () => handleDeleteReport(c.id), className: 'text-red-500 hover:text-red-700' }, e(Icons.TrashIcon, { className: 'w-4 h-4' }))
                      )
                  )
              )))
          )
      )
  );
  
  const GroupKPICards = ({ data, onClickCompany }) => e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6' },
      data.map(c => {
          const change = c.change || 0;
          return e('div', { key: c.id, className: `bg-white dark:bg-slate-800 rounded-xl shadow-md p-4 hover:shadow-lg cursor-pointer border-2 ${c.isLate ? 'border-danger' : 'border-transparent'}`, onClick: () => onClickCompany(c.companyName) },
              e('h3', { className: 'font-semibold text-slate-800 dark:text-slate-100 truncate' }, c.companyName),
              e('p', { className: 'text-xl font-bold text-primary mt-1' }, `${formatCurrency(c.closingBalance)}`),
              e('p', { className: `text-sm ${change >= 0 ? 'text-green-600' : 'text-red-600'}` }, change >= 0 ? ` ${change.toFixed(1)}%` : ` ${Math.abs(change).toFixed(1)}%`),
              e('p', { className: `text-xs mt-2 font-semibold ${c.isLate ? 'text-red-500' : 'text-green-500'}`}, c.isLate ? 'Filed Late' : 'Filed On Time')
          );
      })
  );

  const CompanyDashboardView = ({ company, data, onBack }) => {
      if (!data || data.length === 0) return e('div', null, 'No data available for this company.');
      
      const chartConfig = {
          type: 'line',
          data: {
              labels: data.map(d => d.month),
              datasets: [
                  { label: 'Closing ITC', data: data.map(d => d.closingBalance), borderColor: '#4F46E5', tension: 0.1, fill: false },
                  { label: 'ITC Availed', data: data.map(d => d.itcAvailed), borderColor: '#10B981', tension: 0.1, fill: false }
              ]
          },
          options: { responsive: true, plugins: { title: { display: true, text: `ITC Trend for ${company}` } } }
      };
      
      return e('div', { className: 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700 mb-6' },
          e(Button, { onClick: onBack, variant: 'secondary', className: 'mb-4', icon: e(Icons.ArrowLeftIcon, {className: 'h-4 w-4'}) }, 'Back to Group View'),
          e('h2', { className: 'text-xl font-bold text-slate-800 dark:text-slate-100' }, company),
          e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mt-4' },
              e('div', null, e(ChartComponent, { chartConfig })),
              e('div', { className: 'text-sm' }, 
                  e('h3', { className: 'font-semibold mb-2' }, 'Latest Compliance Status'),
                  data.slice(-1).map(r => e('div', { key: r.id },
                      e('p', null, e('strong', null, 'Month: '), r.month),
                      e('p', null, e('strong', null, 'GSTR-1 Filed: '), r.gstr1FiledOn, e('span', { className: `ml-2 font-semibold ${r.isGSTR1Late ? 'text-danger' : 'text-success'}`}, r.isGSTR1Late ? 'LATE' : 'ON TIME')),
                      e('p', null, e('strong', null, 'GSTR-3B Filed: '), r.gstr3bFiledOn, e('span', { className: `ml-2 font-semibold ${r.isGSTR3BLate ? 'text-danger' : 'text-success'}`}, r.isGSTR3BLate ? 'LATE' : 'ON TIME'))
                  ))
              )
          )
      );
  };
  
  const PrintableReportSection = ({ data }) => {
      const handlePrint = () => controlledPrint('printableReportContent', 'GST ITC Report');

      return e('div', { id: 'printableReport', className: 'p-4 border dark:border-slate-700 mt-6 bg-white dark:bg-slate-800 rounded-lg shadow-md' },
          e('div', { id: 'printableReportContent' },
              e('div', { className: 'reportHeader' },
                  e('div', { className: 'flex-between' },
                      e('span', null, `Date: ${new Date().toLocaleDateString('en-GB')}`),
                      e('span', { className: 'font-bold' }, 'Manjushree Ventures Group Companies'),
                      e('span', null, 'From: Harish Vijendran (Accounts)')
                  ),
                  e('h3', { className: 'text-center mt-4' }, 'GST Input Details  Total ITC As per GST Portal'),
                  e('div', { className: 'text-right small' },
                      'CMD/SK/RKK/BKM/KS/DCS', e('br'), '[Rupees in Crores]'
                  )
              ),
              e('table', { className: 'w-full text-sm border dark:border-slate-600 mt-4' },
                  e('thead', { className: 'bg-slate-50 dark:bg-slate-700/50' }, e('tr', null,
                      ['S.No', 'Company', '1. ITC as per Portal (Apr-25)', '2. ITC as per Portal (Aug-25)', '3. ITC Claimed (Sep-25)', '4. Output Liability (Sep-25)', '5. ITC as per Portal (Sep-25)', '6. ITC as per Books (Sep-25)', 'Remarks']
                      .map(h => e('th', { key: h, className: 'p-2 font-medium text-left border dark:border-slate-600' }, h))
                  )),
                  e('tbody', null, data.map((c, i) => e('tr', { key: c.id, className: 'border-b dark:border-slate-700' },
                      e('td', { className: 'p-2 border dark:border-slate-600' }, i + 1),
                      e('td', { className: 'p-2 border dark:border-slate-600' }, c.companyName),
                      e('td', { className: 'p-2 border dark:border-slate-600 text-right' }, formatCurrencyCr(c.portalITC_Apr * 1e7)),
                      e('td', { className: 'p-2 border dark:border-slate-600 text-right' }, formatCurrencyCr(c.portalITC_Aug * 1e7)),
                      e('td', { className: 'p-2 border dark:border-slate-600 text-right' }, formatCurrencyCr(c.itcAvailed)),
                      e('td', { className: 'p-2 border dark:border-slate-600 text-right' }, formatCurrencyCr(c.taxLiability)),
                      e('td', { className: 'p-2 border dark:border-slate-600 text-right' }, formatCurrencyCr(c.portalITC_Sep * 1e7)),
                      e('td', { className: 'p-2 border dark:border-slate-600 text-right' }, formatCurrencyCr(c.booksITC_Sep * 1e7)),
                      e('td', { className: 'p-2 border dark:border-slate-600' }, c.remarks)
                  )))
              )
          ),
          e(Button, { onClick: handlePrint, className: 'mt-4', icon: e(Icons.PrinterIcon, { className: 'h-4 w-4' }) }, 'Print / Export')
      );
  };
  
  const ReportDataEntryModal = ({ isOpen, onClose, onSave, allReports, existingReport }) => {
      const [formData, setFormData] = useState({});
      
      useEffect(() => {
          const currentYear = new Date().getFullYear();
          const defaultState = {
              id: existingReport?.id || `report_${Date.now()}`,
              companyName: existingReport?.companyName || COMPANY_NAMES[0],
              month: existingReport?.month || `${Object.keys(MONTH_MAP)[new Date().getMonth()]}-${currentYear}`,
              openingBalance: existingReport?.openingBalance || 0,
              itcAvailed: existingReport?.itcAvailed || 0,
              taxLiability: existingReport?.taxLiability || 0,
              gstr1FiledOn: existingReport?.gstr1FiledOn || '',
              gstr3bFiledOn: existingReport?.gstr3bFiledOn || '',
              remarks: existingReport?.remarks || '',
              portalITC_Apr: existingReport?.portalITC_Apr || 0,
              portalITC_Aug: existingReport?.portalITC_Aug || 0,
              portalITC_Sep: existingReport?.portalITC_Sep || 0,
              booksITC_Sep: existingReport?.booksITC_Sep || 0,
          };

          if (!existingReport?.id) { // Only auto-calculate opening balance for new entries
              const companyReports = allReports
                  .filter(r => r.companyName === defaultState.companyName)
                  .sort((a, b) => new Date(b.month.split('-')[1], MONTH_MAP[b.month.split('-')[0].substring(0,3)] - 1).getTime() - new Date(a.month.split('-')[1], MONTH_MAP[a.month.split('-')[0].substring(0,3)] - 1).getTime());
              if (companyReports.length > 0) {
                  const latestReport = companyReports[0];
                  defaultState.openingBalance = (latestReport.openingBalance || 0) + (latestReport.itcAvailed || 0) + (latestReport.taxLiability || 0);
              }
          }
          setFormData(defaultState);
      }, [isOpen, existingReport, allReports]);

      if (!isOpen) return null;

      const handleChange = e => setFormData(prev => ({ ...prev, [e.target.name]: e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value }));
      const handleSubmit = e => { e.preventDefault(); onSave(formData); onClose(); };
      
      const monthOptions = Array.from({length: 24}, (_, i) => {
          const date = new Date();
          date.setMonth(date.getMonth() - i);
          return `${Object.keys(MONTH_MAP)[date.getMonth()]}-${date.getFullYear()}`
      });

      return e('div', { className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
        e('div', { className: 'bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col' },
          e('form', { onSubmit: handleSubmit },
            e('div', { className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
              e('h2', { className: 'text-xl font-bold dark:text-slate-100' }, existingReport?.id ? 'Edit Report Data' : 'Add Report Data'),
              e('button', { type: 'button', onClick: onClose, className: 'text-2xl' }, '')
            ),
            e('div', { className: 'p-6 overflow-y-auto space-y-4' },
              e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                  e(Select, { label: 'Company Name', name: 'companyName', value: formData.companyName, options: COMPANY_NAMES, onChange: handleChange }),
                  e(Select, { label: 'Month-Year', name: 'month', value: formData.month, options: monthOptions, onChange: handleChange })
              ),
                e('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-4 dark:border-slate-700' },
                  e('div', null, e('label', {className: 'text-sm'}, 'Opening Balance'), e(TextInput, {type: 'number', name: 'openingBalance', value: formData.openingBalance, onChange: handleChange, step: 'any' })),
                  e('div', null, e('label', {className: 'text-sm'}, 'ITC Availed'), e(TextInput, {type: 'number', name: 'itcAvailed', value: formData.itcAvailed, onChange: handleChange, step: 'any'})),
                  e('div', null, e('label', {className: 'text-sm'}, 'Tax Liability'), e(TextInput, {type: 'number', name: 'taxLiability', value: formData.taxLiability, onChange: handleChange, step: 'any'}))
              ),
              e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                  e('div', null, e('label', {className: 'text-sm'}, 'GSTR-1 Filed On'), e(TextInput, {type: 'date', name: 'gstr1FiledOn', value: formData.gstr1FiledOn, onChange: handleChange})),
                  e('div', null, e('label', {className: 'text-sm'}, 'GSTR-3B Filed On'), e(TextInput, {type: 'date', name: 'gstr3bFiledOn', value: formData.gstr3bFiledOn, onChange: handleChange}))
              ),
                e('div', { className: 'border-t pt-4 mt-4 dark:border-slate-700' },
                    e('h3', { className: 'text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2' }, 'Printable Report Fields (in Crores)'),
                    e('div', { className: 'grid grid-cols-2 lg:grid-cols-4 gap-4' },
                      e('div', null, e('label', {className: 'text-sm'}, 'ITC Portal (Apr)'), e(TextInput, {type: 'number', name: 'portalITC_Apr', value: formData.portalITC_Apr, onChange: handleChange, step: 'any'})),
                      e('div', null, e('label', {className: 'text-sm'}, 'ITC Portal (Aug)'), e(TextInput, {type: 'number', name: 'portalITC_Aug', value: formData.portalITC_Aug, onChange: handleChange, step: 'any'})),
                      e('div', null, e('label', {className: 'text-sm'}, 'ITC Portal (Sep)'), e(TextInput, {type: 'number', name: 'portalITC_Sep', value: formData.portalITC_Sep, onChange: handleChange, step: 'any'})),
                      e('div', null, e('label', {className: 'text-sm'}, 'ITC Books (Sep)'), e(TextInput, {type: 'number', name: 'booksITC_Sep', value: formData.booksITC_Sep, onChange: handleChange, step: 'any'}))
                    )
                ),
              e('div', null, e('label', {className: 'text-sm'}, 'Remarks'), e(TextInput, {name: 'remarks', value: formData.remarks, onChange: handleChange}))
            ),
            e('div', { className: 'p-4 border-t dark:border-slate-700 flex justify-end gap-3' },
              e(Button, { type: 'button', onClick: onClose, variant: 'secondary' }, 'Cancel'),
              e(Button, { type: 'submit' }, 'Save Report')
            )
          )
        )
      );
  };
  
  const PdfUploadModal = ({ isOpen, onClose, onParsed }) => {
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState('');
      const [progress, setProgress] = useState(0);
      const [message, setMessage] = useState('');
      const fileInputRef = useRef(null);

      if (!isOpen) return null;

      const handleFileChange = async (event) => {
          const files = event.target.files;
          if (!files || files.length === 0) return;

          setIsLoading(true);
          setError('');
          setMessage('Starting PDF processing...');
          setProgress(0);
          try {
              const onProgress = (p, msg) => {
                  setProgress(p * 100);
                  setMessage(msg);
              };
              const data = await fileProcessor.processGstrPdfs(Array.from(files), onProgress);
              onParsed(data);
              onClose();
          } catch (e) {
              setError(`Failed to process PDFs: ${e.message}`);
              console.error(e);
          } finally {
              setIsLoading(false);
              if (fileInputRef.current) fileInputRef.current.value = '';
          }
      };
      
      return e('div', { className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
        e('div', { className: 'bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-lg w-full' },
          e('div', { className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
              e('h2', { className: 'text-xl font-bold dark:text-slate-100' }, 'Upload GSTR PDFs'),
              e('button', { type: 'button', onClick: onClose, className: 'text-2xl' }, '')
          ),
          e('div', { className: 'p-6 text-center' },
              isLoading ? 
                  e('div', { className: 'flex flex-col items-center gap-3' },
                      e(ProgressBar, { progress }),
                      e('p', { className: 'text-slate-600 dark:text-slate-300 mt-2 text-sm' }, message)
                  ) :
                  e(Fragment, null,
                      e('input', { type: 'file', ref: fileInputRef, className: 'hidden', accept: '.pdf', multiple: true, onChange: handleFileChange }),
                      e(Button, { onClick: () => fileInputRef.current.click(), icon: e(Icons.FileUploadIcon, { className: 'w-5 h-5' }) }, 'Select GSTR-1 & GSTR-3B PDFs'),
                      e('p', { className: 'text-xs text-slate-500 dark:text-slate-400 mt-2' }, 'You can select multiple files. Data will be automatically extracted.'),
                      error && e('p', { className: 'text-sm text-red-500 mt-3' }, error)
                  )
          )
        )
      );
  };

  return e('div', { className: 'space-y-6' },
      e(PdfUploadModal, { 
          isOpen: isUploadModalOpen,
          onClose: () => setUploadModalOpen(false),
          onParsed: handlePdfUploadResults,
      }),
      e(ReportDataEntryModal, { 
          isOpen: isModalOpen, 
          onClose: () => { setIsModalOpen(false); setEditingReport(null); },
          onSave: handleSaveReport,
          allReports: reportsData,
          existingReport: editingReport
      }),
      e(HeaderBar, null),
      e(Button, { onClick: () => setIsModalOpen(true), icon: e(Icons.DocumentPlusIcon, { className: 'w-4 h-4' }) }, 'Add Manual Entry'),
      e(Button, { onClick: () => setUploadModalOpen(true), icon: e(Icons.FileUploadIcon, { className: 'w-4 h-4' }), className: 'ml-2' }, 'Upload GSTR PDFs'),
      activeCompany ?
          e(CompanyDashboardView, { company: activeCompany, data: activeCompanyDetails, onBack: () => setActiveCompany(null) }) :
          e(Fragment, null,
              e(GroupSummarySection, { data: summaryData }),
              e(GroupKPICards, { data: companyITCData, onClickCompany: setActiveCompany }),
              e(CollapsibleITCTable, { data: processedData.sort((a,b) => getSortableDate(b.month).getTime() - getSortableDate(a.month).getTime()) })
          ),
      e(PrintableReportSection, { data: companyITCData })
  );
};

const Dashboard = function({
  allData, slicerOptions, filters, setFilters, actionState, updateAction, updateMultipleActions,
  assignmentState, updateAssignment, clearAllData, onValidateWithBooks,
  validationBooks, activeTab, setActiveTab, onKpiClick, setPrintModalData,
  onNavigateToHome, theme, toggleTheme, savedViews, saveCurrentView, applyView, deleteView,
  reports, updateReports
}) {
    
    const filteredData = useMemo(() => {
        const { company, financialYear, month, tag } = filters;
        if (!allData) return [];
        return allData.filter(r => {
            if (!r || typeof r !== 'object') {
                return false;
            }
            const companyMatch = company.length === 0 || company.includes(r['Company Name']);
            const fyMatch = financialYear.length === 0 || financialYear.includes(r['Financial Year']);
            const monthMatch = month.length === 0 || month.includes(r['Month']);
            const tagMatch = tag.length === 0 || (typeof r['Type'] === 'string' && tag.includes(r['Type']));
            
            return companyMatch && fyMatch && monthMatch && tagMatch;
        });
    }, [allData, filters]);
    
    const handleChartDrillDown = (category, data, alertMessage) => {
      if (data.length > 0) {
          setPrintModalData({ isOpen: true, category, data });
      } else {
          alert(alertMessage);
      }
    };

    const handleSupplierChartClick = (supplierName) => {
      const supplierData = filteredData.filter(row => {
          if (!row || typeof row.Type !== 'string') return false;
          const isMissing = (row.Type.includes('Missing_2B') || row.Type.includes('Missing_in_PR')) && !row.Type.includes('NowUploaded') && !row.Type.includes('NowClaimed');
          return row['Supplier Name'] === supplierName && isMissing;
      });
      handleChartDrillDown(`Missing GST Details for ${supplierName}`, supplierData, `No missing GST transactions found for ${supplierName} within the current filter selection.`);
    };
    
    const handleMonthlyChartClick = (month) => {
      const monthData = filteredData.filter(row => {
          return row && row.Month === month;
      });
      handleChartDrillDown(`All Transactions for ${month}`, monthData, `No transactions found for ${month} within the current filter selection.`);
    };

    const handleCategoryChartClick = (category) => {
      const categoryData = filteredData.filter(row => {
          return row && row.Type === category;
      });
      handleChartDrillDown(`Transactions for Tag: ${category}`, categoryData, `No transactions found for tag "${category}" within the current filter selection.`);
    };


    const kpiData = useMemo(() => {
        const missing2bCum = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return (r.Type === 'Missing_2B_Cumulative' || r.Type === 'Missing_2B_Current_Month') ? sum + r['Total GST'] : sum;
        }, 0);
        const missingPrCum = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return (r.Type.startsWith('Missing_in_PR_') && !r.Type.includes('NowClaimed')) ? sum + r['Total GST'] : sum;
        }, 0);
        const missing2bClaimed = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return (r.Type === 'Missing_2B_NowUploaded') ? sum + r['Total GST'] : sum;
        }, 0);
        const missingPrClaimed = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return (r.Type.startsWith('Missing_in_PR_NowClaimed') || r.Type.startsWith('Missing_PR_NowClaimed')) ? sum + r['Total GST'] : sum;
        }, 0);
        const totalRecovered = missing2bClaimed + missingPrClaimed;
        const totalMissing = missing2bCum + missingPrCum;
        const successRate = (totalMissing + totalRecovered) > 0 ? (totalRecovered / (totalMissing + totalRecovered)) * 100 : 0;
        return { missing2bCum, missingPrCum, missing2bClaimed, missingPrClaimed, totalRecovered, successRate };
    }, [filteredData]);

    const chartData = useMemo(() => {
        if (!filteredData || filteredData.length === 0) {
            return { monthly: null, byCategory: null, topSuppliers: null };
        }

        const monthly = {};
        filteredData.forEach(r => {
            if (!r || typeof r.Type !== 'string') return;
            const month = r.Month;
            if (!monthly[month]) monthly[month] = { missing: 0, recovered: 0 };
            if (r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) {
                if (r.Type.includes('NowUploaded') || r.Type.includes('NowClaimed')) {
                    monthly[month].recovered += r['Total GST'];
                } else {
                    monthly[month].missing += r['Total GST'];
                }
            }
        });

        const sortedMonths = Object.keys(monthly).sort((a, b) => getMonthNumber(a) - getMonthNumber(b));
        const monthlyChartConfig = {
            type: 'bar',
            data: {
                labels: sortedMonths,
                datasets: [
                    { label: 'Missing GST', data: sortedMonths.map(m => monthly[m].missing), backgroundColor: '#EF4444' },
                    { label: 'Recovered GST', data: sortedMonths.map(m => monthly[m].recovered), backgroundColor: '#10B981' }
                ]
            },
            options: { responsive: true, plugins: { title: { display: true, text: 'Monthly Missing vs. Recovered GST' } }, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: (value) => formatCurrency(value, true) } } },
            onClick: (evt, elements) => {
                if (!elements.length) return;
                const index = elements[0].index;
                const month = sortedMonths[index];
                handleMonthlyChartClick(month);
            }
          }
        };
        
        const byCategory = {};
        filteredData.forEach(r => {
            if (!r || typeof r.Type !== 'string') return;
            if ((r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) && !r.Type.includes('NowUploaded') && !r.Type.includes('NowClaimed')) {
                const category = r.Type;
                if (!byCategory[category]) byCategory[category] = 0;
                byCategory[category] += r['Total GST'];
            }
        });
        const categoryLabels = Object.keys(byCategory);
        const categoryChartConfig = {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{ data: Object.values(byCategory), backgroundColor: ['#EF4444', '#F59E0B', '#3B82F6', '#8B5CF6', '#EC4899'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Missing GST by Category' } },
            onClick: (evt, elements) => {
                if (!elements.length) return;
                const index = elements[0].index;
                const tag = categoryLabels[index];
                handleCategoryChartClick(tag);
            }
          }
        };

        const bySupplier = {};
          filteredData.forEach(r => {
            if (!r || typeof r.Type !== 'string') return;
            if ((r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) && !r.Type.includes('NowUploaded') && !r.Type.includes('NowClaimed')) {
                const supplier = r['Supplier Name'];
                if (!bySupplier[supplier]) {
                    bySupplier[supplier] = { gst: 0, supplier: supplier };
                }
                bySupplier[supplier].gst += r['Total GST'];
            }
        });
        const topSuppliers = Object.values(bySupplier).sort((a, b) => b.gst - a.gst).slice(0, 10);
        const topSuppliersChartConfig = {
            type: 'bar',
            data: {
                labels: topSuppliers.map(s => s.supplier),
                datasets: [{ label: 'Missing GST', data: topSuppliers.map(s => s.gst), backgroundColor: '#4F46E5' }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Top 10 Suppliers by Missing GST' }
                },
                scales: {
                    x: { ticks: { callback: (value) => formatCurrency(value, true) } }
                },
                onClick: (evt, elements) => {
                    if (!elements.length) return;
                    const index = elements[0].index;
                    const supplier = topSuppliers[index].supplier;
                    handleSupplierChartClick(supplier);
                }
            }
        };

        return { monthly: monthlyChartConfig, byCategory: categoryChartConfig, topSuppliers: topSuppliersChartConfig };
    }, [filteredData]);
    
    const SavedViewsManager = () => {
        const [isOpen, setIsOpen] = useState(false);
        const wrapperRef = useRef(null);
        useEffect(() => {
            const handleClickOutside = (event) => {
                if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false);
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, []);
        
        const handleSave = () => {
            const name = prompt("Enter a name for this view:");
            if (name) saveCurrentView(name);
            setIsOpen(false);
        };

        return e('div', { className: 'relative', ref: wrapperRef },
            e(Button, { onClick: () => setIsOpen(!isOpen), variant: 'secondary', icon: e(Icons.BookmarkIcon, { className: 'h-4 w-4' }) }, 'Views'),
            isOpen && e('div', { className: 'absolute z-30 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-slate-800 ring-1 ring-black ring-opacity-5 right-0' },
                e('div', { className: 'py-1', role: 'menu' },
                    e('button', { onClick: handleSave, className: 'w-full text-left block px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700' }, 'Save current view...'),
                    Object.keys(savedViews).length > 0 && e('div', { className: 'border-t border-slate-200 dark:border-slate-700 my-1' }),
                    Object.keys(savedViews).map(name => 
                        e('div', { key: name, className: 'flex justify-between items-center px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700' },
                            e('button', { onClick: () => { applyView(name); setIsOpen(false); }, className: 'flex-grow text-left' }, name),
                            e('button', { onClick: () => deleteView(name), className: 'text-slate-400 hover:text-danger ml-2' }, e(Icons.XMarkIcon, { className: 'h-4 w-4' }))
                        )
                    )
                )
            )
        );
    };
    
    const Header = () => e('header', { className: 'bg-white dark:bg-slate-800 shadow-sm w-full p-3' },
        e('div', { className: 'max-w-screen-2xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4' },
            e('div', { className: 'flex items-center' },
                e('h1', { className: 'text-xl font-bold text-primary-dark dark:text-primary-light shrink-0' }, 'GST Reconciliation Dashboard')
            ),
            e('div', { className: 'flex flex-wrap justify-center md:justify-end gap-3 w-full items-center' },
                e(MultiSelect, { label: 'Company', values: filters.company, options: slicerOptions.companies, onChange: (v) => setFilters(f => ({...f, company: v})), className: 'w-40' }),
                e(MultiSelect, { label: 'FY', values: filters.financialYear, options: slicerOptions.financialYears, onChange: (v) => setFilters(f => ({...f, financialYear: v})), className: 'w-28' }),
                e(MultiSelect, { label: 'Month', values: filters.month, options: slicerOptions.months, onChange: (v) => setFilters(f => ({...f, month: v})), className: 'w-32' }),
                e(MultiSelect, { label: 'Tag (Type)', values: filters.tag, options: slicerOptions.tags, onChange: (v) => setFilters(f => ({...f, tag: v})), className: 'w-48' }),
                e(SavedViewsManager, null),
                e(Button, { onClick: toggleTheme, variant: 'ghost', className: 'p-2' }, theme === 'light' ? e(Icons.MoonIcon, { className: 'h-5 w-5' }) : e(Icons.SunIcon, { className: 'h-5 w-5' })),
                e(Button, { onClick: onNavigateToHome, variant: 'secondary', icon: e(Icons.HomeIcon, { className: 'h-5 w-5' }) }, 'Home'),
                e(Button, { onClick: clearAllData, variant: 'danger-ghost', icon: e(Icons.TrashIcon, { className: 'w-4 h-4' }) }, 'Clear')
            )
        )
    );
    
    const tabs = ['KPIs', 'Reports', 'Transactions', 'Suppliers', 'Mailing List', 'Validate with Books'];
    const Navigation = () => e('nav', { className: 'bg-white dark:bg-slate-800 w-full shadow-sm border-b dark:border-slate-700' },
        e('div', { className: 'max-w-screen-2xl mx-auto flex justify-start px-2 text-sm' },
            tabs.map(tab => e('button', {
                key: tab,
                onClick: () => setActiveTab(tab),
                className: `py-3 px-4 font-medium border-b-2 transition-colors ${activeTab === tab ? 'border-primary text-primary' : 'border-transparent text-slate-600 dark:text-slate-400 hover:border-slate-300 dark:hover:border-slate-500 hover:text-slate-800 dark:hover:text-slate-200'}`
            }, tab))
        )
    );
    
    const KpiPage = () => e('div', { className: 'space-y-6' },
      e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6' },
        e(KpiCard, { title: "Missing 2B Cum", value: formatCurrency(kpiData.missing2bCum), icon: e(Icons.DocumentMinusIcon, { className: 'h-6 w-6 text-red-500' }), color: 'red', onClick: () => onKpiClick('Missing 2B') }),
        e(KpiCard, { title: "Missing PR Cum", value: formatCurrency(kpiData.missingPrCum), icon: e(Icons.DocumentMinusIcon, { className: 'h-6 w-6 text-yellow-500' }), color: 'yellow', onClick: () => onKpiClick('Missing in PR') }),
        e(KpiCard, { title: "Total Missing", value: formatCurrency(kpiData.missing2bCum + kpiData.missingPrCum), subValue: "2B + PR", icon: e(Icons.ReceiptIcon, { className: 'h-6 w-6 text-blue-500' }), color: 'blue' }),
        e(KpiCard, { title: "2B Claimed", value: formatCurrency(kpiData.missing2bClaimed), icon: e(Icons.CheckCircleIcon, { className: 'h-6 w-6 text-green-500' }), color: 'green', onClick: () => onKpiClick('2B NowUploaded') }),
        e(KpiCard, { title: "PR Claimed", value: formatCurrency(kpiData.missingPrClaimed), icon: e(Icons.CheckCircleIcon, { className: 'h-6 w-6 text-green-500' }), color: 'green', onClick: () => onKpiClick('PR NowClaimed') }),
        e(KpiCard, { title: "Success Rate", value: formatPercent(kpiData.successRate), subValue: "Total Recovered", icon: e(Icons.TrendingUpIcon, { className: 'h-6 w-6 text-green-500' }), color: 'green' })
      ),
      e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6' },
        e('div', { className: 'xl:col-span-2 bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700' },
            chartData.monthly ? e(ChartComponent, { chartConfig: chartData.monthly }) : e('div', null, 'No data for monthly chart.')
        ),
        e('div', { className: 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700 min-h-[300px]' },
            chartData.byCategory ? e(ChartComponent, { chartConfig: chartData.byCategory }) : e('div', null, 'No data for category chart.')
        )
      ),
      e('div', { className: 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700' },
          chartData.topSuppliers ? e(ChartComponent, { chartConfig: chartData.topSuppliers }) : e('div', null, 'No data for top suppliers chart.')
      )
    );

    const renderActiveTab = () => {
        switch(activeTab) {
            case 'KPIs': return e(KpiPage, null);
            case 'Reports': return e(ReportsPage, { reportsData: reports, updateReportsData: updateReports });
            case 'Transactions': return e(TransactionsPage, { data: filteredData, actionState: actionState, updateAction: updateAction, updateMultipleActions: updateMultipleActions });
            case 'Suppliers': return e(SuppliersPage, { data: filteredData, assignmentState: assignmentState, updateAssignment: updateAssignment });
            case 'Mailing List': return e(MailingListPage, { data: filteredData, actionState: actionState, assignmentState: assignmentState, setPrintModalData: setPrintModalData });
            case 'Validate with Books': return e(ValidationPage, { allData, validationBooks, onValidateWithBooks });
            default: return e(KpiPage, null);
        }
    };

    return e('div', { className: 'min-h-screen flex flex-col' },
        e(Header, null),
        e(Navigation, null),
        e('main', { className: 'flex-grow p-4 sm:p-6 max-w-screen-2xl mx-auto w-full' },
            e(ErrorBoundary, { message: 'Failed to load content for this tab.' }, renderActiveTab())
        )
    );
};

const App = function() {
  const [appState, setAppState] = useState({
    isAuthenticated: false,
    currentPage: 'login', // login, home, gst
    isLoading: false,
    statusMessage: '',
    progress: 0,
    allData: [],
    actionState: {},
    assignmentState: {},
    validationBooks: [],
    reports: [],
    activeTab: 'KPIs',
    filters: {
      company: [],
      financialYear: [],
      month: [],
      tag: [],
    },
    printModalData: { isOpen: false, category: '', data: [] },
    thinkingModalOpen: false,
    theme: localStorage.getItem('theme') || 'light',
    savedViews: JSON.parse(localStorage.getItem('gst_saved_views') || '{}')
  });

  const updateState = (updates) => {
    setAppState(prev => ({...prev, ...updates}));
  };
  
  useEffect(() => {
      if (appState.theme === 'dark') {
          document.documentElement.classList.add('dark');
      } else {
          document.documentElement.classList.remove('dark');
      }
      localStorage.setItem('theme', appState.theme);
  }, [appState.theme]);

  const toggleTheme = () => updateState({ theme: appState.theme === 'light' ? 'dark' : 'light' });

  const saveCurrentView = (name) => {
      const newSavedViews = { ...appState.savedViews, [name]: appState.filters };
      updateState({ savedViews: newSavedViews });
      localStorage.setItem('gst_saved_views', JSON.stringify(newSavedViews));
  };
  const applyView = (name) => {
      if (appState.savedViews[name]) {
          updateState({ filters: appState.savedViews[name] });
      }
  };
  const deleteView = (name) => {
      const newSavedViews = { ...appState.savedViews };
      delete newSavedViews[name];
      updateState({ savedViews: newSavedViews });
      localStorage.setItem('gst_saved_views', JSON.stringify(newSavedViews));
  };
  
  const setFilters = (newFilters) => {
      updateState({ filters: {...appState.filters, ...newFilters} });
  };
  
  const setPrintModalData = (data) => updateState({ printModalData: data });

  const handleLoginSuccess = () => {
    updateState({ isAuthenticated: true, currentPage: 'home' });
  };

  const handleNavigate = (page) => {
    updateState({ currentPage: page });
  };

  const onProgress = (progress, message) => {
    updateState({ progress: progress * 100, statusMessage: message });
  };

  const handleFileSelect = async (file) => {
    updateState({ isLoading: true, statusMessage: 'Starting file processing...', progress: 0 });
    try {
      const data = await fileProcessor.processMainFile(file, onProgress);
      updateState({ allData: data, actionState: {}, assignmentState: {}, reports: [], isLoading: false, statusMessage: `Successfully loaded ${data.length} records.`, currentPage: 'gst' });
    } catch (error) {
      console.error(error);
      updateState({ isLoading: false, statusMessage: `Error: ${error.message}` });
    }
  };

  const handleLoadSaved = async () => {
    updateState({ isLoading: true, statusMessage: 'Loading saved data...', progress: 50 });
    try {
        const { transactions, actions, assignments, reports } = await dbService.loadData();
        if ((!transactions || transactions.length === 0) && (!reports || reports.length === 0)) {
            updateState({ isLoading: false, statusMessage: 'No saved data found.' });
        } else {
            const books = await dbService.loadAllValidationBooks();
            updateState({
                allData: transactions || [], actionState: actions || {}, assignmentState: assignments || {},
                reports: reports || [], validationBooks: books || [], isLoading: false,
                statusMessage: 'Saved data loaded successfully.', currentPage: 'gst'
            });
        }
    } catch (error) {
        console.error(error);
        updateState({ isLoading: false, statusMessage: `Error loading data: ${error.message}` });
    }
  };
  
  const handleClearSaved = async () => {
    if (confirm('Are you sure you want to delete ALL saved data? This cannot be undone.')) {
        updateState({ isLoading: true, statusMessage: 'Clearing all data...', progress: 50 });
        await dbService.clearAllData();
        updateState({ allData: [], actionState: {}, assignmentState: {}, reports: [], validationBooks: [], isLoading: false, statusMessage: 'All saved data has been cleared.' });
    }
  };
  
  const handleLoadMockData = () => {
        updateState({ isLoading: true, statusMessage: 'Loading mock data...', progress: 50 });
      const mockData = [
          {id: 'row_0', 'Company Name': 'MANJUSHREE SPNTEK PVT LTD', 'Supplier Name': 'Supplier A', 'Document Number (2B)': 'DOC001', 'Document Date (2B)': '15-04-2023', 'Financial Year': '2023-24', 'Month': 'Apr', Type: 'Missing_in_PR_Cumulative', 'Sum of Taxable Value (2B)': 10000, 'Total GST': 1800, Remarks: ''},
          {id: 'row_1', 'Company Name': 'MANJUSHREE TECHNOPACK LTD', 'Supplier Name': 'Supplier B', 'Document Number (2B)': 'DOC002', 'Document Date (2B)': '20-04-2023', 'Financial Year': '2023-24', 'Month': 'Apr', Type: 'Missing_2B_Cumulative', 'Sum of Taxable Value (2B)': 5000, 'Total GST': 900, Remarks: ''},
          {id: 'row_2', 'Company Name': 'MANJUSHREE SPNTEK PVT LTD', 'Supplier Name': 'Supplier A', 'Document Number (2B)': 'DOC003', 'Document Date (2B)': '10-05-2023', 'Financial Year': '2023-24', 'Month': 'May', Type: 'Missing_in_PR_NowClaimed', 'Sum of Taxable Value (2B)': 10000, 'Total GST': 1800, Remarks: 'Claimed this month'},
      ];
        const mockReports = [];
      updateState({ allData: mockData, reports: mockReports, isLoading: false, statusMessage: 'Mock data loaded.', currentPage: 'gst', activeTab: 'Reports'});
  }

  const handleSave = useCallback(debounce((appStateToSave) => {
    const { allData, actionState, assignmentState, reports } = appStateToSave;
    dbService.saveData(allData, actionState, assignmentState, reports);
  }, 1000), []);
  
  useEffect(() => {
    if(appState.currentPage === 'gst') {
      handleSave(appState);
    }
  }, [appState.allData, appState.actionState, appState.assignmentState, appState.reports, handleSave]);

  function debounce(func, delay) {
      let timeout;
      return function(...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
      };
  }
  
  const updateAction = (rowId, newAction) => {
      updateState({ actionState: {...appState.actionState, [rowId]: newAction }});
  };
  const updateMultipleActions = (rowIds, action) => {
      const newActionState = { ...appState.actionState };
      rowIds.forEach(id => {
          const currentAction = newActionState[id] || {};
          newActionState[id] = typeof currentAction === 'object' ? { ...currentAction, action } : { action };
      });
      updateState({ actionState: newActionState });
  };
  const updateAssignment = (key, category) => {
      updateState({ assignmentState: {...appState.assignmentState, [key]: category }});
  };
  const updateReports = (newReports) => {
      updateState({ reports: newReports });
  };
  
  const handleValidateWithBooks = async (file) => {
      try {
          const book = await fileProcessor.processBooksFile(file);
          await dbService.saveValidationBook(book);
          const newBooks = await dbService.loadAllValidationBooks();
          updateState({ validationBooks: newBooks });

          // Find matches and update actions
          const bookRowsLookup = new Map();
          book.data.forEach(row => {
              const getCol = (r, candidates) => {
                for(const c of candidates) {
                    const key = Object.keys(r).find(k => k.trim().toLowerCase() === c.toLowerCase());
                    if(key) return r[key];
                }
                return null;
              }
              const docNum = getCol(row, ['Voucher Ref. No.', 'Document Number']);
              const gstin = getCol(row, ['GSTIN/UIN', 'GSTIN']);
              const key = `${book.companyName}|${docNum}|${gstin || ''}`;
              bookRowsLookup.set(key, row);
          });
          
          const newActionState = {...appState.actionState};
          let matchCount = 0;
          appState.allData.forEach(row => {
              if (row && typeof row.Type === 'string' && row.Type.startsWith('Missing_in_PR')) {
                  const key = `${row['Company Name']}|${row['Document Number (2B)']}|${row['Supplier GSTIN (2B)'] || ''}`;
                  if (bookRowsLookup.has(key)) {
                      matchCount++;
                      const current = newActionState[row.id] || {};
                      newActionState[row.id] = typeof current === 'object' ? { ...current, action: 'Accounted' } : { action: 'Accounted' };
                  }
              }
          });
          updateState({ actionState: newActionState });
          alert(`${matchCount} matches found and marked as 'Accounted'.`);

      } catch (error) {
          alert(`Error processing Books file: ${error.message}`);
      }
  };

  const slicerOptions = useMemo(() => {
    const companies = [...new Set(appState.allData.map(r => r['Company Name']))].filter(Boolean);
    const financialYears = [...new Set(appState.allData.map(r => r['Financial Year']))].filter(Boolean);
    const months = [...new Set(appState.allData.map(r => r['Month']))].filter(Boolean);
    const tags = [...new Set(appState.allData.map(r => r['Type']))].filter(Boolean);
    return { companies, financialYears, months, tags };
  }, [appState.allData]);

  const handleKpiClick = (kpiType) => {
    let tagFilter = [];
    if (kpiType === 'Missing 2B') {
      tagFilter = ['Missing_2B_Cumulative', 'Missing_2B_Current_Month'];
    } else if (kpiType === 'Missing in PR') {
      tagFilter = slicerOptions.tags.filter(t => t.startsWith('Missing_in_PR_') && !t.includes('NowClaimed'));
    } else if (kpiType === '2B NowUploaded') {
      tagFilter = ['Missing_2B_NowUploaded'];
    } else if (kpiType === 'PR NowClaimed') {
        tagFilter = slicerOptions.tags.filter(t => t.startsWith('Missing_in_PR_NowClaimed') || t.startsWith('Missing_PR_NowClaimed'));
    }
    setFilters({ ...appState.filters, tag: tagFilter });
    updateState({ activeTab: 'Transactions' });
  };
  
  if (!appState.isAuthenticated) {
      return e(LoginPage, { onLoginSuccess: handleLoginSuccess });
  }
  
  if (appState.currentPage === 'home') {
      return e(MainLandingPage, { onNavigateToGst: () => handleNavigate('gstStartup') });
  }
  
  if (appState.currentPage === 'gstStartup') {
      return e(StartupScreen, {
          onFileSelect: handleFileSelect,
          onLoadSaved: handleLoadSaved,
          onClearSaved: handleClearSaved,
          onLoadMockData: handleLoadMockData,
          statusMessage: appState.statusMessage,
          isLoading: appState.isLoading,
          progress: appState.progress,
          onNavigateToHome: () => handleNavigate('home')
      });
  }
  
  if (appState.currentPage === 'gst') {
    return e(Fragment, null,
      e(Dashboard, {
        allData: appState.allData,
        slicerOptions,
        filters: appState.filters,
        setFilters: (newFilters) => updateState({ filters: { ...appState.filters, ...newFilters } }),
        actionState: appState.actionState,
        updateAction,
        updateMultipleActions,
        assignmentState: appState.assignmentState,
        updateAssignment,
        clearAllData: handleClearSaved,
        onValidateWithBooks: handleValidateWithBooks,
        validationBooks: appState.validationBooks,
        activeTab: appState.activeTab,
        setActiveTab: (tab) => updateState({activeTab: tab}),
        onKpiClick: handleKpiClick,
        setPrintModalData,
        onNavigateToHome: () => handleNavigate('home'),
        theme: appState.theme,
        toggleTheme,
        savedViews: appState.savedViews,
        saveCurrentView, applyView, deleteView,
        reports: appState.reports,
        updateReports
      }),
      e(PrintModal, { printModalData: appState.printModalData, setPrintModalData, actionState: appState.actionState }),
      e(ThinkingModeModal, { 
          isOpen: appState.thinkingModalOpen, 
          onClose: () => updateState({ thinkingModalOpen: false }),
          contextData: appState.allData.filter(r => {
            // This is a simplified filter logic for context. A more complex one could be used.
            const companyMatch = appState.filters.company.length === 0 || appState.filters.company.includes(r['Company Name']);
            return companyMatch;
          })
      }),
      geminiService.isAvailable() && e(Chatbot, { slicerOptions, onFilterChange: (newFilters) => updateState({ filters: { ...appState.filters, ...newFilters } }), setPrintModalData, allData: appState.allData })
    );
  }

  return e('div', null, 'Something went wrong with application routing.');
};

ReactDOM.createRoot(document.getElementById('root')).render(e(StrictMode, null, e(App)));
    </script>
  </body>
</html>
