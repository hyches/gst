
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GST Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;
    </script>
    <!-- Gemini AI: Disabled due to CommonJS exports error in browser. Use server-side proxy instead. -->
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {
                DEFAULT: '#4F46E5', // Indigo 600
                hover: '#4338CA', // Indigo 700
                light: '#EEF2FF', // Indigo 50
                dark: '#312E81',  // Indigo 900
              },
              secondary: {
                DEFAULT: '#64748B', // Slate 500
                hover: '#475569', // Slate 600
              },
              success: '#10B981', // Emerald 500
              warning: '#F59E0B', // Amber 500
              danger: {
                DEFAULT: '#EF4444', // Red 500
                hover: '#DC2626', // Red 600
              }
            },
          },
        },
      }
    </script>
    <style>
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * PROFESSIONAL BUSINESS DASHBOARD - DESIGN SYSTEM
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * Clean, modern, professional design inspired by enterprise SaaS dashboards
       */
      
      * {
        box-sizing: border-box;
      }
      
      :root {
        /* â”€â”€â”€ Professional Color Palette â”€â”€â”€ */
        --primary-50: #EEF2FF;
        --primary-100: #E0E7FF;
        --primary-200: #C7D2FE;
        --primary-500: #6366F1;
        --primary-600: #4F46E5;
        --primary-700: #4338CA;
        --primary-900: #312E81;
        
        --gray-50: #F9FAFB;
        --gray-100: #F3F4F6;
        --gray-200: #E5E7EB;
        --gray-300: #D1D5DB;
        --gray-400: #9CA3AF;
        --gray-500: #6B7280;
        --gray-600: #4B5563;
        --gray-700: #374151;
        --gray-800: #1F2937;
        --gray-900: #111827;
        
        --success: #10B981;
        --success-light: #D1FAE5;
        --warning: #F59E0B;
        --warning-light: #FEF3C7;
        --danger: #EF4444;
        --danger-light: #FEE2E2;
        --info: #3B82F6;
        --info-light: #DBEAFE;
        
        /* â”€â”€â”€ Background Colors â”€â”€â”€ */
        --bg-primary: #FFFFFF;
        --bg-secondary: #F9FAFB;
        --bg-tertiary: #F3F4F6;
        
        /* â”€â”€â”€ Border & Shadows â”€â”€â”€ */
        --border-color: #E5E7EB;
        --border-color-strong: #D1D5DB;
        
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        
        /* â”€â”€â”€ Typography â”€â”€â”€ */
        --font-heading: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', sans-serif;
        --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', sans-serif;
        
        /* â”€â”€â”€ Spacing â”€â”€â”€ */
        --space-xs: 0.25rem;
        --space-sm: 0.5rem;
        --space-md: 1rem;
        --space-lg: 1.5rem;
        --space-xl: 2rem;
        --space-2xl: 3rem;
        
        /* â”€â”€â”€ Border Radius â”€â”€â”€ */
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        
        /* â”€â”€â”€ Transitions â”€â”€â”€ */
        --transition-fast: all 0.15s ease;
        --transition-base: all 0.2s ease;
        --transition-slow: all 0.3s ease;
      }
      
      /* â”€â”€â”€ Dark Mode â”€â”€â”€ */
      .dark {
        --bg-primary: #111827;
        --bg-secondary: #1F2937;
        --bg-tertiary: #374151;
        
        --border-color: #374151;
        --border-color-strong: #4B5563;
        
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      }
      
      body {
        font-family: var(--font-body);
        background-color: var(--bg-secondary);
        color: var(--gray-900);
        margin: 0;
        padding: 0;
      }
      
      .dark body {
        background-color: var(--bg-secondary);
        color: var(--gray-100);
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * PROFESSIONAL CARD COMPONENT
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .pro-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
      }
      
      .pro-card:hover {
        box-shadow: var(--shadow-md);
      }
      
      .pro-card-elevated {
        box-shadow: var(--shadow-md);
      }
      
      .pro-card-elevated:hover {
        box-shadow: var(--shadow-lg);
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * KPI CARDS - Clean & Professional
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .kpi-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
      }
      
      .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--primary-600);
        transition: var(--transition-fast);
      }
      
      .kpi-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }
      
      .kpi-card:hover::before {
        width: 6px;
      }
      
      .kpi-card-blue::before {
        background: linear-gradient(180deg, #3B82F6 0%, #2563EB 100%);
      }
      
      .kpi-card-green::before {
        background: linear-gradient(180deg, #10B981 0%, #059669 100%);
      }
      
      .kpi-card-red::before {
        background: linear-gradient(180deg, #EF4444 0%, #DC2626 100%);
      }
      
      .kpi-card-yellow::before {
        background: linear-gradient(180deg, #F59E0B 0%, #D97706 100%);
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * NAVIGATION & HEADER
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .pro-navbar {
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        position: sticky;
        top: 0;
        z-index: 40;
      }
      
      .pro-navbar-gradient {
        background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
        color: white;
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * BUTTONS - Professional Variants
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .btn-pro-primary {
        background: var(--primary-600);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        font-size: 0.875rem;
        box-shadow: var(--shadow-sm);
        transition: var(--transition-fast);
        cursor: pointer;
      }
      
      .btn-pro-primary:hover {
        background: var(--primary-700);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }
      
      .btn-pro-primary:active {
        transform: translateY(0);
      }
      
      .btn-pro-secondary {
        background: var(--bg-primary);
        color: var(--gray-700);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        font-size: 0.875rem;
        transition: var(--transition-fast);
        cursor: pointer;
      }
      
      .btn-pro-secondary:hover {
        background: var(--gray-50);
        border-color: var(--border-color-strong);
      }
      
      .dark .btn-pro-secondary {
        background: var(--bg-tertiary);
        color: var(--gray-200);
        border-color: var(--border-color);
      }
      
      .dark .btn-pro-secondary:hover {
        background: var(--bg-secondary);
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * TABS - Clean Professional Style
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .pro-tab {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        color: var(--gray-600);
        border-bottom: 2px solid transparent;
        transition: var(--transition-fast);
        cursor: pointer;
      }
      
      .pro-tab:hover {
        color: var(--primary-600);
        border-bottom-color: var(--primary-200);
      }
      
      .pro-tab-active {
        color: var(--primary-600);
        border-bottom-color: var(--primary-600);
      }
      
      .dark .pro-tab {
        color: var(--gray-400);
      }
      
      .dark .pro-tab:hover {
        color: var(--primary-400);
      }
      
      .dark .pro-tab-active {
        color: var(--primary-400);
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * TABLES - Professional Data Grid
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .pro-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }
      
      .pro-table thead {
        background: var(--gray-50);
      }
      
      .dark .pro-table thead {
        background: var(--bg-tertiary);
      }
      
      .pro-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-700);
        border-bottom: 1px solid var(--border-color);
      }
      
      .dark .pro-table th {
        color: var(--gray-300);
      }
      
      .pro-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        color: var(--gray-900);
      }
      
      .dark .pro-table td {
        color: var(--gray-200);
      }
      
      .pro-table tbody tr {
        transition: var(--transition-fast);
      }
      
      .pro-table tbody tr:hover {
        background: var(--gray-50);
      }
      
      .dark .pro-table tbody tr:hover {
        background: var(--bg-tertiary);
      }
      
      .pro-table tbody tr:last-child td {
        border-bottom: none;
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * INPUTS & FORMS - Professional Style
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .pro-input {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 0.625rem 0.875rem;
        font-size: 0.875rem;
        color: var(--gray-900);
        transition: var(--transition-fast);
        width: 100%;
      }
      
      .pro-input:focus {
        outline: none;
        border-color: var(--primary-600);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }
      
      .dark .pro-input {
        background: var(--bg-tertiary);
        color: var(--gray-100);
        border-color: var(--border-color);
      }
      
      .dark .pro-input:focus {
        border-color: var(--primary-500);
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * DROPDOWNS - Professional Select Menus
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .pro-dropdown {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        max-height: 20rem;
        overflow-y: auto;
        z-index: 50;
      }
      
      .pro-dropdown-item {
        padding: 0.625rem 1rem;
        cursor: pointer;
        transition: var(--transition-fast);
      }
      
      .pro-dropdown-item:hover {
        background: var(--gray-50);
      }
      
      .dark .pro-dropdown-item:hover {
        background: var(--bg-tertiary);
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * BADGES & INDICATORS
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        line-height: 1;
      }
      
      .badge-primary {
        background: var(--primary-100);
        color: var(--primary-700);
      }
      
      .badge-success {
        background: var(--success-light);
        color: #065F46;
      }
      
      .badge-warning {
        background: var(--warning-light);
        color: #92400E;
      }
      
      .badge-danger {
        background: var(--danger-light);
        color: #991B1B;
      }
      
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       * UTILITIES & ANIMATIONS
       * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       */
      @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
      }
      
      .shimmer {
        animation: shimmer 2s infinite;
        background: linear-gradient(
          to right,
          transparent 0%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 100%
        );
        background-size: 1000px 100%;
      }
      
      /* Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }
      
      ::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: var(--gray-400);
      }
      
      .dark ::-webkit-scrollbar-thumb {
        background: var(--gray-600);
      }
      
      .dark ::-webkit-scrollbar-thumb:hover {
        background: var(--gray-500);
      }
      
      /* Print-specific styles are handled by the controlledPrint function */
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 antialiased">
    <div id="root"></div>
    <script type="module">
// @ts-nocheck
const { useState, useEffect, useCallback, useMemo, useRef, StrictMode, Fragment, Component } = React;
const e = React.createElement;

// ErrorBoundary Component
class ErrorBoundary extends Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error, errorInfo) {
    console.error('ErrorBoundary caught error:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return e('div', { 
        className: 'glass-alert glass-alert-danger p-6 rounded-lg m-4' 
      },
        e('h3', { className: 'text-lg font-semibold text-red-600 dark:text-red-400 mb-2' }, 
          this.props.message || 'Something went wrong'
        ),
        e('p', { className: 'text-sm text-slate-600 dark:text-slate-400' },
          'Please refresh the page or contact support if the problem persists.'
        ),
        this.state.error && e('details', { className: 'mt-4 text-xs' },
          e('summary', { className: 'cursor-pointer text-slate-500' }, 'Error details'),
          e('pre', { className: 'mt-2 p-2 bg-slate-100 dark:bg-slate-800 rounded overflow-auto' },
            this.state.error.toString()
          )
        )
      );
    }
    return this.props.children;
  }
}

// --- Global declarations ---
// These are declared in the HTML head via CDN scripts
// declare var ReactDOM: any;
// declare var pdfjsLib: any;
// declare var XLSX: any;
// declare var Chart: any;

// --- From constants.ts ---
const DB_NAME = "GSTDashboardDB_React";
const STORE_TRANSACTIONS = "transactions";
const STORE_ACTIONS = "actions";
const STORE_ASSIGNMENTS = "assignments";
const STORE_VALIDATION_BOOKS = "validation_books";
const STORE_REPORTS = "reports"; // New store for the Reports Page
const DB_VERSION = 4; // Incremented DB version
const MAILING_LIST_CATEGORIES = [
  "Admin", "HR", "EA", "IT", "KS", "DC", "Investment", 
  "Manikant", "Neha", "Suresh", "Ashok"
];
// Valid transaction type patterns
const VALID_TYPES = [
  'Missing_in_PR_Cumulative',
  'Missing_in_PR_Current_Month',
  'Missing_in_PR_NowClaimed',
  'Missing_2B_Cumulative',
  'Missing_2B_Current_Month',
  'Missing_2B_NowUploaded',
  'Matched'
];

// Type matching patterns for consistent KPI calculations
const TYPE_PATTERNS = {
  MISSING_PR_CUMULATIVE: /^Missing_in_PR_(Cumulative|Current_Month)$/,
  MISSING_PR_CLAIMED: /^Missing_in_PR_NowClaimed$/,
  MISSING_2B_CUMULATIVE: /^Missing_2B_(Cumulative|Current_Month)$/,
  MISSING_2B_CLAIMED: /^Missing_2B_NowUploaded$/,
  MISSING_PR_ANY: /^Missing_in_PR/
};

const MONTH_MAP = {
  Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
  Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12
};
const ACTION_OPTIONS = [
  'None', 'Accounted', 'Not Accounted', 'Invoice Not Received',
  'Follow up', 'Followed up', 'No Response', 'Invoice Received'
];
const COMPANY_NAMES = [
  'MANJUSHREE SPNTEK PVT LTD', 'MANJUSHREE TECHNOPACK LTD', 'MANJUSHREE CLEANTECH PVT LTD',
  'MANJUSHREE INC', 'MANJUSHREE UK LTD'
];
const GSTIN_TO_COMPANY_MAP = {
    '29AANCM6884A1Z1': 'MANJUSHREE SPNTEK PVT LTD'
};


// --- From utils/helpers.ts ---
const formatCurrency = function(n, isShort = true) {
  if (typeof n !== 'number' || isNaN(n)) return isShort ? 'Rs. 0 K' : '0.00';
  if (!isShort) {
    return n.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  if (Math.abs(n) >= 1e7) return `Rs. ${(n / 1e7).toFixed(2)} Cr`;
  if (Math.abs(n) >= 1e5) return `Rs. ${(n / 1e5).toFixed(2)} Lk`;
  if (Math.abs(n) >= 1e3) return `Rs. ${(n / 1e3).toFixed(2)} K`;
  return `Rs. ${n.toFixed(2)}`;
};
const formatCurrencyCr = (n) => {
  if (typeof n !== 'number' || isNaN(n)) return '0.0000';
  return (n / 1e7).toFixed(4);
};
const formatPercent = function(n) {
  if (typeof n !== 'number' || isNaN(n)) return '0.0 %';
  return `${n.toFixed(1)} %`;
};
const parseDateString = function(ds) {
  if (!ds) return null;
  if (ds instanceof Date) return ds;
  if (typeof ds === 'number') {
    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
    const dateObj = new Date(excelEpoch.getTime() + ds * 86400000);
    return !isNaN(dateObj.getTime()) ? dateObj : null;
  }
  if (typeof ds !== 'string') return null;
  // Handles YYYY-MM-DD
  const isoParts = ds.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (isoParts) {
      const year = parseInt(isoParts[1], 10);
      const month = parseInt(isoParts[2], 10) - 1;
      const day = parseInt(isoParts[3], 10);
      const date = new Date(Date.UTC(year, month, day));
        if (!isNaN(date.getTime())) return date;
  }
  // Handles DD-MM-YYYY or DD/MM/YYYY
  const parts = ds.match(/(\d{1,2})[/-](\d{1,2})[/-](\d{4})/);
  if (parts) {
    const day = parseInt(parts[1], 10);
    const month = parseInt(parts[2], 10) - 1;
    const year = parseInt(parts[3], 10);
    const date = new Date(year, month, day);
    if (!isNaN(date.getTime()) && date.getDate() === day) return date;
  }
  const nativeDate = new Date(ds);
  return !isNaN(nativeDate.getTime()) ? nativeDate : null;
};
const getFinancialYear = function(date) {
  const year = date.getFullYear();
  const month = date.getMonth();
  return month >= 3 ? `${year}-${String(year + 1).slice(-2)}` : `${year - 1}-${String(year).slice(-2)}`;
};
const getMonthNumber = function(monthName) {
    if (typeof monthName !== 'string') return 0;
    const namePart = monthName.substring(0, 3);
    return MONTH_MAP[namePart] || 0;
};
const checkFilingDelay = (fileDateStr, report, dueDay) => {
  const fileDate = parseDateString(fileDateStr);
  if (!fileDate || !report || !report.month || !report.financialYear) return false;

  const monthIndex = Object.keys(MONTH_MAP).findIndex(m => m.toLowerCase() === report.month.substring(0,3).toLowerCase());
  if (monthIndex === -1) return false;
  
  const yearMatch = report.financialYear.match(/(\d{4})-(\d{2,4})/);
  if (!yearMatch) return false;

  const startYear = parseInt(yearMatch[1], 10);
  const endYear = startYear + 1;
  const year = (monthIndex >= 3) ? startYear : endYear;

  const reportDate = new Date(year, monthIndex, 1);
  reportDate.setMonth(reportDate.getMonth() + 1); // Move to subsequent month
  const dueDate = new Date(reportDate.getFullYear(), reportDate.getMonth(), dueDay);
  dueDate.setHours(23, 59, 59, 999); // Compare against end of day

  return fileDate > dueDate;
};
function exportToCsv(data, filename) {
    if (!data || data.length === 0) {
        alert("No data to export.");
        return;
    }
    const headers = Object.keys(data[0]);
    const csvRows = [headers.join(',')];
    for (const row of data) {
        const values = headers.map(function(header) {
            const escaped = ('' + (row[header] === null || row[header] === undefined ? '' : row[header])).replace(/"/g, '""');
            return `"${escaped}"`;
        });
        csvRows.push(values.join(','));
    }
    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', `${filename}_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
function controlledPrint(elementId, title) {
    const printContent = document.getElementById(elementId)?.outerHTML;
    if (!printContent) {
        console.error(`Element with ID "${elementId}" not found for printing.`);
        alert("Could not find content to print.");
        return;
    }
    const today = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
    const printWindow = window.open('', '', 'height=600,width=800');
    
    printWindow.document.write('<html><head><title>' + title + '</title>');
    
    printWindow.document.write('<style>');
    printWindow.document.write(`
        @media print {
          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
        body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; font-size: 9pt; color: #333; }
        .print-container { padding: 20px; }
        h3 { font-size: 16pt; margin-bottom: 5px; border-bottom: 2px solid #4F46E5; padding-bottom: 5px; color: #312E81; }
        p { font-size: 10pt; color: #666; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; page-break-inside: auto; }
        thead { display: table-header-group; }
        tbody { display: table-row-group; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; }
        th { background-color: #EEF2FF !important; font-weight: 600; color: #312E81; }
        tbody tr:nth-child(even) { background-color: #f9fafb !important; }
        .text-right { text-align: right; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .small { font-size: 0.8rem; color: #555; }
        .reportHeader { margin-bottom: 20px; }
        .text-center { text-align: center; }
        @page { size: A4 landscape; margin: 1cm; }
    `);
    printWindow.document.write('</style></head><body>');
    
    printWindow.document.write('<div class="print-container">');
    printWindow.document.write(printContent);
    
    printWindow.document.write('</div></body></html>');
    printWindow.document.close();
    
    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();
    }
}

// --- From services/cryptoService.ts ---
const cryptoService = (function() {
    let sessionKey = null;
    const KEY_STORAGE_ID = 'gstDashboardCryptoKey';

    const getKey = async function() {
        if (sessionKey) return sessionKey;

        const storedKey = sessionStorage.getItem(KEY_STORAGE_ID);
        if (storedKey) {
            try {
                const jwk = JSON.parse(storedKey);
                sessionKey = await window.crypto.subtle.importKey(
                    "jwk",
                    jwk,
                    { name: "AES-GCM" },
                    true, // allow exporting
                    ["encrypt", "decrypt"]
                );
                return sessionKey;
            } catch (e) {
                console.error("Failed to import stored key, will generate a new one.", e);
                sessionStorage.removeItem(KEY_STORAGE_ID);
            }
        }

        const newKey = await window.crypto.subtle.generateKey(
            { name: "AES-GCM", length: 256 },
            true, // make it exportable
            ["encrypt", "decrypt"]
        );

        const jwk = await window.crypto.subtle.exportKey("jwk", newKey);
        sessionStorage.setItem(KEY_STORAGE_ID, JSON.stringify(jwk));
        sessionKey = newKey;
        return newKey;
    };
    
    const arrayBufferToBase64 = function(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    };

    const base64ToArrayBuffer = function(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    };

    return {
        encrypt: async function(data) {
            if (data === null || data === undefined) return null;
            try {
                const key = await getKey();
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const jsonString = JSON.stringify(data);
                const encodedData = new TextEncoder().encode(jsonString);

                const encryptedContent = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encodedData
                );
                
                const combinedBuffer = new Uint8Array(iv.length + encryptedContent.byteLength);
                combinedBuffer.set(iv, 0);
                combinedBuffer.set(new Uint8Array(encryptedContent), iv.length);

                return arrayBufferToBase64(combinedBuffer.buffer);
            } catch (error) {
                console.error("Encryption failed:", error);
                throw new Error("Could not encrypt data.");
            }
        },
        decrypt: async function(encryptedBase64) {
            if (encryptedBase64 === null || encryptedBase64 === undefined) return null;
            try {
                const key = await getKey();
                const combinedBuffer = base64ToArrayBuffer(encryptedBase64);
                
                const iv = combinedBuffer.slice(0, 12);
                const encryptedContent = combinedBuffer.slice(12);
                
                const decryptedContent = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encryptedContent
                );

                const decodedData = new TextDecoder().decode(decryptedContent);
                return JSON.parse(decodedData);
            } catch (error) {
                console.error("Decryption failed:", error);
                throw new Error("Could not decrypt data. Session key might be invalid or data is corrupt.");
            }
        }
    };
})();

// --- From services/dbService.ts ---
const dbService = (function() {
    let db;
    const openDB = function() {
      return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = function(event) {
          const dbHandle = event.target.result;
          if (!dbHandle.objectStoreNames.contains(STORE_TRANSACTIONS)) {
            dbHandle.createObjectStore(STORE_TRANSACTIONS, { keyPath: 'id' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_ACTIONS)) {
            dbHandle.createObjectStore(STORE_ACTIONS, { keyPath: 'id' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_ASSIGNMENTS)) {
            dbHandle.createObjectStore(STORE_ASSIGNMENTS, { keyPath: 'key' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_VALIDATION_BOOKS)) {
            dbHandle.createObjectStore(STORE_VALIDATION_BOOKS, { keyPath: 'companyName' });
          }
          if (!dbHandle.objectStoreNames.contains(STORE_REPORTS)) {
            dbHandle.createObjectStore(STORE_REPORTS, { keyPath: 'id' });
          }
        };
        request.onsuccess = function(event) {
          db = event.target.result;
          resolve(db);
        };
        request.onerror = function(event) {
          console.error("IndexedDB error:", event.target.error);
          reject(event.target.error);
        };
      });
    };
    const getStore = function(storeName, mode) {
      const transaction = db.transaction(storeName, mode);
      return transaction.objectStore(storeName);
    };
    return {
        saveData: async function(transactions, actions, assignments, reports) {
          await openDB();
          const tx = db.transaction([STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS, STORE_REPORTS], 'readwrite');
          const txStore = tx.objectStore(STORE_TRANSACTIONS);
          const actStore = tx.objectStore(STORE_ACTIONS);
          const assStore = tx.objectStore(STORE_ASSIGNMENTS);
          const reportsStore = tx.objectStore(STORE_REPORTS);

          const [encryptedTxs, encryptedActs, encryptedAss, encryptedReports] = await Promise.all([
              cryptoService.encrypt(transactions),
              cryptoService.encrypt(actions),
              cryptoService.encrypt(assignments),
              cryptoService.encrypt(reports)
          ]);

          txStore.clear();
          actStore.clear();
          assStore.clear();
          reportsStore.clear();
          
          if (encryptedTxs) txStore.put({ id: 'encrypted_data', data: encryptedTxs });
          if (encryptedActs) actStore.put({ id: 'encrypted_actions', data: encryptedActs });
          if (encryptedAss) assStore.put({ key: 'encrypted_assignments', data: encryptedAss });
          if (encryptedReports) reportsStore.put({ id: 'encrypted_reports', data: encryptedReports });

          return new Promise((resolve, reject) => {
            tx.oncomplete = () => resolve() ;
            tx.onerror = () => reject(tx.error);
          });
        },
        loadData: async function() {
            await openDB();
            const tx = db.transaction([STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS, STORE_REPORTS], 'readonly');
            const txStore = tx.objectStore(STORE_TRANSACTIONS);
            const actStore = tx.objectStore(STORE_ACTIONS);
            const assStore = tx.objectStore(STORE_ASSIGNMENTS);
            const reportsStore = tx.objectStore(STORE_REPORTS);

            return new Promise((resolve, reject) => {
                const txRequest = txStore.get('encrypted_data');
                const actRequest = actStore.get('encrypted_actions');
                const assRequest = assStore.get('encrypted_assignments');
                const reportsRequest = reportsStore.get('encrypted_reports');

                tx.oncomplete = async function() {
                    try {
                        const encryptedTxs = txRequest.result?.data;
                        const encryptedActs = actRequest.result?.data;
                        const encryptedAss = assRequest.result?.data;
                        const encryptedReports = reportsRequest.result?.data;

                        const [transactions, actions, assignments, reports] = await Promise.all([
                            encryptedTxs ? cryptoService.decrypt(encryptedTxs) : Promise.resolve([]),
                            encryptedActs ? cryptoService.decrypt(encryptedActs) : Promise.resolve({}),
                            encryptedAss ? cryptoService.decrypt(encryptedAss) : Promise.resolve({}),
                            encryptedReports ? cryptoService.decrypt(encryptedReports) : Promise.resolve([])
                        ]);

                        resolve({ transactions, actions, assignments, reports });
                    } catch(e) {
                        console.error("Failed to load and decrypt data. A new session may require a file upload.", e);
                        resolve({ transactions: [], actions: {}, assignments: {}, reports: [] });
                    }
                };
                tx.onerror = () => reject(tx.error);
            });
        },
        saveValidationBook: async function(book) {
            await openDB();
            const encryptedData = await cryptoService.encrypt(book.data);
            getStore(STORE_VALIDATION_BOOKS, 'readwrite').put({ companyName: book.companyName, data: encryptedData });
        },
        loadAllValidationBooks: async function() {
            await openDB();
            const request = getStore(STORE_VALIDATION_BOOKS, 'readonly').getAll();
            return new Promise((resolve, reject) => {
                request.onsuccess = async function() {
                    try {
                        const encryptedRecords = request.result;
                        if (!encryptedRecords || encryptedRecords.length === 0) {
                            return resolve([]);
                        }
                        const decryptedBooks = await Promise.all(
                            encryptedRecords.map(async function(record) {
                                const decryptedData = await cryptoService.decrypt(record.data);
                                return { companyName: record.companyName, data: decryptedData };
                            })
                        );
                        resolve(decryptedBooks);
                    } catch (e) {
                        console.error("Failed to decrypt validation books", e);
                        resolve([]);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        },
        clearAllData: async function() {
          await openDB();
          const storesToClear = [STORE_TRANSACTIONS, STORE_ACTIONS, STORE_ASSIGNMENTS, STORE_VALIDATION_BOOKS, STORE_REPORTS];
          const tx = db.transaction(storesToClear, 'readwrite');
          storesToClear.forEach(store => tx.objectStore(store).clear());
        }
    };
})();

/* 
 * WORKER REMOVAL NOTE:
 * ==================================================================================
 * The original implementation used a Web Worker for Excel parsing, which caused
 * "Worker error: Uncaught SyntaxError: Invalid or unexpected token" when the worker
 * script failed to load (e.g., due to CSP restrictions, file:// protocol, or 404 errors).
 * 
 * This has been replaced with direct in-browser parsing using FileReader.readAsArrayBuffer
 * and XLSX.read() in the main thread. This approach:
 * - Avoids worker-related errors completely
 * - Works reliably with file:// protocol for local testing
 * - Maintains all existing features and data processing logic
 * - Uses the SheetJS library (xlsx.full.min.js) already loaded via CDN in HTML head
 * 
 * To revert to worker-based parsing (if needed for performance with very large files):
 * 1. Restore the fileProcessorWorkerScript code (see git history)
 * 2. Replace the processMainFile implementation with the worker-based version
 * 3. Ensure worker scripts can load in your deployment environment
 * 4. Test thoroughly with CSP headers and various protocols (http/https/file)
 * ==================================================================================
 */

// --- From services/fileProcessor.ts ---
const fileProcessor = (function() {
    // Helper function for parsing currency values (moved from worker)
    const parseCurrency = (v) => {
        if (typeof v === 'number') return v;
        if (typeof v !== 'string') return 0;
        const c = v.replace(/[^0-9.-]+/g, "");
        const n = parseFloat(c);
        return isNaN(n) ? 0 : n;
    };

    return {
        // Direct in-browser Excel parsing (no worker) - FIXES WORKER ERROR
        // This implementation processes Excel files in the main thread, avoiding
        // all worker-related errors while maintaining identical functionality
        processMainFile: function(file, onProgress) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    if (!e.target?.result) {
                        throw new Error("File content is empty. Please select a valid .xlsx file.");
                    }
                    
                    onProgress(0.1, 'Reading file contents...');
                    
                    // Parse Excel file directly in main thread using SheetJS
                    const data = new Uint8Array(e.target.result);
                    onProgress(0.2, 'Parsing Excel workbook...');
                    
                    // Verify XLSX library is loaded (from CDN in HTML head)
                    if (typeof XLSX === 'undefined') {
                        throw new Error("SheetJS library not loaded. Please check your internet connection or serve this page over http/https.");
                    }
                    
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    const sheetName = 'Transactions';
                    if (!workbook.SheetNames.includes(sheetName)) {
                      throw new Error(`Sheet "${sheetName}" not found in the Excel file. Available sheets: ${workbook.SheetNames.join(', ')}`);
                    }
                    const worksheet = workbook.Sheets[sheetName];
                    
                    onProgress(0.4, 'Converting sheet to JSON...');
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
                    
                    if (!Array.isArray(rawData) || rawData.length === 0) {
                      throw new Error("No data found in the 'Transactions' sheet. Please check the file format.");
                    }
                    
                    const processedData = [];
                    const totalRows = rawData.length;

                    // Process each row (same logic as worker version)
                    for (let i = 0; i < totalRows; i++) {
                      const row = rawData[i];
                      if (typeof row !== 'object' || row === null) continue;
                      const newRow = { id: `row_${i}` };
                      Object.keys(row).forEach((key) => {
                          if (key && !key.startsWith('__EMPTY')) {
                              newRow[key.trim()] = typeof row[key] === 'string' ? row[key].trim() : row[key];
                          }
                      });
                      // Normalize and validate Type
                      let type = String(newRow['Type'] ?? newRow['Tag (Type)'] ?? "").trim();
                      // Normalize case and spaces
                      type = type.replace(/\s+/g, '_');
                      // Validate against known types
                      if (type && !VALID_TYPES.includes(type)) {
                        console.warn(`Row ${i}: Unknown Type "${type}". Keeping as-is but may affect KPI calculations.`);
                      }
                      newRow['Type'] = type;
                      newRow['Sum of Taxable Value (2B)'] = parseCurrency(newRow['Sum of Taxable Value (2B)']);
                      newRow['Sum of IGST (2B)'] = parseCurrency(newRow['Sum of IGST (2B)']);
                      newRow['Sum of CGST (2B)'] = parseCurrency(newRow['Sum of CGST (2B)']);
                      newRow['Sum of SGST (2B)'] = parseCurrency(newRow['Sum of SGST (2B)']);
                      newRow['Total GST'] = (newRow['Sum of IGST (2B)'] ?? 0) + (newRow['Sum of CGST (2B)'] ?? 0) + (newRow['Sum of SGST (2B)'] ?? 0);
                      const docDateObj = parseDateString(newRow['Document Date (2B)']);
                      if (docDateObj) {
                          newRow['Document Date (2B)'] = docDateObj.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
                          newRow['Financial Year'] = getFinancialYear(docDateObj);
                      } else {
                          newRow['Document Date (2B)'] = '';
                          newRow['Financial Year'] = 'Unknown';
                      }
                      const remarksKey = Object.keys(newRow).find((k) => k.toLowerCase() === 'remarks' || k.toLowerCase() === 'remark');
                      newRow['Remarks'] = String((remarksKey ? newRow[remarksKey] : '') ?? '');
                      newRow['Supplier Name'] = String(newRow['Supplier Name'] ?? 'Unknown');
                      newRow['Document Number (2B)'] = String(newRow['Document Number (2B)'] ?? '');
                      newRow['Company Name'] = String(newRow['Company Name'] ?? 'Unknown');
                      newRow['Month'] = String(newRow['Month'] ?? 'Unknown');
                      processedData.push(newRow);

                      // Report progress every 200 rows
                      if (i % 200 === 0) {
                          const progress = i / totalRows;
                          onProgress(0.5 + progress * 0.5, `Processing rows... ${i} / ${totalRows}`);
                      }
                    }
                    
                    onProgress(1.0, 'Processing complete!');
                    resolve(processedData);
                } catch (error) {
                    console.error("Excel parsing error:", error);
                    let errorMessage = error.message;
                    
                    // Provide helpful error messages based on common issues
                    if (errorMessage.includes("XLSX") || errorMessage.includes("undefined")) {
                        errorMessage = "âš ï¸ SheetJS library failed to load. Common causes:\n" +
                                     "â€¢ No internet connection (CDN blocked)\n" +
                                     "â€¢ Opening file:// directly in browser\n" +
                                     "â€¢ Content Security Policy restrictions\n\n" +
                                     "ğŸ’¡ Solution: Serve this page over http/https using a local server:\n" +
                                     "   python -m http.server 8000  (or similar)";
                    } else if (errorMessage.includes("Sheet")) {
                        errorMessage = errorMessage + "\n\nğŸ’¡ Please ensure your Excel file has a 'Transactions' sheet with the expected columns.";
                    }
                    
                    reject(new Error(errorMessage));
                }
            };

            reader.onerror = function(error) {
                console.error("FileReader error:", error);
                reject(new Error("Failed to read the file. Please try again with a different file."));
            };

            // Read the file as ArrayBuffer for SheetJS (no worker involved)
            reader.readAsArrayBuffer(file);
          });
        },
        processBooksFile: function(file) {
            return new Promise((resolve, reject) => {
                const companyNameMatch = file.name.match(/Books_([^_]+)\.xlsx?/i);
                if (!companyNameMatch || !companyNameMatch[1]) {
                    return reject(new Error("Books filename must be in the format 'Books_CompanyName.xlsx'"));
                }
                const companyName = companyNameMatch[1].replace(/_/g, ' ');
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (!e.target?.result || !(e.target.result instanceof ArrayBuffer)) return reject(new Error("File content is empty or not an ArrayBuffer."));
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        if (!sheetName) return reject(new Error("No sheets found in Books file."));
                        const worksheet = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(worksheet, {raw: false, defval: null});
                        if (!Array.isArray(rawData) || rawData.length === 0) {
                            return reject(new Error(`No data found in '${sheetName}' sheet.`));
                        }
                        resolve({ companyName, data: rawData });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        },
        processConsolidatedReport: function(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        if (!e.target?.result || !(e.target.result instanceof ArrayBuffer)) {
                            throw new Error("File content is empty.");
                        }
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        if (!sheetName) {
                            throw new Error("No sheets found in the report file.");
                        }
                        const worksheet = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: null });
                        
                        if (!Array.isArray(rawData) || rawData.length === 0) {
                            throw new Error(`No data found in '${sheetName}' sheet.`);
                        }

                        resolve(rawData);

                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        },
    };
})();

// --- From services/geminiService.ts ---
const geminiService = (function() {
    let ai;
    try {
        if (typeof process !== 'undefined' && process.env && process.env.API_KEY && window.genai) {
            ai = new window.genai.GoogleGenAI({ apiKey: process.env.API_KEY });
        }
    } catch (e) {
        console.error("Gemini AI could not be initialized. API_KEY might be missing.", e);
    }

    const getFilterFromQueryOffline = async function(query, options) {
        const lowerQuery = query.toLowerCase();
        const response = { action: 'unknown' };
        response.action = 'filter';
        const foundFilters = [];
        if (options.companies) {
            options.companies.forEach(function(c) {
                if (lowerQuery.includes(c.toLowerCase())) {
                    response.company = [c];
                    foundFilters.push(c);
                }
            });
        }
        if (options.months) {
            options.months.forEach(function(m) {
                if (lowerQuery.includes(m.toLowerCase())) {
                    response.month = [m];
                    foundFilters.push(m);
                }
            });
        }
        if(options.tags) {
          options.tags.forEach(function(t) {
              if (lowerQuery.includes(t.replace(/_/g, ' ').toLowerCase())) {
                  response.tag = [t];
                  foundFilters.push(t);
              }
          });
        }
        if (foundFilters.length > 0) {
            response.matchedText = foundFilters.join(', ');
        } else {
            response.action = 'unknown';
            response.matchedText = "Sorry, I couldn't find any matching filters for that.";
        }
        return response;
    };

    return {
        isAvailable: function() { return !!ai },
        getFilterFromQuery: async function(query, options) {
            if (!this.isAvailable()) {
                console.warn("Gemini not available, using offline filter logic.");
                return getFilterFromQueryOffline(query, options);
            }

            const systemInstruction = `You are an intelligent assistant for a GST dashboard. Your task is to interpret the user's natural language query and translate it into a JSON object for filtering data. Respond ONLY with a valid JSON object and nothing else.
The JSON object should have an 'action' key, which can be 'filter' or 'details'.
If the action is 'filter', include one or more of the following keys: 'company', 'financialYear', 'month', 'tag'. The values for these keys must be an array of strings, and each string must be one of the provided options.
If the user asks for details about a specific supplier, set 'action' to 'details' and add a 'supplier' key with the supplier's name as a string.
If you cannot determine any filters or actions, return an empty JSON object {}.
If multiple values for a filter are mentioned (e.g. "show Stark and Oscorp"), include both in the array.`;
            
            const userPrompt = `User query: "${query}"\n\nAvailable filter options:\n- Companies: ${JSON.stringify(options.companies)}\n- Financial Years: ${JSON.stringify(options.financialYears)}\n- Months: ${JSON.stringify(options.months)}\n- Tags: ${JSON.stringify(options.tags)}`;

            try {
              const response = await ai.models.generateContent({
                  model: 'gemini-2.5-flash',
                  contents: userPrompt,
                  config: {
                    systemInstruction: systemInstruction,
                    responseMimeType: "application/json",
                  }
              });
              const parsedJson = JSON.parse(response.text);
              if (parsedJson.action === 'filter') {
                  const matched = Object.values(parsedJson).flat().join(', ');
                  parsedJson.matchedText = matched || "filters cleared";
              } else if (parsedJson.action === 'details') {
                  parsedJson.matchedText = `details for ${parsedJson.supplier}`;
              }
              return parsedJson;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return { action: 'unknown', matchedText: "Sorry, I had trouble understanding that." };
            }
        },
        getAnalysis: async function(prompt, contextData) {
            if (!this.isAvailable()) {
                return "AI analysis is not available. Please ensure your API_KEY is configured.";
            }

            const fullPrompt = `Based on the following sample of GST transaction data, please provide a concise analysis answering the user's question.\n\nData Sample (up to 25 rows):\n\`\`\`json\n${JSON.stringify(contextData.slice(0, 25), null, 2)}\n\`\`\`\n\nUser's Question: ${prompt}`;
            
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-pro',
                    contents: fullPrompt,
                    config: {
                      thinkingConfig: { thinkingBudget: 32768 }
                    }
                });
                return response.text;
            } catch (error) {
                console.error("Error in AI analysis:", error);
                return `An error occurred while generating the analysis: ${error.message}`;
            }
        }
    };
})();

// --- 3D Tilt Parallax Utility ---
// Adds smooth 3D tilt effect to elements with 'tilt-card' or 'tilt-btn' class
// Gracefully degrades if pointer events are unavailable
const tiltEffect = (function() {
    const initTilt = (element) => {
        if (!element || typeof element.addEventListener !== 'function') return;
        
        const maxRotation = 8; // degrees
        
        const handleMouseMove = (e) => {
            const rect = element.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const rotateX = ((y - centerY) / centerY) * maxRotation;
            const rotateY = ((centerX - x) / centerX) * maxRotation;
            
            element.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
        };
        
        const handleMouseLeave = () => {
            element.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)';
        };
        
        element.addEventListener('mousemove', handleMouseMove);
        element.addEventListener('mouseleave', handleMouseLeave);
        
        // Return cleanup function
        return () => {
            element.removeEventListener('mousemove', handleMouseMove);
            element.removeEventListener('mouseleave', handleMouseLeave);
        };
    };
    
    // Auto-initialize tilt on elements with tilt classes
    const autoInit = () => {
        try {
            const tiltElements = document.querySelectorAll('.tilt-card, .tilt-btn');
            tiltElements.forEach(element => initTilt(element));
        } catch (e) {
            console.warn('Tilt effect initialization failed (graceful degradation):', e);
        }
    };
    
    // Initialize when DOM is ready
    if (typeof document !== 'undefined') {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', autoInit);
        } else {
            autoInit();
        }
    }
    
    return { initTilt, autoInit };
})();


// --- React Components ---
// ErrorBoundary is now defined earlier in the code (line 366)

const SvgIcon = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: 2 }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));
const SvgIconThick = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", stroke: "currentColor", strokeWidth: 3 }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));
const SvgIconUpDown = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", strokeWidth: 1.5, stroke: "currentColor" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));
const SvgIconUpDownCompact = ({ d, className }) => e('svg', { xmlns: "http://www.w3.org/2000/svg", className, fill: "none", viewBox: "0 0 24 24", strokeWidth: 2.5, stroke: "currentColor" }, e('path', { strokeLinecap: "round", strokeLinejoin: "round", d }));

const Icons = {
    BriefcaseIcon: ({ className }) => e(SvgIcon, { className, d: "M20.25 14.15v4.004a.75.75 0 01-.75.75H4.5a.75.75 0 01-.75-.75v-4.004M18 9.348a2.25 2.25 0 00-2.25-2.25h-1.25A2.25 2.25 0 0012 9.348V11.25h6V9.348zM12 9.348a2.25 2.25 0 01-2.25-2.25h-1.25A2.25 2.25 0 016 9.348V11.25h6V9.348z" }),
    ShieldIcon: ({ className }) => e(SvgIcon, { className, d: "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5L12 1z" }),
    FileUploadIcon: ({ className }) => e(SvgIcon, { className, d: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" }),
    DatabaseIcon: ({ className }) => e(SvgIcon, { className, d: "M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7a8 8 0 0116 0M12 11a8 8 0 00-8 4" }),
    TrashIcon: ({ className }) => e(SvgIcon, { className, d: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" }),
    ChatBubbleIcon: ({ className }) => e(SvgIcon, { className, d: "M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 8 8z" }),
    SparklesIcon: ({ className }) => e(SvgIcon, { className, d: "M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0m-8.486 2.828L3 21m18-18l-2.122 2.122" }),
    ArrowUpIcon: ({ className }) => e(SvgIconThick, { className, d: "M5 15l7-7 7 7" }),
    ArrowDownIcon: ({ className }) => e(SvgIconThick, { className, d: "M19 9l-7 7-7-7" }),
    ChevronUpDownIcon: ({ className }) => e(SvgIconUpDown, { className, d: "M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" }),
    DocumentMinusIcon: ({ className }) => e(SvgIcon, { className, d: "M15 12H9m12 4a9 9 0 11-18 0 9 9 0 0118 0z" }),
    ReceiptIcon: ({ className }) => e(SvgIcon, { className, d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" }),
    CheckCircleIcon: ({ className }) => e(SvgIcon, { className, d: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" }),
    CashIcon: ({ className }) => e(SvgIcon, { className, d: "M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" }),
    TrendingUpIcon: ({ className }) => e(SvgIcon, { className, d: "M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" }),
    PrinterIcon: ({ className }) => e(SvgIcon, { className, d: "M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm2-9V5a2 2 0 00-2-2H9a2 2 0 00-2 2v3m4-3h4" }),
    ChevronUpDownIconCompact: ({ className }) => e(SvgIconUpDownCompact, { className, d: "M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" }),
    FunnelIcon: ({ className }) => e(SvgIcon, { className, d: "M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L14 12.414V17a1 1 0 01-.293.707l-4 4A1 1 0 018 21v-8.586L3.293 6.707A1 1 0 013 6V4z" }),
    HomeIcon: ({ className }) => e(SvgIcon, { className, d: "M2.25 12l8.954-8.955a.75.75 0 011.06 0l8.955 8.955a.75.75 0 01-1.06 1.06L12 4.061 3.31 13.06a.75.75 0 01-1.06-1.06zM12 21.75v-8.25" }),
    SunIcon: ({ className }) => e(SvgIcon, { className, d: "M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" }),
    MoonIcon: ({ className }) => e(SvgIcon, { className, d: "M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" }),
    BookmarkIcon: ({ className }) => e(SvgIcon, { className, d: "M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" }),
    XMarkIcon: ({ className }) => e(SvgIcon, { className, d: "M6 18L18 6M6 6l12 12" }),
    ArrowLeftIcon: ({ className }) => e(SvgIcon, { className, d: "M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" }),
    DocumentPlusIcon: ({ className }) => e(SvgIcon, { className, d: "M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" }),
    PencilIcon: ({ className }) => e(SvgIcon, { className, d: "M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" }),
    DocumentCheckIcon: ({ className }) => e(SvgIcon, { className, d: "M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" }),
    BuildingOfficeIcon: ({ className }) => e(SvgIcon, { className, d: "M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H15m-1.5 3H15m-1.5 3H15M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" }),
    DocumentTextIcon: ({ className }) => e(SvgIcon, { className, d: "M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" }),
    EnvelopeIcon: ({ className }) => e(SvgIcon, { className, d: "M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" }),
};

const Button = ({ variant = 'primary', children, icon, className, ...props }) => {
  const variantClasses = {
    primary: 'btn-pro-primary',
    secondary: 'btn-pro-secondary',
    danger: 'bg-red-600 hover:bg-red-700 text-white border-none rounded-md px-5 py-2.5 font-medium text-sm shadow-sm transition-all cursor-pointer',
    ghost: 'bg-transparent text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 border border-transparent rounded-md px-4 py-2 font-medium text-sm transition-fast cursor-pointer',
    'danger-ghost': 'bg-transparent text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 border border-transparent rounded-md px-4 py-2 font-medium text-sm transition-fast cursor-pointer'
  };
  const finalClassName = `inline-flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed ${variantClasses[variant] || variantClasses.primary} ${className || ''}`;
  
  return e('button', { className: finalClassName, ...props },
    icon && e('span', { className: 'mr-2 -ml-1 h-5 w-5' }, icon),
    children
  );
};

const ProgressBar = ({ progress }) => {
    return e('div', { className: 'w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5' },
        e('div', { 
            className: 'bg-primary h-2.5 rounded-full transition-all duration-300 ease-in-out', 
            style: { width: `${progress}%` } 
        })
    );
};

const ProductCard = ({ title, description, icon, onClick, earlyAccess = false }) => {
  return e('div', { 
      onClick,
      className: 'pro-card pro-card-elevated relative p-6 cursor-pointer group overflow-hidden' 
  },
      earlyAccess && e('div', { className: 'absolute top-4 right-4 badge badge-primary' }, 'Early Access'),
      e('div', { className: 'flex flex-col h-full' },
          e('div', { className: 'mb-4 p-3 bg-gradient-to-br from-primary-500 to-primary-600 text-white rounded-lg w-fit' }, icon),
          e('div', { className: 'flex-grow' },
              e('h3', { className: 'text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2' }, title),
              e('p', { className: 'text-sm text-gray-600 dark:text-gray-400' }, description)
          )
      )
  );
};

const KpiCard = ({ title, value, subValue, icon, color, onClick }) => {
  const colorClasses = {
      red: 'kpi-card-red',
      yellow: 'kpi-card-yellow',
      blue: 'kpi-card-blue',
      green: 'kpi-card-green',
      default: 'kpi-card-blue'
  };
  const valueColorClasses = {
      red: 'text-red-600 dark:text-red-400',
      yellow: 'text-amber-600 dark:text-amber-400',
      blue: 'text-blue-600 dark:text-blue-400',
      green: 'text-green-600 dark:text-green-400',
      default: 'text-gray-900 dark:text-gray-100'
  };
  return e('div', { onClick, className: `kpi-card ${colorClasses[color] || colorClasses.default} ${onClick ? 'cursor-pointer' : ''}` },
      e('div', { className: 'flex items-start justify-between' },
          e('div', { className: 'flex-1' },
              e('div', { className: 'text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2' }, title),
              e('div', { className: `text-3xl font-bold mb-1 ${valueColorClasses[color] || valueColorClasses.default}` }, value),
              subValue && e('div', { className: 'text-sm text-gray-500 dark:text-gray-400' }, subValue)
          ),
          icon && e('div', { className: 'flex-shrink-0 ml-4 p-3 rounded-lg bg-gray-50 dark:bg-gray-800' }, icon)
      )
  );
};

const LoginPage = ({ onLoginSuccess }) => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = (e) => {
        e.preventDefault();
        if (username === 'xxx' && password === 'xxx') {
            onLoginSuccess();
        } else {
            setError('Invalid username or password.');
        }
    };

    return e('div', { className: 'min-h-screen flex items-center justify-center bg-gradient-to-br from-primary-600 via-primary-700 to-purple-700 p-4' },
        e('div', { className: 'w-full max-w-md' },
            e('div', { className: 'text-center mb-8' },
                e('div', { className: 'mx-auto flex h-20 w-20 items-center justify-center rounded-2xl bg-white shadow-2xl mb-4 transform hover:scale-105 transition-transform' },
                    e('span', { className: 'text-3xl font-bold bg-gradient-to-br from-primary-600 to-purple-600 bg-clip-text text-transparent' }, 'G')
                ),
                e('h1', { className: 'text-4xl font-bold text-white mb-2' }, 'GST Portal'),
                e('p', { className: 'text-primary-100' }, 'Reconciliation & Compliance System')
            ),
            e('div', { className: 'pro-card p-8 shadow-2xl' },
                e('form', { onSubmit: handleLogin, className: 'space-y-6' },
                    e('div', null,
                        e('label', { htmlFor: 'username', className: 'block text-sm font-medium text-slate-700 dark:text-slate-300' }, 'Username'),
                        e('div', { className: 'mt-1' },
                            e(TextInput, { id: 'username', type: 'text', required: true, value: username, onChange: (ev) => setUsername(ev.target.value) })
                        )
                    ),
                    e('div', null,
                        e('label', { htmlFor: 'password', className: 'block text-sm font-medium text-slate-700 dark:text-slate-300' }, 'Password'),
                        e('div', { className: 'mt-1' },
                            e(TextInput, { id: 'password', type: 'password', required: true, value: password, onChange: (ev) => setPassword(ev.target.value) })
                        )
                    ),
                    error && e('p', { className: 'text-sm text-red-600' }, error),
                    e('div', null,
                        e(Button, { type: 'submit', className: 'w-full justify-center text-base py-3' }, 'Sign In')
                    )
                )
            )
        )
    );
};

const MainLandingPage = ({ onNavigateToGst }) => {
    const cards = [
        { 
            title: 'GST', 
            description: 'The ultimate app for all your Goods & Services Tax compliance needs.',
            icon: e(Icons.BriefcaseIcon, { className: 'w-10 h-10 text-red-600' }),
            onClick: onNavigateToGst
        },
        { 
            title: 'TDS',
            description: 'End-to-end TDS filing, challan payments, reports, certificate generation and more.',
            icon: e(Icons.CashIcon, { className: 'w-10 h-10 text-orange-500' }),
            onClick: () => alert('TDS module coming soon!')
        },
        { 
            title: 'Notice Tracker',
            description: 'Review and track all your notices from the government.',
            icon: e(Icons.ShieldIcon, { className: 'w-10 h-10 text-teal-500' }),
            onClick: () => alert('Notice Tracker coming soon!')
        }
    ];

    return e('div', { className: 'min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-purple-50 dark:from-gray-900 dark:via-gray-900 dark:to-gray-800' },
        e('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12' },
            e('div', { className: 'text-center mb-16' },
                e('div', { className: 'inline-flex items-center gap-3 mb-6' },
                    e('div', { className: 'h-16 w-16 rounded-2xl bg-gradient-to-br from-primary-600 to-purple-600 flex items-center justify-center shadow-xl transform hover:scale-105 transition-transform' },
                        e('span', { className: 'text-2xl font-bold text-white' }, 'C')
                    ),
                    e('h1', { className: 'text-5xl font-bold bg-gradient-to-r from-gray-900 via-primary-600 to-purple-600 dark:from-white dark:via-primary-400 dark:to-purple-400 bg-clip-text text-transparent' }, 'Compliance Cloud')
                ),
                e('h2', { className: 'text-2xl font-semibold text-gray-700 dark:text-gray-300 mb-3' }, 'Welcome, Harish'),
                e('p', { className: 'text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto' }, 'Enterprise-grade compliance and business intelligence platform for modern businesses')
            ),
            e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8' },
                cards.map(card => e(ProductCard, { key: card.title, ...card }))
            )
        )
    );
};

const StartupScreen = ({ onFileSelect, onLoadSaved, onClearSaved, onLoadMockData, statusMessage, isLoading, progress, onNavigateToHome }) => {
  const fileInputRef = useRef(null);
  const [dragActive, setDragActive] = useState(false);
  
  const handleFileChange = (event) => {
    const file = event.target.files?.[0];
    if (file) {
      onFileSelect(file);
    }
  };
  
  const handleUploadClick = () => {
    fileInputRef.current?.click();
  };

  // Drag-and-drop support
  const handleDrag = (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === "dragenter" || e.type === "dragover") {
      setDragActive(true);
    } else if (e.type === "dragleave") {
      setDragActive(false);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      const file = e.dataTransfer.files[0];
      // Validate file type
      if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
        onFileSelect(file);
      } else {
        alert('Please upload a valid Excel file (.xlsx or .xls)');
      }
    }
  };

  return e('div', { className: 'flex items-center justify-center min-h-screen p-4 relative' },
    e('div', { className: 'absolute top-4 left-4' },
      e(Button, { onClick: onNavigateToHome, variant: 'secondary', icon: e(Icons.HomeIcon, { className: 'h-5 w-5' }) }, 'Home')
    ),
    e('div', { className: 'w-full max-w-md text-center' },
      e('div', { className: 'mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-primary-light dark:bg-primary/20 mb-5' },
        e(Icons.ReceiptIcon, { className: 'h-8 w-8 text-primary' })
      ),
      e('h1', { className: 'text-3xl font-bold text-slate-800 dark:text-slate-100' }, 'GST Reconciliation Dashboard'),
      e('p', { className: 'mt-2 text-slate-600 dark:text-slate-400' }, 'Upload an Excel file or load previously saved data to begin.'),
      e('div', { className: 'mt-8 bg-white dark:bg-slate-800 p-8 rounded-xl shadow-md border border-slate-200 dark:border-slate-700' },
        isLoading ? 
          e('div', { className: 'space-y-4 py-8' },
            e('p', { className: 'text-center text-slate-600 dark:text-slate-300 font-medium' }, statusMessage),
            e(ProgressBar, { progress: progress })
          ) :
          e(Fragment, null,
            e('input', { type: 'file', ref: fileInputRef, className: 'hidden', accept: '.xlsx, .xls', onChange: handleFileChange }),
            // Drag-and-drop upload area
            e('div', { 
              className: `relative border-2 border-dashed rounded-lg p-8 mb-4 transition-all ${
                dragActive 
                  ? 'border-primary bg-primary/5 dark:bg-primary/10' 
                  : 'border-slate-300 dark:border-slate-600 hover:border-primary/50'
              }`,
              onDragEnter: handleDrag,
              onDragLeave: handleDrag,
              onDragOver: handleDrag,
              onDrop: handleDrop,
              onClick: handleUploadClick
            },
              e('div', { className: 'flex flex-col items-center cursor-pointer' },
                e(Icons.FileUploadIcon, { className: `h-12 w-12 ${dragActive ? 'text-primary' : 'text-slate-400 dark:text-slate-500'}` }),
                e('p', { className: 'mt-3 text-sm font-medium text-slate-700 dark:text-slate-300' }, 
                  dragActive ? 'Drop Excel file here' : 'Drag & drop Excel file here'
                ),
                e('p', { className: 'mt-1 text-xs text-slate-500 dark:text-slate-400' }, 'or click to browse')
              )
            ),
            e('div', { className: 'space-y-3' },
              e(Button, { onClick: onLoadSaved, variant: 'secondary', icon: e(Icons.DatabaseIcon, { className: 'h-5 w-5' }), className: 'w-full justify-center text-base py-3' }, 'Use Saved Data'),
              e(Button, { onClick: onLoadMockData, variant: 'secondary', className: 'w-full justify-center text-base py-3' }, 'Load Mock Data')
            ),
            e('div', { className: 'mt-6 border-t dark:border-slate-600 pt-6' },
              e(Button, { onClick: onClearSaved, variant: 'danger-ghost', icon: e(Icons.TrashIcon, { className: 'w-4 h-4' }) }, 'Clear All Saved Data')
            )
          )
      ),
      !isLoading && statusMessage && e('p', { className: 'mt-6 text-sm text-center text-slate-600 dark:text-slate-400 h-5' }, statusMessage)
    )
  );
};

const TextInput = (props) => {
    return e('input', { ...props, className: `pro-input ${props.className || ''}` });
};

const Checkbox = ({ id, checked, onChange, label, ...props }) => {
    return e('div', { className: 'flex items-center' },
        e('input', { id, type: 'checkbox', checked, onChange, className: 'h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary bg-transparent dark:bg-slate-700', ...props }),
        label && e('label', { htmlFor: id, className: 'ml-2 block text-sm text-slate-900 dark:text-slate-200' }, label)
    );
};

const Select = ({ label, value, options, onChange, className = '', ...props }) => {
  const [isOpen, setIsOpen] = useState(false);
  const wrapperRef = useRef(null);
  const selectedOption = value === 'All' ? 'All' : options.find(opt => { 
      if (typeof opt === 'object') return opt.value === value;
      return opt === value;
  }) || (options[0] || 'All');
  
  const handleSelect = (option) => {
    const selectedValue = typeof option === 'object' ? option.value : option;
    onChange({ target: { value: selectedValue, name: props.name } }); // Mimic event object
    setIsOpen(false);
  };

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);
  
  const renderOptions = Array.isArray(options) && options.every(o => typeof o !== 'object') ? ['All', ...options] : options;
  const getDisplay = (opt) => typeof opt === 'object' ? opt.label : opt;
  
  return e('div', { className: `relative ${className}`, ref: wrapperRef },
    label && e('label', { className: 'block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1' }, label),
    e('button', { type: 'button', onClick: () => setIsOpen(!isOpen), ...props, className: 'relative w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm text-slate-900 dark:text-slate-200' },
      e('span', { className: 'block truncate' }, getDisplay(selectedOption)),
      e('span', { className: 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none' }, e(Icons.ChevronUpDownIconCompact, { className: 'h-5 w-5 text-gray-400' }))
    ),
    isOpen && e('div', { className: 'absolute z-30 mt-1 w-full bg-white dark:bg-slate-800 shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm' },
      renderOptions.map((option, idx) => { 
          const optionValue = typeof option === 'object' ? option.value : option;
          return e('div', { key: optionValue+idx, onClick: () => handleSelect(option), className: 'cursor-default select-none relative py-2 pl-3 pr-9 text-gray-900 dark:text-gray-200 hover:bg-primary-light dark:hover:bg-slate-700 hover:text-primary-dark dark:hover:text-primary' },
        e('span', { className: `font-normal block truncate ${value === optionValue ? 'font-semibold' : ''}` }, getDisplay(option))
      )})
    )
  );
};

const MultiSelect = ({ label, values, options, onChange, className = '' }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const wrapperRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleToggleOption = (option) => {
    const newValues = values.includes(option) ? values.filter(v => v !== option) : [...values, option];
    onChange(newValues);
  };
  
  const filteredOptions = useMemo(() => {
      if (!searchTerm) return options;
      return options.filter(opt => String(opt).toLowerCase().includes(searchTerm.toLowerCase()));
  }, [options, searchTerm]);

  const displayValue = values.length === 0 ? 'All' :
                       values.length === options.length ? 'All' :
                       values.length === 1 ? values[0] :
                       `${values.length} selected`;

  return e('div', { className: `relative ${className}`, ref: wrapperRef },
    label && e('label', { className: 'block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1' }, label),
    e('button', { type: 'button', onClick: () => setIsOpen(!isOpen), className: 'relative w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm text-slate-900 dark:text-slate-200' },
      e('span', { className: 'block truncate' }, displayValue),
      e('span', { className: 'absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none' }, e(Icons.ChevronUpDownIconCompact, { className: 'h-5 w-5 text-gray-400' }))
    ),
    isOpen && e('div', { className: 'absolute z-50 mt-1 w-full bg-white dark:bg-slate-800 shadow-lg max-h-80 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm flex flex-col' },
      e('div', { className: 'p-2 border-b dark:border-slate-700' }, 
          e(TextInput, { placeholder: `Search...`, value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), className: 'w-full' })
      ),
      e('div', { className: 'flex-grow overflow-y-auto' },
          filteredOptions.map(option => e('div', { key: option, onClick: (e) => { e.stopPropagation(); handleToggleOption(option); }, className: 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 dark:text-gray-200 hover:bg-primary-light dark:hover:bg-slate-700 flex items-center' },
              e('input', { type: 'checkbox', readOnly: true, checked: values.includes(option), className: 'h-4 w-4 rounded border-slate-300 dark:border-slate-600 text-primary focus:ring-primary mr-3' }),
              e('span', { className: 'font-normal block truncate' }, option)
          ))
      ),
      e('div', { className: 'flex justify-between p-2 border-t dark:border-slate-700' },
          e('button', { onClick: (e) => { e.stopPropagation(); onChange(options); }, className: 'text-sm text-primary hover:underline' }, "Select All"),
          e('button', { onClick: (e) => { e.stopPropagation(); onChange([]); }, className: 'text-sm text-primary hover:underline' }, "Clear All"),
      )
    )
  );
};

const ActionSelect = ({ rowId, value, onChange }) => {
    const handleChange = (e) => {
        onChange(rowId, e.target.value);
    };
    return e(Select, { value, options: ACTION_OPTIONS.filter(o => o !== 'None'), onChange: handleChange, className: "w-40" });
};

const Chatbot = ({ slicerOptions, onFilterChange, setPrintModalData, allData }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [messages, setMessages] = useState([{ text: "Hi! I'm an AI assistant. How can I help you filter or analyze the GST data? (e.g., 'show Stark Industries in June', 'details for Wayne Enterprises')", sender: 'bot' }]);
    const [input, setInput] = useState('');
    const messagesEndRef = useRef(null);

    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    const handleSend = async () => {
        if (!input.trim() || !geminiService.isAvailable()) {
            if(!geminiService.isAvailable()) {
                alert("AI Assistant is not available. Please configure your API_KEY.");
            }
            return;
        };
        const userMessage = { text: input, sender: 'user' };
        setMessages(prev => [...prev, userMessage, { text: 'Thinking...', sender: 'bot', isThinking: true }]);
        setInput('');

        const interpretation = await geminiService.getFilterFromQuery(userMessage.text, slicerOptions);

        setMessages(prev => prev.filter(m => !m.isThinking));

        if (interpretation.action === 'filter') {
            const newFilters = {};
            if (interpretation.company) newFilters.company = interpretation.company;
            if (interpretation.financialYear) newFilters.financialYear = interpretation.financialYear;
            if (interpretation.month) newFilters.month = interpretation.month;
            if (interpretation.tag) newFilters.tag = interpretation.tag;
            onFilterChange(newFilters);
            setMessages(prev => [...prev, { text: `OK, I've applied the filters for: ${interpretation.matchedText}. Check the dashboard.`, sender: 'bot' }]);
        } else if (interpretation.action === 'details' && interpretation.supplier) {
            const supplierData = allData.filter(row => row['Supplier Name'] === interpretation.supplier);
              if (supplierData.length > 0) {
                setPrintModalData({ isOpen: true, category: `Details for ${interpretation.supplier}`, data: supplierData });
                setMessages(prev => [...prev, { text: `Showing details for ${interpretation.supplier}.`, sender: 'bot' }]);
            } else {
                setMessages(prev => [...prev, { text: `I couldn't find any data for a supplier named "${interpretation.supplier}".`, sender: 'bot' }]);
            }
        } else {
            setMessages(prev => [...prev, { text: interpretation.matchedText || "Sorry, I couldn't understand that. Please try again.", sender: 'bot' }]);
        }
    };
    
    if (!isOpen) {
        return e(Button, { onClick: () => setIsOpen(true), className: 'fixed bottom-5 right-5 rounded-full p-4 shadow-lg z-30', icon: e(Icons.ChatBubbleIcon, { className: 'h-6 w-6' }) });
    }

    return e('div', { className: 'fixed bottom-5 right-5 w-[350px] h-[500px] bg-white dark:bg-slate-800 rounded-lg shadow-2xl z-40 flex flex-col border border-slate-200 dark:border-slate-700' },
        e('div', { className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
            e('h3', { className: 'font-semibold text-lg dark:text-slate-100' }, 'MGST AI Assistant'),
            e('button', { onClick: () => setIsOpen(false), className: 'text-2xl text-slate-500 hover:text-slate-800 dark:hover:text-slate-200' }, 'Ã—')
        ),
        e('div', { ref: messagesEndRef, className: 'flex-grow p-4 overflow-y-auto' },
            messages.map((msg, i) => e('div', { key: i, className: `mb-3 max-w-[85%] p-3 rounded-lg ${msg.sender === 'user' ? 'ml-auto bg-primary text-white' : 'mr-auto bg-slate-200 dark:bg-slate-700 dark:text-slate-200'}` }, msg.text))
        ),
        e('div', { className: 'p-4 border-t dark:border-slate-700 flex' },
            e(TextInput, { value: input, onChange: (e) => setInput(e.target.value), onKeyDown: (e) => e.key === 'Enter' && handleSend(), placeholder: "Ask about the data..." }),
            e(Button, { onClick: handleSend, className: 'ml-2' }, 'Send')
        )
    );
};

const ChartComponent = ({ chartConfig }) => {
    const chartRef = useRef(null);
    const chartInstanceRef = useRef(null);
    useEffect(() => {
        if (chartRef.current) {
            if (chartInstanceRef.current) {
                chartInstanceRef.current.destroy();
            }
            const ctx = chartRef.current.getContext('2d');
            chartInstanceRef.current = new Chart(ctx, chartConfig);
        }
        return () => {
            if (chartInstanceRef.current) {
                chartInstanceRef.current.destroy();
            }
        };
    }, [chartConfig]);
    return e('canvas', { ref: chartRef });
};

const ColumnFilterPopover = ({ columnKey, data, currentFilters, onFilterChange, close }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const menuRef = useRef(null);

    const uniqueValues = useMemo(() => {
        return [...new Set(data.map(item => item[columnKey]))].sort();
    }, [data, columnKey]);

    const filteredValues = useMemo(() => {
        if (!searchTerm) return uniqueValues;
        return uniqueValues.filter(v => String(v).toLowerCase().includes(searchTerm.toLowerCase()));
    }, [uniqueValues, searchTerm]);

    const handleToggle = (value) => {
        const newFilters = currentFilters.includes(value) ? currentFilters.filter(f => f !== value) : [...currentFilters, value];
        onFilterChange(newFilters);
    };

    const handleSelectAll = () => onFilterChange(uniqueValues);
    const handleClearAll = () => onFilterChange([]);

    return e('div', { ref: menuRef, className: 'glass-dropdown absolute top-full mt-2 left-0 z-50 max-h-80 w-60 rounded-lg py-1 text-base focus:outline-none sm:text-sm flex flex-col' },
      e('div', { className: 'p-2 border-b dark:border-slate-700' },
          e(TextInput, { placeholder: `Search...`, value: searchTerm, onChange: (e) => setSearchTerm(e.target.value) })
      ),
      e('div', { className: 'flex-grow overflow-y-auto' },
          filteredValues.map(value => e('div', { key: String(value), onClick: (e) => { e.stopPropagation(); handleToggle(value); }, className: 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 dark:text-gray-200 hover:bg-primary-light dark:hover:bg-slate-700 flex items-center' },
              e('input', { type: 'checkbox', readOnly: true, checked: currentFilters.includes(value), className: 'h-4 w-4 rounded border-slate-300 text-primary focus:ring-primary mr-3' }),
              e('span', { className: 'font-normal block truncate' }, String(value))
          ))
      ),
      e('div', { className: 'flex justify-between p-2 border-t dark:border-slate-700' },
          e('button', { onClick: (e) => { e.stopPropagation(); handleSelectAll(); }, className: 'text-sm text-primary hover:underline' }, "Select All"),
          e('button', { onClick: (e) => { e.stopPropagation(); handleClearAll(); }, className: 'text-sm text-primary hover:underline' }, "Clear All"),
      )
    );
};

const DataTable = ({ columns, data, initialPageSize = 10, selectedRows, onSelectionChange }) => {
    const [sortConfig, setSortConfig] = useState({ key: columns.find(c => c.sortable)?.key || '', direction: 'ascending' });
    const [currentPage, setCurrentPage] = useState(1);
    const [rowsPerPage, setRowsPerPage] = useState(initialPageSize);
    const [globalFilter, setGlobalFilter] = useState('');
    const [columnFilters, setColumnFilters] = useState({});
    const [openFilter, setOpenFilter] = useState(null);
    const filterMenuRef = useRef(null);
    
    const finalSelectedRows = selectedRows || [];

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (openFilter && filterMenuRef.current && !filterMenuRef.current.contains(event.target)) {
                setOpenFilter(null);
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [openFilter]);

    const filteredAndSortedData = useMemo(() => {
        let filtered = data;
        if (globalFilter) {
            filtered = filtered.filter(row => {
                return columns.some(col => {
                    const val = row[col.key];
                    return String(val).toLowerCase().includes(globalFilter.toLowerCase());
                });
            });
        }
        
        const activeColumnFilters = Object.entries(columnFilters).filter(([, values]) => values && values.length > 0);
        if (activeColumnFilters.length > 0) {
            filtered = filtered.filter(row => {
                return activeColumnFilters.every(([key, values]) => {
                    return values.includes(row[key]);
                });
            });
        }

        if (sortConfig.key) {
            const sorted = [...filtered];
            sorted.sort((a, b) => {
                let aValue = a[sortConfig.key];
                let bValue = b[sortConfig.key];
                const aDate = parseDateString(aValue);
                const bDate = parseDateString(bValue);
                if (aDate && bDate) {
                    aValue = aDate.getTime();
                    bValue = bDate.getTime();
                }
                if (aValue < bValue) return sortConfig.direction === 'ascending' ? -1 : 1;
                if (aValue > bValue) return sortConfig.direction === 'ascending' ? 1 : -1;
                return 0;
            });
            return sorted;
        }
        return filtered;
    }, [data, sortConfig, globalFilter, columnFilters, columns]);

    const paginatedData = useMemo(() => {
        const start = (currentPage - 1) * rowsPerPage;
        return filteredAndSortedData.slice(start, start + rowsPerPage);
    }, [filteredAndSortedData, currentPage, rowsPerPage]);
    
    const paginatedDataIds = useMemo(() => paginatedData.map(d => d.id), [paginatedData]);

    const totalPages = Math.ceil(filteredAndSortedData.length / rowsPerPage);

    useEffect(() => {
        setCurrentPage(1);
    }, [globalFilter, rowsPerPage, columnFilters]);

    const requestSort = (key) => {
        let direction = 'ascending';
        if (sortConfig.key === key && sortConfig.direction === 'ascending') {
            direction = 'descending';
        }
        setSortConfig({ key, direction });
        setCurrentPage(1);
    };
    
    const handleColumnFilterChange = (columnKey, values) => {
        setColumnFilters(prev => ({...prev, [columnKey]: values}));
    };
    
    const handleSelectAllOnPage = (e) => {
        const isChecked = e.target.checked;
        const currentIds = new Set(finalSelectedRows);
        paginatedDataIds.forEach(id => {
            if (isChecked) {
                currentIds.add(id);
            } else {
                currentIds.delete(id);
            }
        });
        onSelectionChange(Array.from(currentIds));
    };
    
    const isAllOnPageSelected = onSelectionChange && paginatedData.length > 0 && paginatedDataIds.every(id => finalSelectedRows.includes(id));


    return e('div', { className: 'pro-card p-6 min-h-[400px] flex flex-col' },
        e('div', { className: 'mb-4' }, 
            e(TextInput, { 
                placeholder: 'Search all columns...', 
                value: globalFilter, 
                onChange: (e) => setGlobalFilter(e.target.value) 
            })
        ),
        e('div', { className: 'overflow-x-auto flex-grow' },
            e('table', { className: 'pro-table' },
                e('thead', null,
                    e('tr', null,
                        onSelectionChange && e('th', null, e(Checkbox, { id: 'select-all-on-page', checked: isAllOnPageSelected, onChange: handleSelectAllOnPage })),
                        columns.map(col => e('th', { key: col.header, onClick: () => col.sortable && requestSort(col.key) }, 
                            e('div', { className: 'flex items-center justify-between' },
                                e('div', { className: `flex items-center ${col.sortable ? 'cursor-pointer' : ''}` }, 
                                    col.header,
                                    col.sortable && sortConfig.key === col.key && (sortConfig.direction === 'ascending' ? e(Icons.ArrowUpIcon, { className: 'w-3 h-3 ml-1' }) : e(Icons.ArrowDownIcon, { className: 'w-3 h-3 ml-1' }))
                                ),
                                col.filterable && e('div', { className: 'relative' },
                                    e('button', { onClick: (e) => { e.stopPropagation(); setOpenFilter(openFilter === col.key ? null : col.key) }, className: 'p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-600' },
                                        e(Icons.FunnelIcon, { className: `w-4 h-4 ${(columnFilters[col.key] || []).length > 0 ? 'text-primary' : 'text-slate-400'}` })
                                    ),
                                    e('div', { ref: openFilter === col.key ? filterMenuRef : null },
                                        openFilter === col.key && e(ColumnFilterPopover, {
                                            columnKey: col.key,
                                            data: data,
                                            currentFilters: columnFilters[col.key] || [],
                                            onFilterChange: (values) => handleColumnFilterChange(col.key, values),
                                            close: () => setOpenFilter(null)
                                        })
                                    )
                                )
                            )
                        ))
                    )
                ),
                e('tbody', null,
                    paginatedData.map((row, index) => e('tr', { key: row.id || index },
                        onSelectionChange && e('td', null, e(Checkbox, { id: `select-row-${row.id}`, checked: finalSelectedRows.includes(row.id), onChange: () => {
                            const newSelection = finalSelectedRows.includes(row.id) ? finalSelectedRows.filter(id => id !== row.id) : [...finalSelectedRows, row.id];
                            onSelectionChange(newSelection);
                        }})),
                        columns.map(col => {
                            const value = col.render ? col.render(row) : row[col.key];
                            return e('td', { key: col.key }, value);
                        })
                    ))
                )
            )
        ),
        e('div', { className: 'flex flex-col sm:flex-row justify-between items-center pt-4 text-sm text-slate-600 dark:text-slate-400' },
            e('div', { className: 'flex items-center gap-2 mb-2 sm:mb-0' },
                e('span', null, 'Rows per page:'),
                e('select', { value: rowsPerPage, onChange: (e) => { setRowsPerPage(Number(e.target.value)); setCurrentPage(1); }, className: 'glass-input p-2 rounded-lg' },
                    [10, 25, 50, 100].map(size => e('option', { key: size, value: size }, size))
                )
            ),
            e('div', { className: 'flex items-center gap-4' },
                e('span', null, `Page ${currentPage} of ${totalPages}`),
                e('div', { className: 'flex gap-1' },
                    e(Button, { onClick: () => setCurrentPage(p => Math.max(1, p-1)), disabled: currentPage === 1, variant: 'ghost', className: 'px-2 py-1' }, 'Prev'),
                    e(Button, { onClick: () => setCurrentPage(p => Math.min(totalPages, p+1)), disabled: currentPage === totalPages, variant: 'ghost', className: 'px-2 py-1' }, 'Next')
                )
            )
        )
    );
};

const ValidationPage = ({ allData, validationBooks, onValidateWithBooks }) => {
    const fileInputRef = React.useRef(null);
    
    const validationResults = React.useMemo(() => {
        if (validationBooks.length === 0) return { matched: [], unmatched: [], stats: { totalBooks: 0, totalMissing: 0 } };
        
        const getCol = (row, candidates) => {
            for(const c of candidates) {
                const key = Object.keys(row).find(k => k.trim().toLowerCase() === c.toLowerCase());
                if(key) return row[key];
            }
            return null;
        };
        
        const allBookRows = validationBooks.flatMap(book => {
            return book.data.map(row => {
                return {...row, 'Company Name': book.companyName}
            });
        });
        
        // Build lookup with normalized keys including fuzzy matching
        const mainDataLookup = new Map();
        const mainDataByDocNum = new Map(); // Fallback lookup without GSTIN
        
        allData.forEach(row => {
            if (row && typeof row.Type === 'string' && row.Type.startsWith('Missing_in_PR')) {
                const normalizedDocNum = String(row['Document Number (2B)'] || '').trim();
                const normalizedGstin = String(row['Supplier GSTIN (2B)'] || '').trim();
                
                // Primary key with GSTIN
                const key = `${row['Company Name']}|${normalizedDocNum}|${normalizedGstin}`;
                mainDataLookup.set(key, row);
                
                // Secondary key without GSTIN for fuzzy matching
                const keyWithoutGstin = `${row['Company Name']}|${normalizedDocNum}|`;
                if (!mainDataByDocNum.has(keyWithoutGstin)) {
                    mainDataByDocNum.set(keyWithoutGstin, row);
                }
            }
        });

        const matched = [];
        const unmatched = [];
        let unmatchedCounter = 0;
        
        allBookRows.forEach(bookRow => {
            const docNum = getCol(bookRow, ['Voucher Ref. No.', 'Document Number', 'Doc No', 'Invoice No']);
            const gstin = getCol(bookRow, ['GSTIN/UIN', 'GSTIN', 'Supplier GSTIN']);
            
            const normalizedDocNum = String(docNum || '').trim();
            const normalizedGstin = String(gstin || '').trim();
            
            // Try exact match first
            let key = `${bookRow['Company Name']}|${normalizedDocNum}|${normalizedGstin}`;
            let matchedRow = mainDataLookup.get(key);
            let usedFallback = false;
            
            // If no exact match, try without GSTIN
            if (!matchedRow && normalizedDocNum) {
                key = `${bookRow['Company Name']}|${normalizedDocNum}|`;
                matchedRow = mainDataByDocNum.get(key);
                usedFallback = true;
            }
            
            if (matchedRow) {
                matched.push(matchedRow);
                // Delete from the correct map based on which key was used
                if (usedFallback) {
                    mainDataByDocNum.delete(key);
                } else {
                    mainDataLookup.delete(key);
                }
            } else {
                unmatchedCounter++;
                unmatched.push({
                    ...bookRow,
                    id: `unmatched_${normalizedDocNum}_${unmatchedCounter}`,
                    'Supplier Name': getCol(bookRow, ['Party Name', 'Supplier Name']),
                    'Document Number (2B)': normalizedDocNum,
                    'Document Date (2B)': getCol(bookRow, ['Voucher Date', 'Document Date']),
                    'Sum of Taxable Value (2B)': getCol(bookRow, ['Taxable Value']),
                    'Total GST': getCol(bookRow, ['Total Tax', 'GST Amount']),
                    Remarks: 'Not found in Missing_in_PR transactions'
                });
            }
        });
        
        const totalMissing = allData.filter(row => row && typeof row.Type === 'string' && row.Type.startsWith('Missing_in_PR')).length;
        
        return { 
            matched, 
            unmatched, 
            stats: { 
                totalBooks: allBookRows.length, 
                totalMissing,
                matchedCount: matched.length,
                unmatchedCount: unmatched.length
            } 
        };
    }, [validationBooks, allData]);

    const columns = [
        { header: 'Company Name', key: 'Company Name', sortable: true, filterable: true },
        { header: 'Supplier Name', key: 'Supplier Name', sortable: true, filterable: true },
        { header: 'Doc Num', key: 'Document Number (2B)', sortable: true },
        { header: 'Doc Date', key: 'Document Date (2B)', sortable: true },
        { header: 'Taxable', key: 'Sum of Taxable Value (2B)', render: (r) => formatCurrency(r['Sum of Taxable Value (2B)'], false) },
        { header: 'Total GST', key: 'Total GST', render: (r) => formatCurrency(r['Total GST'], false) },
        { header: 'Remarks', key: 'Remarks' },
    ];
    
    return e('div', { className: 'space-y-6' },
        e('div', { className: 'glass-card bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700' },
            e('h2', { className: 'text-lg font-semibold dark:text-slate-100' }, "Upload Books File"),
            e('p', { className: 'text-sm text-slate-600 dark:text-slate-400 mt-1 mb-4' }, "Filename must be 'Books_CompanyName.xlsx'. This will find matches and auto-mark them as 'Accounted'."),
            e('input', { type: 'file', ref: fileInputRef, className: 'hidden', accept: '.xlsx,.xls', onChange: (e) => e.target.files[0] && onValidateWithBooks(e.target.files[0]) }),
            e(Button, { onClick: () => fileInputRef.current.click() }, "Upload 'Books' Excel File")
        ),
        validationBooks.length > 0 && e('div', { className: 'glass-card bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md border dark:border-slate-700' },
            e('h3', { className: 'text-md font-semibold dark:text-slate-100 mb-3' }, 'Validation Statistics'),
            e('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-2xl font-bold text-blue-500' }, validationResults.stats.totalBooks),
                    e('div', { className: 'text-sm text-slate-600 dark:text-slate-400' }, 'Books Entries')
                ),
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-2xl font-bold text-yellow-500' }, validationResults.stats.totalMissing),
                    e('div', { className: 'text-sm text-slate-600 dark:text-slate-400' }, 'Missing in PR')
                ),
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-2xl font-bold text-green-500' }, validationResults.stats.matchedCount),
                    e('div', { className: 'text-sm text-slate-600 dark:text-slate-400' }, 'Matched')
                ),
                e('div', { className: 'text-center' },
                    e('div', { className: 'text-2xl font-bold text-red-500' }, validationResults.stats.unmatchedCount),
                    e('div', { className: 'text-sm text-slate-600 dark:text-slate-400' }, 'Unmatched')
                )
            )
        ),
        e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 gap-6' },
            e('div', null, 
                e('h2', { className: 'text-xl font-bold text-success mb-2' }, `Matched Transactions (${validationResults.matched.length})`),
                e(DataTable, { columns, data: validationResults.matched, selectedRows: [], onSelectionChange: () => {} })
            ),
            e('div', null,
                e('h2', { className: 'text-xl font-bold text-danger mb-2' }, `Unmatched Transactions (${validationResults.unmatched.length})`),
                e(DataTable, { columns, data: validationResults.unmatched, selectedRows: [], onSelectionChange: () => {} })
            )
        )
    );
};

const TransactionsPage = ({ data, actionState, updateAction, updateMultipleActions }) => {
    const [jtcFilter, setJtcFilter] = useState(false);
    const [editingCell, setEditingCell] = useState(null);
    const [remarkValue, setRemarkValue] = useState('');
    const [selectedRows, setSelectedRows] = useState([]);
    const [bulkAction, setBulkAction] = useState('None');

    const tableData = useMemo(() => {
        if (!jtcFilter) return data;
        return data.filter(row => {
            const action = actionState[row.id];
            return (typeof action === 'string' && action === 'Accounted') || (action?.action === 'Accounted');
        });
    }, [data, jtcFilter, actionState]);
    
    useEffect(() => {
        setSelectedRows([]);
    }, [data]);

    const handleRemarkEdit = (rowId, currentRemark) => {
        setEditingCell(rowId);
        setRemarkValue(currentRemark);
    };
    const handleRemarkSave = (rowId) => {
        if (editingCell === rowId) {
            const currentAction = actionState[rowId];
            const newAction = typeof currentAction === 'object' ? { ...currentAction } : {};
            newAction.remarks = remarkValue;
            updateAction(rowId, newAction);
            setEditingCell(null);
        }
    };
    const handleRemarkKeyDown = (e, rowId) => {
        if (e.key === 'Enter') handleRemarkSave(rowId);
        if (e.key === 'Escape') setEditingCell(null);
    };

    const handleApplyBulkAction = () => {
        if (bulkAction === 'None' || selectedRows.length === 0) return;
        updateMultipleActions(selectedRows, bulkAction);
        setSelectedRows([]);
    };

    const columns = [
        { header: 'Company Name', key: 'Company Name', sortable: true, filterable: true },
        { header: 'Supplier Name', key: 'Supplier Name', sortable: true, filterable: true },
        { header: 'Doc Num', key: 'Document Number (2B)', sortable: true },
        { header: 'Doc Date', key: 'Document Date (2B)', sortable: true },
        { header: 'Tag', key: 'Type', sortable: true, filterable: true },
        { header: 'Taxable', key: 'Sum of Taxable Value (2B)', sortable: true, render: (row) => formatCurrency(row['Sum of Taxable Value (2B)'], false) },
        { header: 'Total GST', key: 'Total GST', sortable: true, render: (row) => formatCurrency(row['Total GST'], false) },
        { header: 'Remarks', key: 'Remarks', render: (row) => {
            const currentAction = actionState[row.id];
            const currentRemark = (typeof currentAction === 'object' ? currentAction?.remarks : '') || row.Remarks;
            if (editingCell === row.id) {
                return e(TextInput, { 
                    value: remarkValue, 
                    onChange: (e) => setRemarkValue(e.target.value),
                    onBlur: () => handleRemarkSave(row.id),
                    onKeyDown: (e) => handleRemarkKeyDown(e, row.id),
                    autoFocus: true 
                });
            }
            return e('span', { onClick: () => handleRemarkEdit(row.id, currentRemark), className: 'cursor-pointer hover:underline' }, currentRemark || '...');
        }},
        { header: 'Action', key: 'Action', render: (row) => {
            const currentAction = actionState[row.id];
            const value = typeof currentAction === 'string' ? currentAction : currentAction?.action;
            const handleChange = (id, val) => {
                const newAction = typeof currentAction === 'object' ? { ...currentAction } : {};
                newAction.action = val;
                updateAction(id, newAction);
            };
            return e(ActionSelect, { rowId: row.id, value: value || 'None', onChange: handleChange });
        }}
    ];
    
    const BulkActionBar = () => {
        if (selectedRows.length === 0) return null;
        return e('div', { className: 'glass-surface p-3 rounded-lg mb-4 flex items-center gap-4' },
            e('span', { className: 'text-sm font-medium dark:text-slate-200' }, `${selectedRows.length} rows selected`),
            e(Select, { value: bulkAction, options: ACTION_OPTIONS, onChange: (e) => setBulkAction(e.target.value), className: 'w-48' }),
            e(Button, { onClick: handleApplyBulkAction, disabled: bulkAction === 'None' }, 'Apply'),
            e('button', { onClick: () => setSelectedRows([]), className: 'text-sm text-slate-500 dark:text-slate-400 hover:underline ml-auto' }, 'Clear Selection')
        );
    };

    return e('div', null,
        e('div', { className: 'mb-4 flex flex-col sm:flex-row justify-between items-center gap-4' },
            e(Checkbox, { id: 'jtcFilter', checked: jtcFilter, onChange: (e) => setJtcFilter(e.target.checked), label: 'Show Accounted Only' }),
            e(Button, { onClick: () => exportToCsv(tableData, 'Transactions'), variant: 'secondary' }, 'Export CSV')
        ),
        e(BulkActionBar, null),
        e(DataTable, { columns, data: tableData, onSelectionChange: setSelectedRows, selectedRows })
    );
};

const AddToListSelect = ({ supplier, company, value, onChange }) => {
    const key = `${company}|${supplier}`;
    const handleChange = (e) => {
        onChange(key, e.target.value);
    };
    return e(Select, { value, options: MAILING_LIST_CATEGORIES, onChange: handleChange, className: "w-40" });
};

const SuppliersPage = ({ data, assignmentState, updateAssignment }) => {
  const supplierData = useMemo(() => {
    const suppliersInView = {};
    
    const cleanData = data.filter(row => row && typeof row === 'object' && typeof row['Company Name'] === 'string' && typeof row['Supplier Name'] === 'string');

    cleanData.forEach(row => {
        const key = `${row['Company Name']}|${row['Supplier Name']}`;
        if (!suppliersInView[key]) {
          suppliersInView[key] = { id: key, company: row['Company Name'], name: row['Supplier Name'], totalGst: 0, transactionCount: 0 };
        }
        suppliersInView[key].totalGst += (row['Total GST'] || 0);
        suppliersInView[key].transactionCount++;
    });
    
    Object.keys(assignmentState).forEach(key => {
        if (assignmentState[key] && assignmentState[key] !== 'None' && !suppliersInView[key]) {
            const [company, name] = key.split('|');
            suppliersInView[key] = { id: key, company: company, name: name, totalGst: 0, transactionCount: 0 };
        }
    });
    
    return Object.values(suppliersInView);
  }, [data, assignmentState]);

  const columns = [
      { header: 'Company Name', key: 'company', sortable: true, filterable: true },
      { header: 'Supplier Name', key: 'name', sortable: true, filterable: true },
      { header: 'Total GST', key: 'totalGst', sortable: true, render: (row) => formatCurrency(row.totalGst, false) },
      { header: 'Transactions', key: 'transactionCount', sortable: true },
      { header: 'Add to List', key: 'list', render: (row) => {
          return e(AddToListSelect, { 
              supplier: row.name, 
              company: row.company, 
              value: assignmentState[row.id] || 'None', 
              onChange: updateAssignment 
          });
      }},
  ];

  return e('div', null,
    e('div', { className: 'mb-4 flex justify-end' },
      e(Button, { onClick: () => exportToCsv(supplierData, "supplier_summary_export"), variant: 'secondary' }, 'Export CSV')
    ),
    e(DataTable, { columns: columns, data: supplierData })
  );
};

const MailingListPage = ({ data, actionState, assignmentState, setPrintModalData }) => {
    const getCategoryStats = (category) => {
        const assignedSuppliers = Object.entries(assignmentState)
            .filter(([key, cat]) => cat === category)
            .map(([key]) => key);
        
        const uniqueEntries = new Set();
        const mailingData = data.filter(row => {
            const key = `${row['Company Name']}|${row['Supplier Name']}`;
            const entryKey = `${key}|${row['Document Number (2B)']}`;

            const action = actionState[row.id];
            const isAccounted = typeof action === 'string' ? action === 'Accounted' : action?.action === 'Accounted';

            if (assignedSuppliers.includes(key) && !isAccounted && !uniqueEntries.has(entryKey)) {
                uniqueEntries.add(entryKey);
                return true;
            }
            return false;
        });

        const totalAmount = mailingData.reduce((sum, row) => sum + (row['Total GST'] || 0), 0);
        const supplierSet = new Set(mailingData.map(row => row['Supplier Name']));

        return {
            count: mailingData.length,
            suppliers: supplierSet.size,
            amount: totalAmount,
            data: mailingData
        };
    };

    const handleShowPreview = (category, stats) => {
        if (stats.count === 0) {
            alert(`No pending transactions found for mailing list: ${category}`);
            return;
        }
        setPrintModalData({ isOpen: true, category, data: stats.data });
    };

    return e('div', { className: 'space-y-6' },
        e('div', { className: 'pro-card p-6' },
            e('div', { className: 'flex items-center justify-between mb-6' },
                e('div', null,
                    e('h2', { className: 'text-2xl font-bold text-gray-900 dark:text-gray-100' }, 'Mailing Lists'),
                    e('p', { className: 'text-sm text-gray-600 dark:text-gray-400 mt-1' }, 'Organized by supplier categories for targeted communication')
                ),
                e(Icons.EnvelopeIcon, { className: 'h-10 w-10 text-primary-500' })
            )
        ),
        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' },
            MAILING_LIST_CATEGORIES.map(cat => {
                const stats = getCategoryStats(cat);
                const categoryColors = {
                    'Key Suppliers': 'from-blue-500 to-blue-600',
                    'Medium Suppliers': 'from-green-500 to-green-600',
                    'Small Suppliers': 'from-amber-500 to-amber-600',
                    'Other Suppliers': 'from-purple-500 to-purple-600'
                };
                const gradientClass = categoryColors[cat] || 'from-gray-500 to-gray-600';

                return e('div', { key: cat, className: 'pro-card overflow-hidden hover:shadow-lg transition-shadow' },
                    e('div', { className: `bg-gradient-to-r ${gradientClass} p-6 text-white` },
                        e('h3', { className: 'text-xl font-bold mb-2' }, cat),
                        e('div', { className: 'flex items-center gap-2 text-white/90' },
                            e(Icons.BuildingOfficeIcon, { className: 'h-5 w-5' }),
                            e('span', { className: 'text-sm' }, `${stats.suppliers} Suppliers`)
                        )
                    ),
                    e('div', { className: 'p-6' },
                        e('div', { className: 'space-y-4 mb-6' },
                            e('div', { className: 'flex justify-between items-center' },
                                e('span', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Pending Items'),
                                e('span', { className: 'text-2xl font-bold text-gray-900 dark:text-gray-100' }, stats.count)
                            ),
                            e('div', { className: 'flex justify-between items-center' },
                                e('span', { className: 'text-sm text-gray-600 dark:text-gray-400' }, 'Total Amount'),
                                e('span', { className: 'text-lg font-semibold text-gray-900 dark:text-gray-100' }, formatCurrency(stats.amount, false))
                            )
                        ),
                        e('div', { className: 'flex gap-2' },
                            e(Button, { 
                                onClick: () => handleShowPreview(cat, stats), 
                                className: 'flex-1',
                                disabled: stats.count === 0
                            }, 'View Details'),
                            stats.count > 0 && e(Button, { 
                                onClick: () => handleShowPreview(cat, stats), 
                                variant: 'secondary',
                                className: 'px-3'
                            }, e(Icons.EnvelopeIcon, { className: 'h-4 w-4' }))
                        )
                    )
                );
            })
        )
    );
};

const PrintModal = ({ printModalData, setPrintModalData, actionState }) => {
    if (!printModalData.isOpen) return null;
    
    const handlePrint = () => {
        const title = `Report: ${printModalData.category}`;
        controlledPrint('print-table', title);
    };
    const handleExport = () => {
        const exportData = printModalData.data.map(row => {
          const action = actionState[row.id];
          return {
            'Company Name': row['Company Name'],
            'Supplier Name': row['Supplier Name'],
            'Doc Num': row['Document Number (2B)'],
            'Doc Date': row['Document Date (2B)'],
            'Tag': row.Type,
            'Taxable': row['Sum of Taxable Value (2B)'],
            'Total GST': row['Total GST'],
            'Remarks': (typeof action === 'object' ? action?.remarks : '') || row.Remarks,
            'Action': (typeof action === 'string' ? action : action?.action) || 'None'
        }});
        exportToCsv(exportData, `MailingList_${printModalData.category}`);
    };

    return e('div', { id: 'print-modal', className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
        e('div', { id: 'print-modal-content', className: 'bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col' },
            e('div', { id: 'print-modal-header', className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
                e('h2', { className: 'text-xl font-bold dark:text-slate-100' }, `Preview: ${printModalData.category}`),
                e('button', { onClick: () => setPrintModalData({isOpen: false, category: '', data: []}), className: 'text-2xl dark:text-slate-300' }, 'Ã—')
            ),
            e('div', { className: 'p-4 overflow-auto flex-grow' },
                e('table', { id: 'print-table', className: 'w-full text-sm' },
                    e('thead', null, e('tr', null, ['Company', 'Supplier', 'Doc Num', 'Doc Date', 'Tag', 'Taxable', 'Total GST', 'Remarks', 'Action'].map(h => e('th', { key: h, className: 'p-2 border border-slate-500 text-black dark:text-slate-200 text-left bg-slate-100 dark:bg-slate-700' }, h)))),
                    e('tbody', null, printModalData.data.map(row => {
                      const action = actionState[row.id];
                      return e('tr', { key: row.id },
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Company Name']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Supplier Name']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Document Number (2B)']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row['Document Date (2B)']),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, row.Type),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300 text-right' }, formatCurrency(row['Sum of Taxable Value (2B)'], false)),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300 text-right' }, formatCurrency(row['Total GST'], false)),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, (typeof action === 'object' ? action?.remarks : '') || row.Remarks),
                        e('td', { className: 'p-2 border border-slate-500 dark:border-slate-600 text-black dark:text-slate-300' }, (typeof action === 'string' ? action : action?.action) || 'None')
                    )}))
                )
            ),
            e('div', { id: 'print-modal-footer', className: 'p-4 border-t dark:border-slate-700 flex justify-end gap-3' },
                e(Button, { onClick: handleExport, variant: 'secondary' }, 'Export CSV'),
                e(Button, { onClick: handlePrint, icon: e(Icons.PrinterIcon, null) }, 'Print'),
                e(Button, { onClick: () => setPrintModalData({isOpen: false, category: '', data: []}), variant: 'danger-ghost' }, 'Close')
            )
        )
    );
};

const ThinkingModeModal = ({ isOpen, onClose, contextData }) => {
    const [prompt, setPrompt] = useState('');
    const [response, setResponse] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    if (!isOpen) return null;

    const handleSubmit = async () => {
        if (!prompt.trim() || !geminiService.isAvailable()) {
            if(!geminiService.isAvailable()) {
                alert("AI analysis is not available. Please configure your API_KEY.");
            }
            return;
        };
        setIsLoading(true);
        setResponse('');
        const analysis = await geminiService.getAnalysis(prompt, contextData);
        setResponse(analysis);
        setIsLoading(false);
    };

    return e('div', { className: 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4' },
        e('div', { className: 'bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col' },
            e('div', { className: 'p-4 border-b dark:border-slate-700 flex justify-between items-center' },
                e('h2', { className: 'text-xl font-bold dark:text-slate-100' }, 'Analyze with AI (Thinking Mode)'),
                e('button', { onClick: onClose, className: 'text-2xl dark:text-slate-300' }, 'Ã—')
            ),
            e('div', { className: 'p-4 flex-grow flex flex-col gap-4' },
                e('div', null,
                    e('label', { htmlFor: 'ai-prompt', className: 'block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1' }, 'Ask a complex question about the current data view:'),
                    e('textarea', { 
                        id: 'ai-prompt',
                        rows: 4, 
                        value: prompt,
                        onChange: (e) => setPrompt(e.target.value),
                        className: 'glass-input w-full rounded-lg px-3 py-2 text-sm text-slate-900 dark:text-slate-200 placeholder:text-slate-400 dark:placeholder:text-slate-500',
                        placeholder: 'e.g., "What are the common trends for suppliers with missing GST in the last quarter?" or "Summarize the top 3 suppliers by missing GST and suggest an action plan."'
                    })
                ),
                e('div', null,
                    e(Button, { onClick: handleSubmit, disabled: isLoading || !prompt.trim(), icon: e(Icons.SparklesIcon, { className: 'w-5 h-5'}) },
                        isLoading ? 'Analyzing...' : 'Submit to AI'
                    )
                ),
                (isLoading || response) && e('div', { className: 'border-t dark:border-slate-700 pt-4 flex-grow overflow-y-auto' },
                    isLoading ? e('div', { className: 'flex items-center gap-2 text-slate-600 dark:text-slate-300' }, 
                        e('div', { className: 'w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin' }),
                        e('span', null, 'The AI is thinking... this may take a moment.')
                    ) :
                    e('pre', { className: 'glass-sunken p-3 rounded-lg text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap font-sans' }, response)
                )
            ),
            e('div', { className: 'p-4 border-t dark:border-slate-700 flex justify-end' },
                e(Button, { onClick: onClose, variant: 'secondary' }, 'Close')
            )
        )
    );
};

// --- New Self-Contained "ReportsTab" Component ---
const ReportsTab = ({ initialData, onDataChange }) => {
    const [reportData, setReportData] = useState(initialData || []);
    const [isLoading, setIsLoading] = useState(false);
    const [statusMessage, setStatusMessage] = useState('');
    const fileInputRef = useRef(null);
    const [filters, setFilters] = useState({ company: [], financialYear: [], month: [] });

    const safeParseNumber = (val) => {
        if (typeof val === 'number') return isNaN(val) ? 0 : val;
        if (typeof val !== 'string') return 0;
        const cleanedVal = val.replace(/[,â‚¹\s]/g, '');
        if (cleanedVal === '' || cleanedVal === '-') return 0;
        const num = Number(cleanedVal);
        return isNaN(num) ? 0 : num;
    };
    
    const findKeyAndParse = (row, keySubstrings) => {
        if (!row || typeof row !== 'object') return 0;
        const keys = Object.keys(row);
        for (const sub of keySubstrings) {
            const normalizedSub = sub.toLowerCase().replace(/[\s_]/g, '');
            const key = keys.find(k => k.toLowerCase().replace(/[\s_]/g, '').includes(normalizedSub));
            if (key) {
                return safeParseNumber(row[key]);
            }
        }
        return 0;
    };

    const derivedData = useMemo(() => {
        return reportData.map(row => {
            const totalLiability = findKeyAndParse(row, ['TotalLiability_IGST', 'Total Tax Liability']) + findKeyAndParse(row, ['TotalLiability_CGST']) + findKeyAndParse(row, ['TotalLiability_SGST']);
            const totalItcUtilized = findKeyAndParse(row, ['ITC_Utilized_IGST']) + findKeyAndParse(row, ['ITC_Utilized_CGST']) + findKeyAndParse(row, ['ITC_Utilized_SGST']);
            const totalItcAvailed = findKeyAndParse(row, ['Total ITC Availed']); // New
            const totalCashPaid = findKeyAndParse(row, ['Tax Paid by Cash', 'CashPaid_IGST']) + findKeyAndParse(row, ['CashPaid_CGST']) + findKeyAndParse(row, ['CashPaid_SGST']);
            
            // Use Total ITC Availed if it exists, otherwise fallback to utilized.
            const itcComponent = totalItcAvailed > 0 ? totalItcAvailed : totalItcUtilized;
            const totalTaxPaid = itcComponent + totalCashPaid;
            
            const variance = totalLiability - totalTaxPaid;
            const variancePercent = totalLiability !== 0 ? (variance / totalLiability) * 100 : 0;
            
            return {
                ...row,
                id: (row.GSTIN || '') + (row.Period || '') + (row.FinancialYear || ''),
                Entity: row['Entity'] || row['LegalName'] || 'Unknown',
                FinancialYear: row['FinancialYear'],
                Month: row['Period'],
                TotalOutwardValue: totalLiability,
                TotalTaxPaid: totalTaxPaid,
                TotalItcUtilized: itcComponent, // Using the decided ITC component
                Variance: variance,
                VariancePercent: variancePercent
            };
        });
    }, [reportData]);
    
    const filterOptions = useMemo(() => {
        const companies = [...new Set(derivedData.map(r => r.Entity))].filter(Boolean).sort();
        const financialYears = [...new Set(derivedData.map(r => r.FinancialYear))].filter(Boolean).sort();
        const months = [...new Set(derivedData.map(r => r.Month))].filter(Boolean).sort((a,b) => getMonthNumber(a) - getMonthNumber(b));
        return { companies, financialYears, months };
    }, [derivedData]);

    const filteredReportData = useMemo(() => {
        return derivedData.filter(row => {
            const companyMatch = filters.company.length === 0 || filters.company.includes(row.Entity);
            const fyMatch = filters.financialYear.length === 0 || filters.financialYear.includes(row.FinancialYear);
            const monthMatch = filters.month.length === 0 || filters.month.includes(row.Month);
            return companyMatch && fyMatch && monthMatch;
        });
    }, [derivedData, filters]);

    const summaryMetrics = useMemo(() => {
        const dataToSum = filteredReportData;
        const totals = dataToSum.reduce((acc, row) => {
            acc.outwardValue += row.TotalOutwardValue;
            acc.taxPaid += row.TotalTaxPaid;
            acc.itcUtilized += row.TotalItcUtilized;
            return acc;
        }, { outwardValue: 0, taxPaid: 0, itcUtilized: 0 });
        
        // Tax liability is calculated as tax paid + ITC utilized (total tax obligation)
        const totalTaxLiability = totals.taxPaid + totals.itcUtilized;
        const totalVariance = totalTaxLiability - totals.taxPaid;
        const totalVariancePercent = totalTaxLiability !== 0 ? (totalVariance / totalTaxLiability) * 100 : 0;
        
        return {
            totalOutwardValue: totals.outwardValue,
            totalTaxLiability: totalTaxLiability, 
            totalTaxPaid: totals.taxPaid,
            totalItcUtilized: totals.itcUtilized,
            variancePercent: totalVariancePercent,
        };
    }, [filteredReportData]);

    const chartData = useMemo(() => {
        const dataToChart = filteredReportData;
        const monthlyData = dataToChart.reduce((acc, row) => {
            const month = row.Month || 'Unknown';
            if (!acc[month]) {
                acc[month] = { itcUtilized: 0, taxPaid: 0, outwardValue: 0, cash: 0, itc: 0 };
            }
            acc[month].itcUtilized += row.TotalItcUtilized;
            acc[month].taxPaid += row.TotalTaxPaid;
            acc[month].outwardValue += row.TotalOutwardValue;
            acc[month].cash += findKeyAndParse(row, ['Tax Paid by Cash', 'CashPaid_IGST']) + findKeyAndParse(row, ['CashPaid_CGST']) + findKeyAndParse(row, ['CashPaid_SGST']);
            acc[month].itc += row.TotalItcUtilized;
            return acc;
        }, {});

        const sortedMonths = Object.keys(monthlyData).sort((a,b) => getMonthNumber(a) - getMonthNumber(b));

        const itcVsPaidChart = {
            type: 'bar',
            data: {
                labels: sortedMonths,
                datasets: [
                    { 
                        label: 'ITC Utilized', 
                        data: sortedMonths.map(m => monthlyData[m].itcUtilized), 
                        backgroundColor: '#3B82F6',
                        borderColor: '#3B82F6',
                        borderWidth: 0,
                        borderRadius: 6
                    },
                    { 
                        label: 'Tax Paid', 
                        data: sortedMonths.map(m => monthlyData[m].taxPaid), 
                        backgroundColor: '#10B981',
                        borderColor: '#10B981',
                        borderWidth: 0,
                        borderRadius: 6
                    }
                ]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    title: { display: true, text: 'ITC Utilized vs Tax Paid (Monthly)', font: { size: 14, weight: '600' } },
                    legend: { display: true, position: 'top', labels: { padding: 15, usePointStyle: true, pointStyle: 'circle' } }
                }, 
                scales: { 
                    y: { ticks: { callback: (value) => formatCurrency(value, true) }, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                } 
            }
        };

        const outwardTrendChart = {
            type: 'line',
            data: {
                labels: sortedMonths,
                datasets: [{ 
                    label: 'Outward Value', 
                    data: sortedMonths.map(m => monthlyData[m].outwardValue), 
                    borderColor: '#4F46E5',
                    backgroundColor: 'rgba(79, 70, 229, 0.08)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#4F46E5',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2
                }]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    title: { display: true, text: 'Outward Value Trend (Monthly)', font: { size: 14, weight: '600' } },
                    legend: { display: true, position: 'top', labels: { padding: 15, usePointStyle: true, pointStyle: 'circle' } }
                }, 
                scales: { 
                    y: { ticks: { callback: (value) => formatCurrency(value, true) }, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                } 
            }
        };
        
        const totalCash = Object.values(monthlyData).reduce((sum, d) => sum + d.cash, 0);
        const totalItc = Object.values(monthlyData).reduce((sum, d) => sum + d.itc, 0);

        const paymentCompositionChart = {
            type: 'pie',
            data: {
                labels: ['Cash', 'ITC'],
                datasets: [{ 
                    data: [totalCash, totalItc], 
                    backgroundColor: ['#3B82F6', '#10B981'],
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    title: { display: true, text: 'Tax Payment Composition', font: { size: 16, weight: '600' } },
                    legend: { display: true, position: 'bottom', labels: { padding: 15, font: { size: 12 } } }
                } 
            }
        };
        
        return { itcVsPaidChart, outwardTrendChart, paymentCompositionChart };
    }, [filteredReportData]);
    
    const exceptionsData = useMemo(() => {
        return filteredReportData
            .filter(row => Math.abs(row.VariancePercent) > 2 || row.Status?.toLowerCase() !== 'filed')
            .map(row => ({
                id: row.id + '_exc',
                Type: Math.abs(row.VariancePercent) > 2 ? 'Under-reporting' : 'Filing Issue',
                Entity: row.Entity,
                Description: `Variance of ${row.VariancePercent.toFixed(2)}%`,
                Amount: row.Variance,
                SuggestedAction: 'Review GSTR-1 vs GSTR-3B immediately.'
            }));
    }, [filteredReportData]);

    const handleFileSelect = async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;

        setIsLoading(true);
        setStatusMessage('Processing consolidated report...');
        
        try {
          const data = await fileProcessor.processConsolidatedReport(file);
          setReportData(data);
          onDataChange(data);
          setStatusMessage(`Successfully loaded ${data.length} records.`);
        } catch (e) {
            setStatusMessage(`Error: ${e.message}`);
            console.error(e);
        } finally {
            setIsLoading(false);
            if (fileInputRef.current) fileInputRef.current.value = '';
        }
    };

    const complianceColumns = [
        { header: 'Entity', key: 'Entity', sortable: true, filterable: true },
        { header: 'GSTIN', key: 'GSTIN', sortable: true },
        { header: 'Period', key: 'Month', sortable: true, filterable: true },
        { header: 'Tax Liability', key: 'TotalOutwardValue', sortable: true, render: (r) => formatCurrency(r.TotalOutwardValue, false) },
        { header: 'Tax Paid', key: 'TotalTaxPaid', sortable: true, render: (r) => formatCurrency(r.TotalTaxPaid, false) },
        { header: 'Variance %', key: 'VariancePercent', sortable: true, render: (r) => {
            const color = Math.abs(r.VariancePercent) <= 2 ? 'text-green-500' : Math.abs(r.VariancePercent) <= 5 ? 'text-yellow-500' : 'text-red-500';
            return e('span', { className: color }, `${r.VariancePercent.toFixed(2)}%`)
        }},
        { header: 'ITC Utilized', key: 'TotalItcUtilized', sortable: true, render: (r) => formatCurrency(r.TotalItcUtilized, false) },
        { header: 'Filing Date', key: 'ARNDate', sortable: true },
        { header: 'Status', key: 'Status', sortable: true, filterable: true }
    ];
    
    const exceptionColumns = [
        { header: 'Type', key: 'Type', sortable: true, filterable: true },
        { header: 'Entity', key: 'Entity', sortable: true, filterable: true },
        { header: 'Description', key: 'Description', sortable: false },
        { header: 'Amount', key: 'Amount', sortable: true, render: (r) => formatCurrency(r.Amount, false) },
        { header: 'Suggested Action', key: 'SuggestedAction', sortable: false },
    ];

    const FilterBar = () => e('div', { className: 'pro-card p-4 mb-6 flex flex-wrap items-center gap-4' },
        e('div', { className: 'font-semibold text-gray-700 dark:text-gray-200' }, 'Filters:'),
        e(MultiSelect, { label: 'Company Name', values: filters.company, options: filterOptions.companies, onChange: (v) => setFilters(f => ({...f, company: v})), className: 'min-w-[200px] z-20' }),
        e(MultiSelect, { label: 'Financial Year', values: filters.financialYear, options: filterOptions.financialYears, onChange: (v) => setFilters(f => ({...f, financialYear: v})), className: 'min-w-[150px] z-20' }),
        e(MultiSelect, { label: 'Month', values: filters.month, options: filterOptions.months, onChange: (v) => setFilters(f => ({...f, month: v})), className: 'min-w-[150px] z-20' })
    );

    return e('div', { className: 'space-y-6' },
        e('div', { className: 'flex items-center gap-4' },
            e('input', { type: 'file', ref: fileInputRef, className: 'hidden', accept: '.xlsx, .xls', onChange: handleFileSelect }),
            e(Button, { onClick: () => fileInputRef.current?.click(), icon: e(Icons.FileUploadIcon, { className: 'w-4 h-4' }), disabled: isLoading }, isLoading ? 'Processing...' : 'Upload DeatilsDB.xlsx'),
            statusMessage && e('p', { className: 'text-sm text-slate-600 dark:text-slate-400' }, statusMessage),
        ),
        e(FilterBar, null),
        e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4' },
            e(KpiCard, { title: "Total Outward Value", value: formatCurrency(summaryMetrics.totalOutwardValue), color: 'blue' }),
            e(KpiCard, { title: "Total Tax Liability", value: formatCurrency(summaryMetrics.totalTaxLiability), color: 'blue' }),
            e(KpiCard, { title: "Total Tax Paid", value: formatCurrency(summaryMetrics.totalTaxPaid), color: 'green' }),
            e(KpiCard, { title: "Total ITC Utilized", value: formatCurrency(summaryMetrics.totalItcUtilized), color: 'green' }),
            e(KpiCard, { title: "Variance %", value: formatPercent(summaryMetrics.variancePercent), color: Math.abs(summaryMetrics.variancePercent) > 2 ? 'red' : 'green' }),
        ),
        e('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-6' },
          e('div', { className: 'lg:col-span-2 pro-card p-6' },
              e(ChartComponent, { chartConfig: chartData.itcVsPaidChart })
          ),
          e('div', { className: 'pro-card p-6' },
              e(ChartComponent, { chartConfig: chartData.paymentCompositionChart })
          )
        ),
        e('div', { className: 'pro-card p-6' },
            e(ChartComponent, { chartConfig: chartData.outwardTrendChart })
        ),
        e('div', null, 
          e('h2', { className: 'text-xl font-bold mb-2 text-slate-800 dark:text-slate-100' }, 'Compliance Summary'),
          e(DataTable, { columns: complianceColumns, data: filteredReportData, initialPageSize: 5 })
        ),
        e('div', null, 
          e('h2', { className: 'text-xl font-bold mb-2 text-slate-800 dark:text-slate-100' }, 'Exceptions Table'),
          e(DataTable, { columns: exceptionColumns, data: exceptionsData, initialPageSize: 5 })
        )
    );
};


const Dashboard = function({
  allData, slicerOptions, filters, setFilters, actionState, updateAction, updateMultipleActions,
  assignmentState, updateAssignment, clearAllData, onValidateWithBooks,
  validationBooks, activeTab, setActiveTab, onKpiClick, setPrintModalData,
  onNavigateToHome, theme, toggleTheme, savedViews, saveCurrentView, applyView, deleteView,
  reports, updateReports
}) {
    
    const filteredData = useMemo(() => {
        const { company, financialYear, month, tag } = filters;
        if (!allData) return [];
        return allData.filter(r => {
            if (!r || typeof r !== 'object') {
                return false;
            }
            const companyMatch = company.length === 0 || company.includes(r['Company Name']);
            const fyMatch = financialYear.length === 0 || financialYear.includes(r['Financial Year']);
            const monthMatch = month.length === 0 || month.includes(r['Month']);
            const tagMatch = tag.length === 0 || (typeof r['Type'] === 'string' && tag.includes(r['Type']));
            
            return companyMatch && fyMatch && monthMatch && tagMatch;
        });
    }, [allData, filters]);
    
    const handleChartDrillDown = (category, data, alertMessage) => {
      if (data.length > 0) {
          setPrintModalData({ isOpen: true, category, data });
      } else {
          alert(alertMessage);
      }
    };

    const handleSupplierChartClick = (supplierName) => {
      const supplierData = filteredData.filter(row => {
          if (!row || typeof row.Type !== 'string') return false;
          const isMissing = (row.Type.includes('Missing_2B') || row.Type.includes('Missing_in_PR')) && !row.Type.includes('NowUploaded') && !row.Type.includes('NowClaimed');
          return row['Supplier Name'] === supplierName && isMissing;
      });
      handleChartDrillDown(`Missing GST Details for ${supplierName}`, supplierData, `No missing GST transactions found for ${supplierName} within the current filter selection.`);
    };
    
    const handleMonthlyChartClick = (month) => {
      const monthData = filteredData.filter(row => {
          return row && row.Month === month;
      });
      handleChartDrillDown(`All Transactions for ${month}`, monthData, `No transactions found for ${month} within the current filter selection.`);
    };

    const handleCategoryChartClick = (category) => {
      const categoryData = filteredData.filter(row => {
          return row && row.Type === category;
      });
      handleChartDrillDown(`Transactions for Tag: ${category}`, categoryData, `No transactions found for tag "${category}" within the current filter selection.`);
    };


    const kpiData = useMemo(() => {
        const missing2bCum = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return TYPE_PATTERNS.MISSING_2B_CUMULATIVE.test(r.Type) ? sum + r['Total GST'] : sum;
        }, 0);
        const missingPrCum = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return TYPE_PATTERNS.MISSING_PR_CUMULATIVE.test(r.Type) ? sum + r['Total GST'] : sum;
        }, 0);
        const missing2bClaimed = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return TYPE_PATTERNS.MISSING_2B_CLAIMED.test(r.Type) ? sum + r['Total GST'] : sum;
        }, 0);
        const missingPrClaimed = filteredData.reduce((sum, r) => {
            if (!r || typeof r.Type !== 'string') return sum;
            return TYPE_PATTERNS.MISSING_PR_CLAIMED.test(r.Type) ? sum + r['Total GST'] : sum;
        }, 0);
        const totalRecovered = missing2bClaimed + missingPrClaimed;
        const totalMissing = missing2bCum + missingPrCum;
        const successRate = (totalMissing + totalRecovered) > 0 ? (totalRecovered / (totalMissing + totalRecovered)) * 100 : 0;
        return { missing2bCum, missingPrCum, missing2bClaimed, missingPrClaimed, totalRecovered, successRate };
    }, [filteredData]);

    const chartData = useMemo(() => {
        if (!filteredData || filteredData.length === 0) {
            return { monthly: null, byCategory: null, topSuppliers: null };
        }

        const monthly = {};
        filteredData.forEach(r => {
            if (!r || typeof r.Type !== 'string') return;
            const month = r.Month;
            if (!monthly[month]) monthly[month] = { missing: 0, recovered: 0 };
            if (r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) {
                if (r.Type.includes('NowUploaded') || r.Type.includes('NowClaimed')) {
                    monthly[month].recovered += r['Total GST'];
                } else {
                    monthly[month].missing += r['Total GST'];
                }
            }
        });

        const sortedMonths = Object.keys(monthly).sort((a, b) => getMonthNumber(a) - getMonthNumber(b));
        const monthlyChartConfig = {
            type: 'bar',
            data: {
                labels: sortedMonths,
                datasets: [
                    { 
                        label: 'Missing GST', 
                        data: sortedMonths.map(m => monthly[m].missing), 
                        backgroundColor: '#EF4444',
                        borderColor: '#EF4444',
                        borderWidth: 0,
                        borderRadius: 6
                    },
                    { 
                        label: 'Recovered GST', 
                        data: sortedMonths.map(m => monthly[m].recovered), 
                        backgroundColor: '#10B981',
                        borderColor: '#10B981',
                        borderWidth: 0,
                        borderRadius: 6
                    }
                ]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    title: { display: true, text: 'Monthly Missing vs. Recovered GST', font: { size: 14, weight: '600' } },
                    legend: { display: true, position: 'top', labels: { padding: 15, usePointStyle: true, pointStyle: 'circle' } }
                }, 
                scales: { 
                    x: { stacked: true, grid: { display: false } }, 
                    y: { stacked: true, ticks: { callback: (value) => formatCurrency(value, true) }, grid: { color: 'rgba(0,0,0,0.05)' } } 
                },
                onClick: (evt, elements) => {
                    if (!elements.length) return;
                    const index = elements[0].index;
                    const month = sortedMonths[index];
                    handleMonthlyChartClick(month);
                }
            }
        };
        
        const byCategory = {};
        filteredData.forEach(r => {
            if (!r || typeof r.Type !== 'string') return;
            if ((r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) && !r.Type.includes('NowUploaded') && !r.Type.includes('NowClaimed')) {
                const category = r.Type;
                if (!byCategory[category]) byCategory[category] = 0;
                byCategory[category] += r['Total GST'];
            }
        });
        const categoryLabels = Object.keys(byCategory);
        const categoryChartConfig = {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{ 
                    data: Object.values(byCategory), 
                    backgroundColor: [
                        '#3B82F6',  // Blue
                        '#10B981',  // Green
                        '#F59E0B',  // Amber
                        '#EF4444',  // Red
                        '#8B5CF6',  // Purple
                        '#EC4899',  // Pink
                        '#06B6D4'   // Cyan
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 3
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    title: { display: true, text: 'Missing GST by Category', font: { size: 14, weight: '600' } },
                    legend: { display: true, position: 'right', labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' } }
                },
                onClick: (evt, elements) => {
                    if (!elements.length) return;
                    const index = elements[0].index;
                    const tag = categoryLabels[index];
                    handleCategoryChartClick(tag);
                }
            }
        };

        const bySupplier = {};
          filteredData.forEach(r => {
            if (!r || typeof r.Type !== 'string') return;
            if ((r.Type.includes('Missing_2B') || r.Type.includes('Missing_in_PR')) && !r.Type.includes('NowUploaded') && !r.Type.includes('NowClaimed')) {
                const supplier = r['Supplier Name'];
                if (!bySupplier[supplier]) {
                    bySupplier[supplier] = { gst: 0, supplier: supplier };
                }
                bySupplier[supplier].gst += r['Total GST'];
            }
        });
        const topSuppliers = Object.values(bySupplier).sort((a, b) => b.gst - a.gst).slice(0, 10);
        const topSuppliersChartConfig = {
            type: 'bar',
            data: {
                labels: topSuppliers.map(s => s.supplier),
                datasets: [{ 
                    label: 'Missing GST', 
                    data: topSuppliers.map(s => s.gst), 
                    backgroundColor: '#4F46E5',
                    borderColor: '#4F46E5',
                    borderWidth: 0,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Top 10 Suppliers by Missing GST', font: { size: 14, weight: '600' } },
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        ticks: { callback: (value) => formatCurrency(value, true) },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        grid: { display: false }
                    }
                },
                onClick: (evt, elements) => {
                    if (!elements.length) return;
                    const index = elements[0].index;
                    const supplier = topSuppliers[index].supplier;
                    handleSupplierChartClick(supplier);
                }
            }
        };

        return { monthly: monthlyChartConfig, byCategory: categoryChartConfig, topSuppliers: topSuppliersChartConfig };
    }, [filteredData]);
    
    const SavedViewsManager = () => {
        const [isOpen, setIsOpen] = useState(false);
        const wrapperRef = useRef(null);
        useEffect(() => {
            const handleClickOutside = (event) => {
                if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false);
            };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
        }, []);
        
        const handleSave = () => {
            const name = prompt("Enter a name for this view:");
            if (name) saveCurrentView(name);
            setIsOpen(false);
        };

        return e('div', { className: 'relative', ref: wrapperRef },
            e(Button, { onClick: () => setIsOpen(!isOpen), variant: 'secondary', icon: e(Icons.BookmarkIcon, { className: 'h-4 w-4' }) }, 'Views'),
            isOpen && e('div', { className: 'glass-dropdown absolute z-30 mt-2 w-56 rounded-lg right-0' },
                e('div', { className: 'py-1', role: 'menu' },
                    e('button', { onClick: handleSave, className: 'w-full text-left block px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700' }, 'Save current view...'),
                    Object.keys(savedViews).length > 0 && e('div', { className: 'border-t border-slate-200 dark:border-slate-700 my-1' }),
                    Object.keys(savedViews).map(name => 
                        e('div', { key: name, className: 'flex justify-between items-center px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700' },
                            e('button', { onClick: () => { applyView(name); setIsOpen(false); }, className: 'flex-grow text-left' }, name),
                            e('button', { onClick: () => deleteView(name), className: 'text-slate-400 hover:text-danger ml-2' }, e(Icons.XMarkIcon, { className: 'h-4 w-4' }))
                        )
                    )
                )
            )
        );
    };
    
    const getPageTitle = () => {
        const titles = {
            dashboard: 'Dashboard Overview',
            compliance: 'Compliance Monitoring',
            transactions: 'Transaction Analysis',
            reconciliation: 'GST Reconciliation',
            suppliers: 'Supplier Management',
            validation: 'Books Validation',
            mailing: 'Mailing List'
        };
        return titles[activeTab] || 'Dashboard';
    };
    
    const TopBar = () => e('header', { className: 'bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-6 py-4 sticky top-0 z-30' },
        e('div', { className: 'flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4' },
            e('div', null,
                e('h1', { className: 'text-2xl font-bold text-gray-900 dark:text-gray-100' }, getPageTitle()),
                e('div', { className: 'flex items-center gap-2 mt-1 text-sm text-gray-500 dark:text-gray-400' },
                    e('span', null, 'Filters:'),
                    filters.company.length > 0 && e('span', { className: 'badge badge-primary' }, `${filters.company.length} Companies`),
                    filters.financialYear.length > 0 && e('span', { className: 'badge badge-primary' }, `${filters.financialYear.length} FY`),
                    filters.month.length > 0 && e('span', { className: 'badge badge-primary' }, `${filters.month.length} Months`),
                    (filters.company.length === 0 && filters.financialYear.length === 0 && filters.month.length === 0) && e('span', null, 'All Data')
                )
            ),
            e('div', { className: 'flex flex-wrap gap-2 items-center' },
                e(MultiSelect, { label: 'Company', values: filters.company, options: slicerOptions.companies, onChange: (v) => setFilters(f => ({...f, company: v})), className: 'w-40' }),
                e(MultiSelect, { label: 'FY', values: filters.financialYear, options: slicerOptions.financialYears, onChange: (v) => setFilters(f => ({...f, financialYear: v})), className: 'w-28' }),
                e(MultiSelect, { label: 'Month', values: filters.month, options: slicerOptions.months, onChange: (v) => setFilters(f => ({...f, month: v})), className: 'w-32' }),
                e(MultiSelect, { label: 'Tag', values: filters.tag, options: slicerOptions.tags, onChange: (v) => setFilters(f => ({...f, tag: v})), className: 'w-36' }),
                e(SavedViewsManager, null)
            )
        )
    );
    
    const navigationItems = [
        { id: 'dashboard', label: 'Dashboard', icon: Icons.HomeIcon, description: 'Overview & key metrics' },
        { id: 'compliance', label: 'Compliance', icon: Icons.DocumentCheckIcon, description: 'Reports & compliance status' },
        { id: 'transactions', label: 'Transactions', icon: Icons.ReceiptIcon, description: 'Transaction analysis' },
        { id: 'reconciliation', label: 'Reconciliation', icon: Icons.CheckCircleIcon, description: 'Missing GST tracking' },
        { id: 'suppliers', label: 'Suppliers', icon: Icons.BuildingOfficeIcon, description: 'Supplier management' },
        { id: 'validation', label: 'Books Validation', icon: Icons.DocumentTextIcon, description: 'Validate with books' },
        { id: 'mailing', label: 'Mailing List', icon: Icons.EnvelopeIcon, description: 'Email management' }
    ];
    
    const Sidebar = () => e('aside', { className: 'w-64 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 h-screen sticky top-0 flex flex-col' },
        e('div', { className: 'p-6 border-b border-gray-200 dark:border-gray-800' },
            e('div', { className: 'flex items-center gap-3' },
                e('div', { className: 'h-10 w-10 rounded-lg bg-gradient-to-br from-primary-600 to-primary-700 flex items-center justify-center text-white font-bold text-lg shadow-lg' }, 'G'),
                e('div', null,
                    e('h2', { className: 'text-lg font-bold text-gray-900 dark:text-gray-100' }, 'GST Portal'),
                    e('p', { className: 'text-xs text-gray-500 dark:text-gray-400' }, 'Reconciliation System')
                )
            )
        ),
        e('nav', { className: 'flex-1 overflow-y-auto p-4' },
            e('div', { className: 'space-y-1' },
                navigationItems.map(item => {
                    const isActive = activeTab === item.id;
                    return e('button', {
                        key: item.id,
                        onClick: () => setActiveTab(item.id),
                        className: `w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                            isActive 
                                ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400' 
                                : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800'
                        }`
                    },
                        e(item.icon, { className: 'h-5 w-5 flex-shrink-0' }),
                        e('div', { className: 'flex-1 text-left' },
                            e('div', null, item.label),
                            !isActive && e('div', { className: 'text-xs text-gray-500 dark:text-gray-400 mt-0.5' }, item.description)
                        )
                    );
                })
            )
        ),
        e('div', { className: 'p-4 border-t border-gray-200 dark:border-gray-800 space-y-2' },
            e(Button, { onClick: toggleTheme, variant: 'ghost', className: 'w-full justify-start' }, 
                theme === 'light' ? e(Icons.MoonIcon, { className: 'h-5 w-5 mr-2' }) : e(Icons.SunIcon, { className: 'h-5 w-5 mr-2' }),
                theme === 'light' ? 'Dark Mode' : 'Light Mode'
            ),
            e(Button, { onClick: onNavigateToHome, variant: 'secondary', className: 'w-full', icon: e(Icons.HomeIcon, { className: 'h-5 w-5' }) }, 'Home'),
            e(Button, { onClick: clearAllData, variant: 'danger-ghost', className: 'w-full', icon: e(Icons.TrashIcon, { className: 'w-4 h-4' }) }, 'Clear Data')
        )
    );
    
    const DashboardPage = () => e('div', { className: 'space-y-6' },
        e('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-6' },
            e('div', { className: 'lg:col-span-2 space-y-6' },
                e('div', { className: 'pro-card p-6' },
                    e('h2', { className: 'text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4' }, 'Executive Summary'),
                    e('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                        e('div', { className: 'p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border-l-4 border-blue-500' },
                            e('div', { className: 'text-sm font-medium text-blue-600 dark:text-blue-400' }, 'Total Missing GST'),
                            e('div', { className: 'text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1' }, formatCurrency(kpiData.missing2bCum + kpiData.missingPrCum)),
                            e('div', { className: 'text-xs text-gray-600 dark:text-gray-400 mt-1' }, 'Requires immediate attention')
                        ),
                        e('div', { className: 'p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border-l-4 border-green-500' },
                            e('div', { className: 'text-sm font-medium text-green-600 dark:text-green-400' }, 'Recovery Success Rate'),
                            e('div', { className: 'text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1' }, formatPercent(kpiData.successRate)),
                            e('div', { className: 'text-xs text-gray-600 dark:text-gray-400 mt-1' }, `${formatCurrency(kpiData.missing2bClaimed + kpiData.missingPrClaimed)} recovered`)
                        ),
                        e('div', { className: 'p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border-l-4 border-amber-500' },
                            e('div', { className: 'text-sm font-medium text-amber-600 dark:text-amber-400' }, 'Active Transactions'),
                            e('div', { className: 'text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1' }, filteredData.length.toLocaleString()),
                            e('div', { className: 'text-xs text-gray-600 dark:text-gray-400 mt-1' }, 'Total records in system')
                        ),
                        e('div', { className: 'p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg border-l-4 border-purple-500' },
                            e('div', { className: 'text-sm font-medium text-purple-600 dark:text-purple-400' }, 'Unique Suppliers'),
                            e('div', { className: 'text-2xl font-bold text-gray-900 dark:text-gray-100 mt-1' }, [...new Set(filteredData.map(r => r['Supplier Name']))].length.toLocaleString()),
                            e('div', { className: 'text-xs text-gray-600 dark:text-gray-400 mt-1' }, 'Active supplier base')
                        )
                    )
                ),
                e('div', { className: 'pro-card p-6' },
                    e('h3', { className: 'text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4' }, 'Missing GST Trend'),
                    chartData.monthly ? e(ChartComponent, { chartConfig: chartData.monthly }) : e('div', { className: 'text-gray-500' }, 'No data available')
                )
            ),
            e('div', { className: 'space-y-6' },
                e('div', { className: 'pro-card p-6' },
                    e('h3', { className: 'text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4' }, 'Quick Actions'),
                    e('div', { className: 'space-y-3' },
                        e('button', { onClick: () => setActiveTab('reconciliation'), className: 'w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors' },
                            e('div', { className: 'flex items-center gap-3' },
                                e(Icons.DocumentMinusIcon, { className: 'h-5 w-5 text-red-500' }),
                                e('div', null,
                                    e('div', { className: 'font-medium text-gray-900 dark:text-gray-100' }, 'View Missing GST'),
                                    e('div', { className: 'text-xs text-gray-500' }, 'Analyze reconciliation gaps')
                                )
                            )
                        ),
                        e('button', { onClick: () => setActiveTab('compliance'), className: 'w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors' },
                            e('div', { className: 'flex items-center gap-3' },
                                e(Icons.DocumentCheckIcon, { className: 'h-5 w-5 text-green-500' }),
                                e('div', null,
                                    e('div', { className: 'font-medium text-gray-900 dark:text-gray-100' }, 'Compliance Reports'),
                                    e('div', { className: 'text-xs text-gray-500' }, 'View filing status')
                                )
                            )
                        ),
                        e('button', { onClick: () => setActiveTab('validation'), className: 'w-full text-left p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors' },
                            e('div', { className: 'flex items-center gap-3' },
                                e(Icons.DocumentTextIcon, { className: 'h-5 w-5 text-blue-500' }),
                                e('div', null,
                                    e('div', { className: 'font-medium text-gray-900 dark:text-gray-100' }, 'Validate Books'),
                                    e('div', { className: 'text-xs text-gray-500' }, 'Match with accounting records')
                                )
                            )
                        )
                    )
                ),
                e('div', { className: 'pro-card p-6' },
                    e('h3', { className: 'text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4' }, 'Category Breakdown'),
                    e('div', { className: 'h-80' },
                        chartData.byCategory ? e(ChartComponent, { chartConfig: chartData.byCategory }) : e('div', { className: 'flex items-center justify-center h-full text-gray-500' }, 'No data available')
                    )
                )
            )
        )
    );
    
    const ReconciliationPage = () => e('div', { className: 'space-y-6' },
      e('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6' },
        e(KpiCard, { title: "Missing 2B Cum", value: formatCurrency(kpiData.missing2bCum), icon: e(Icons.DocumentMinusIcon, { className: 'h-6 w-6 text-red-500' }), color: 'red', onClick: () => onKpiClick('Missing 2B') }),
        e(KpiCard, { title: "Missing PR Cum", value: formatCurrency(kpiData.missingPrCum), icon: e(Icons.DocumentMinusIcon, { className: 'h-6 w-6 text-yellow-500' }), color: 'yellow', onClick: () => onKpiClick('Missing in PR') }),
        e(KpiCard, { title: "Total Missing", value: formatCurrency(kpiData.missing2bCum + kpiData.missingPrCum), subValue: "2B + PR", icon: e(Icons.ReceiptIcon, { className: 'h-6 w-6 text-blue-500' }), color: 'blue' }),
        e(KpiCard, { title: "2B Claimed", value: formatCurrency(kpiData.missing2bClaimed), icon: e(Icons.CheckCircleIcon, { className: 'h-6 w-6 text-green-500' }), color: 'green', onClick: () => onKpiClick('2B NowUploaded') }),
        e(KpiCard, { title: "PR Claimed", value: formatCurrency(kpiData.missingPrClaimed), icon: e(Icons.CheckCircleIcon, { className: 'h-6 w-6 text-green-500' }), color: 'green', onClick: () => onKpiClick('PR NowClaimed') }),
        e(KpiCard, { title: "Success Rate", value: formatPercent(kpiData.successRate), subValue: "Total Recovered", icon: e(Icons.TrendingUpIcon, { className: 'h-6 w-6 text-green-500' }), color: 'green' })
      ),
      e('div', { className: 'grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6' },
        e('div', { className: 'xl:col-span-2 pro-card p-6' },
            chartData.monthly ? e(ChartComponent, { chartConfig: chartData.monthly }) : e('div', null, 'No data for monthly chart.')
        ),
        e('div', { className: 'pro-card p-6 min-h-[300px]' },
            chartData.byCategory ? e(ChartComponent, { chartConfig: chartData.byCategory }) : e('div', null, 'No data for category chart.')
        )
      ),
      e('div', { className: 'pro-card p-6' },
          chartData.topSuppliers ? e(ChartComponent, { chartConfig: chartData.topSuppliers }) : e('div', null, 'No data for top suppliers chart.')
      )
    );

    const renderActiveTab = () => {
        switch(activeTab) {
            case 'dashboard': return e(DashboardPage, null);
            case 'compliance': return e(ReportsTab, { initialData: reports, onDataChange: updateReports });
            case 'transactions': return e(TransactionsPage, { data: filteredData, actionState: actionState, updateAction: updateAction, updateMultipleActions: updateMultipleActions });
            case 'reconciliation': return e(ReconciliationPage, null);
            case 'suppliers': return e(SuppliersPage, { data: filteredData, assignmentState: assignmentState, updateAssignment: updateAssignment });
            case 'validation': return e(ValidationPage, { allData, validationBooks, onValidateWithBooks });
            case 'mailing': return e(MailingListPage, { data: filteredData, actionState: actionState, assignmentState: assignmentState, setPrintModalData: setPrintModalData });
            default: return e(DashboardPage, null);
        }
    };

    return e('div', { className: 'min-h-screen flex bg-gray-50 dark:bg-gray-900' },
        e(Sidebar, null),
        e('div', { className: 'flex-1 flex flex-col overflow-hidden' },
            e(TopBar, null),
            e('main', { className: 'flex-1 overflow-y-auto p-6' },
                e(ErrorBoundary, { message: 'Failed to load content for this page.' }, renderActiveTab())
            )
        )
    );
};

const App = function() {
  const [appState, setAppState] = useState({
    isAuthenticated: false,
    currentPage: 'login', // login, home, gst
    isLoading: false,
    statusMessage: '',
    progress: 0,
    allData: [],
    actionState: {},
    assignmentState: {},
    validationBooks: [],
    reports: [],
    activeTab: 'dashboard',
    filters: {
      company: [],
      financialYear: [],
      month: [],
      tag: [],
    },
    printModalData: { isOpen: false, category: '', data: [] },
    thinkingModalOpen: false,
    theme: localStorage.getItem('theme') || 'light',
    savedViews: JSON.parse(localStorage.getItem('gst_saved_views') || '{}')
  });

  const updateState = (updates) => {
    setAppState(prev => ({...prev, ...updates}));
  };
  
  useEffect(() => {
      if (appState.theme === 'dark') {
          document.documentElement.classList.add('dark');
      } else {
          document.documentElement.classList.remove('dark');
      }
      localStorage.setItem('theme', appState.theme);
  }, [appState.theme]);

  const toggleTheme = () => updateState({ theme: appState.theme === 'light' ? 'dark' : 'light' });

  const saveCurrentView = (name) => {
      const newSavedViews = { ...appState.savedViews, [name]: appState.filters };
      updateState({ savedViews: newSavedViews });
      localStorage.setItem('gst_saved_views', JSON.stringify(newSavedViews));
  };
  const applyView = (name) => {
      if (appState.savedViews[name]) {
          updateState({ filters: appState.savedViews[name] });
      }
  };
  const deleteView = (name) => {
      const newSavedViews = { ...appState.savedViews };
      delete newSavedViews[name];
      updateState({ savedViews: newSavedViews });
      localStorage.setItem('gst_saved_views', JSON.stringify(newSavedViews));
  };
  
  const setFilters = (newFilters) => {
      updateState({ filters: {...appState.filters, ...newFilters} });
  };
  
  const setPrintModalData = (data) => updateState({ printModalData: data });

  const handleLoginSuccess = () => {
    updateState({ isAuthenticated: true, currentPage: 'home' });
  };

  const handleNavigate = (page) => {
    updateState({ currentPage: page });
  };

  const onProgress = (progress, message) => {
    updateState({ progress: progress * 100, statusMessage: message });
  };

  const handleFileSelect = async (file) => {
    updateState({ isLoading: true, statusMessage: 'Starting file processing...', progress: 0 });
    try {
      const data = await fileProcessor.processMainFile(file, onProgress);
      updateState({ allData: data, actionState: {}, assignmentState: {}, reports: [], isLoading: false, statusMessage: `Successfully loaded ${data.length} records.`, currentPage: 'gst' });
    } catch (error) {
      console.error(error);
      updateState({ isLoading: false, statusMessage: `Error: ${error.message}` });
    }
  };

  const handleLoadSaved = async () => {
    updateState({ isLoading: true, statusMessage: 'Loading saved data...', progress: 50 });
    try {
        const { transactions, actions, assignments, reports } = await dbService.loadData();
        if ((!transactions || transactions.length === 0) && (!reports || reports.length === 0)) {
            updateState({ isLoading: false, statusMessage: 'No saved data found.' });
        } else {
            const books = await dbService.loadAllValidationBooks();
            updateState({
                allData: transactions || [], actionState: actions || {}, assignmentState: assignments || {},
                reports: reports || [], validationBooks: books || [], isLoading: false,
                statusMessage: 'Saved data loaded successfully.', currentPage: 'gst'
            });
        }
    } catch (error) {
        console.error(error);
        updateState({ isLoading: false, statusMessage: `Error loading data: ${error.message}` });
    }
  };
  
  const handleClearSaved = async () => {
    if (confirm('Are you sure you want to delete ALL saved data? This cannot be undone.')) {
        updateState({ isLoading: true, statusMessage: 'Clearing all data...', progress: 50 });
        await dbService.clearAllData();
        updateState({ allData: [], actionState: {}, assignmentState: {}, reports: [], validationBooks: [], isLoading: false, statusMessage: 'All saved data has been cleared.' });
    }
  };
  
  const handleLoadMockData = () => {
        updateState({ isLoading: true, statusMessage: 'Loading mock data...', progress: 50 });
      const mockData = [
          {id: 'row_0', 'Company Name': 'MANJUSHREE SPNTEK PVT LTD', 'Supplier Name': 'Supplier A', 'Document Number (2B)': 'DOC001', 'Document Date (2B)': '15-04-2023', 'Financial Year': '2023-24', 'Month': 'Apr', Type: 'Missing_in_PR_Cumulative', 'Sum of Taxable Value (2B)': 10000, 'Total GST': 1800, Remarks: ''},
          {id: 'row_1', 'Company Name': 'MANJUSHREE TECHNOPACK LTD', 'Supplier Name': 'Supplier B', 'Document Number (2B)': 'DOC002', 'Document Date (2B)': '20-04-2023', 'Financial Year': '2023-24', 'Month': 'Apr', Type: 'Missing_2B_Cumulative', 'Sum of Taxable Value (2B)': 5000, 'Total GST': 900, Remarks: ''},
          {id: 'row_2', 'Company Name': 'MANJUSHREE SPNTEK PVT LTD', 'Supplier Name': 'Supplier A', 'Document Number (2B)': 'DOC003', 'Document Date (2B)': '10-05-2023', 'Financial Year': '2023-24', 'Month': 'May', Type: 'Missing_in_PR_NowClaimed', 'Sum of Taxable Value (2B)': 10000, 'Total GST': 1800, Remarks: 'Claimed this month'},
      ];
        const mockReports = [
        {id: 'rep_1', companyName: 'MANJUSHREE SPNTEK PVT LTD', month: 'Sep', financialYear: '2025-26', openingBalance: 148637000, itcAvailed: 29680000, taxLiability: 9509000, gstr1FiledOn: '2025-10-10', gstr3bFiledOn: '2025-10-19', remarks: 'Refund Received in Sep 2025', portalITC_Apr: 148637000, portalITC_Aug: 103515000, portalITC_Sep: 123686000, booksITC_Sep: 132000000}
      ];
      updateState({ allData: mockData, reports: mockReports, isLoading: false, statusMessage: 'Mock data loaded.', currentPage: 'gst', activeTab: 'Reports'});
  }

  const debounce = (func, delay) => {
      let timeout;
      return function(...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
      };
  }

  const handleSave = useCallback(debounce((appStateToSave) => {
    const { allData, actionState, assignmentState, reports } = appStateToSave;
    dbService.saveData(allData, actionState, assignmentState, reports);
  }, 1000), []);
  
  useEffect(() => {
    if(appState.currentPage === 'gst') {
      handleSave(appState);
    }
  }, [appState.allData, appState.actionState, appState.assignmentState, appState.reports, handleSave]);

  
  const updateAction = (rowId, newAction) => {
      updateState({ actionState: {...appState.actionState, [rowId]: newAction }});
  };
  const updateMultipleActions = (rowIds, action) => {
      const newActionState = { ...appState.actionState };
      rowIds.forEach(id => {
          const currentAction = newActionState[id] || {};
          newActionState[id] = typeof currentAction === 'object' ? { ...currentAction, action } : { action };
      });
      updateState({ actionState: newActionState });
  };
  const updateAssignment = (key, category) => {
      updateState({ assignmentState: {...appState.assignmentState, [key]: category }});
  };
  const updateReports = (newReports) => {
      updateState({ reports: newReports });
  };
  window.test_updateReports = updateReports;
  
  const handleValidateWithBooks = async (file) => {
      try {
          const book = await fileProcessor.processBooksFile(file);
          await dbService.saveValidationBook(book);
          const newBooks = await dbService.loadAllValidationBooks();
          updateState({ validationBooks: newBooks });

          // Find matches and update actions
          const bookRowsLookup = new Map();
          const getCol = (r, candidates) => {
            for(const c of candidates) {
                const key = Object.keys(r).find(k => k.trim().toLowerCase() === c.toLowerCase());
                if(key) return r[key];
            }
            return null;
          };
          
          // Build two separate lookups to prevent double-counting
          const bookRowsLookupExact = new Map();  // With GSTIN
          const bookRowsLookupFuzzy = new Map();  // Without GSTIN
          
          book.data.forEach(row => {
              const docNum = getCol(row, ['Voucher Ref. No.', 'Document Number', 'Doc No', 'Invoice No']);
              const gstin = getCol(row, ['GSTIN/UIN', 'GSTIN', 'Supplier GSTIN']);
              
              // Normalize values - trim whitespace and convert to string
              const normalizedDocNum = String(docNum || '').trim();
              const normalizedGstin = String(gstin || '').trim();
              
              if (normalizedDocNum) {
                  // Store with GSTIN for exact matching
                  if (normalizedGstin) {
                      const keyExact = `${book.companyName}|${normalizedDocNum}|${normalizedGstin}`;
                      bookRowsLookupExact.set(keyExact, row);
                  }
                  
                  // Store without GSTIN only if not already in exact lookup
                  const keyFuzzy = `${book.companyName}|${normalizedDocNum}`;
                  if (!bookRowsLookupFuzzy.has(keyFuzzy)) {
                      bookRowsLookupFuzzy.set(keyFuzzy, row);
                  }
              }
          });
          
          const newActionState = {...appState.actionState};
          let matchCount = 0;
          let totalCandidates = 0;
          const matchedBookKeys = new Set(); // Track which book entries we've matched
          
          appState.allData.forEach(row => {
              if (row && typeof row.Type === 'string' && TYPE_PATTERNS.MISSING_PR_ANY.test(row.Type)) {
                  totalCandidates++;
                  
                  // Normalize main data values
                  const normalizedDocNum = String(row['Document Number (2B)'] || '').trim();
                  const normalizedGstin = String(row['Supplier GSTIN (2B)'] || '').trim();
                  
                  let matched = false;
                  let usedKey = null;
                  
                  // Try exact match first (with GSTIN)
                  if (normalizedGstin && normalizedDocNum) {
                      const keyExact = `${row['Company Name']}|${normalizedDocNum}|${normalizedGstin}`;
                      if (bookRowsLookupExact.has(keyExact) && !matchedBookKeys.has(keyExact)) {
                          matched = true;
                          usedKey = keyExact;
                      }
                  }
                  
                  // If no exact match, try fuzzy match (without GSTIN)
                  if (!matched && normalizedDocNum) {
                      const keyFuzzy = `${row['Company Name']}|${normalizedDocNum}`;
                      if (bookRowsLookupFuzzy.has(keyFuzzy) && !matchedBookKeys.has(keyFuzzy)) {
                          matched = true;
                          usedKey = keyFuzzy;
                      }
                  }
                  
                  if (matched && usedKey) {
                      matchCount++;
                      matchedBookKeys.add(usedKey); // Mark this book entry as matched
                      const current = newActionState[row.id] || {};
                      newActionState[row.id] = typeof current === 'object' ? { ...current, action: 'Accounted' } : { action: 'Accounted' };
                  }
              }
          });
          
          updateState({ actionState: newActionState });
          
          const message = `Validation Complete:\n` +
                         `- Total Missing_in_PR transactions: ${totalCandidates}\n` +
                         `- Matches found: ${matchCount}\n` +
                         `- Unmatched: ${totalCandidates - matchCount}\n\n` +
                         `Matched transactions have been marked as 'Accounted'.`;
          alert(message);

      } catch (error) {
          alert(`Error processing Books file: ${error.message}`);
      }
  };

  const slicerOptions = useMemo(() => {
    const companies = [...new Set(appState.allData.map(r => r['Company Name']))].filter(Boolean);
    const financialYears = [...new Set(appState.allData.map(r => r['Financial Year']))].filter(Boolean);
    const months = [...new Set(appState.allData.map(r => r['Month']))].filter(Boolean);
    const tags = [...new Set(appState.allData.map(r => r['Type']))].filter(Boolean);
    return { companies, financialYears, months, tags };
  }, [appState.allData]);

  const handleKpiClick = (kpiType) => {
    let tagFilter = [];
    if (kpiType === 'Missing 2B') {
      tagFilter = ['Missing_2B_Cumulative', 'Missing_2B_Current_Month'];
    } else if (kpiType === 'Missing in PR') {
      tagFilter = slicerOptions.tags.filter(t => t.startsWith('Missing_in_PR_') && !t.includes('NowClaimed'));
    } else if (kpiType === '2B NowUploaded') {
      tagFilter = ['Missing_2B_NowUploaded'];
    } else if (kpiType === 'PR NowClaimed') {
        tagFilter = slicerOptions.tags.filter(t => t.startsWith('Missing_in_PR_NowClaimed') || t.startsWith('Missing_PR_NowClaimed'));
    }
    setFilters({ ...appState.filters, tag: tagFilter });
    updateState({ activeTab: 'transactions' });
  };
  
  if (!appState.isAuthenticated) {
      return e(LoginPage, { onLoginSuccess: handleLoginSuccess });
  }
  
  if (appState.currentPage === 'home') {
      return e(MainLandingPage, { onNavigateToGst: () => handleNavigate('gstStartup') });
  }
  
  if (appState.currentPage === 'gstStartup') {
      return e(StartupScreen, {
          onFileSelect: handleFileSelect,
          onLoadSaved: handleLoadSaved,
          onClearSaved: handleClearSaved,
          onLoadMockData: handleLoadMockData,
          statusMessage: appState.statusMessage,
          isLoading: appState.isLoading,
          progress: appState.progress,
          onNavigateToHome: () => handleNavigate('home')
      });
  }
  
  if (appState.currentPage === 'gst') {
    return e(Fragment, null,
      e(Dashboard, {
        allData: appState.allData,
        slicerOptions,
        filters: appState.filters,
        setFilters: (newFilters) => updateState({ filters: { ...appState.filters, ...newFilters } }),
        actionState: appState.actionState,
        updateAction,
        updateMultipleActions,
        assignmentState: appState.assignmentState,
        updateAssignment,
        clearAllData: handleClearSaved,
        onValidateWithBooks: handleValidateWithBooks,
        validationBooks: appState.validationBooks,
        activeTab: appState.activeTab,
        setActiveTab: (tab) => updateState({activeTab: tab}),
        onKpiClick: handleKpiClick,
        setPrintModalData,
        onNavigateToHome: () => handleNavigate('home'),
        theme: appState.theme,
        toggleTheme,
        savedViews: appState.savedViews,
        saveCurrentView,
        applyView,
        deleteView,
        reports: appState.reports,
        updateReports
      }),
      e(PrintModal, { printModalData: appState.printModalData, setPrintModalData, actionState: appState.actionState }),
      e(ThinkingModeModal, { 
          isOpen: appState.thinkingModalOpen, 
          onClose: () => updateState({ thinkingModalOpen: false }),
          contextData: appState.allData.filter(r => {
            // This is a simplified filter logic for context. A more complex one could be used.
            const companyMatch = appState.filters.company.length === 0 || appState.filters.company.includes(r['Company Name']);
            return companyMatch;
          })
      }),
      geminiService.isAvailable() && e(Chatbot, { slicerOptions, onFilterChange: (newFilters) => updateState({ filters: { ...appState.filters, ...newFilters } }), setPrintModalData, allData: appState.allData })
    );
  }

  return e('div', null, 'Something went wrong with application routing.');
};
ReactDOM.createRoot(document.getElementById('root')).render(e(StrictMode, null, e(App)));
    </script>
  </body>
</html>
